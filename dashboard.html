<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Nexus ‚Äî Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet"/>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --bg: #0b0c10; --surface: #13151c; --surface2: #1c1f2b; --surface3: #242838;
      --accent: #5b6af0; --text: #eaedf8; --muted: #7c80a0;
      --border: rgba(255,255,255,0.07); --glow: rgba(91,106,240,0.3);
      --error: #ff5f57; --success: #23d18b; --online: #23d18b;
      --idle: #ffa726; --dnd: #ff5f57; --admin: #f59e0b;
    }
    html, body { height: 100%; overflow: hidden; }
    body { background: var(--bg); color: var(--text); font-family: 'DM Sans', sans-serif; display: flex; }

    /* ‚îÄ‚îÄ SERVERS BAR ‚îÄ‚îÄ */
    .servers-bar { width: 72px; background: #080a0f; display: flex; flex-direction: column; align-items: center; padding: 12px 0; gap: 8px; border-right: 1px solid var(--border); flex-shrink: 0; overflow-y: auto; }
    .server-icon { width: 48px; height: 48px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 1.2rem; font-weight: 700; transition: border-radius 0.2s, background 0.2s; position: relative; flex-shrink: 0; }
    .server-icon:hover, .server-icon.active { border-radius: 16px; }
    .server-icon.home { background: var(--accent); color: #fff; font-size: 1.3rem; }
    .server-icon.home:hover, .server-icon.home.active { background: #4a59e0; }
    .server-icon.add { background: var(--surface2); color: var(--success); font-size: 1.5rem; border-radius: 50%; }
    .server-icon.add:hover { background: var(--success); color: #fff; border-radius: 16px; }
    .server-icon.admin-icon { background: var(--admin); color: #fff; font-size: 1.1rem; }
    .server-icon.admin-icon:hover, .server-icon.admin-icon.active { background: #d97706; }
    .server-divider { width: 32px; height: 2px; background: var(--border); border-radius: 1px; margin: 4px 0; }
    .server-pip { position: absolute; left: -4px; top: 50%; transform: translateY(-50%); width: 4px; border-radius: 0 2px 2px 0; background: var(--text); transition: height 0.2s; height: 0; }
    .server-icon:hover .server-pip { height: 20px; }
    .server-icon.active .server-pip { height: 36px; }

    /* ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ */
    .sidebar { width: 240px; background: var(--surface); display: flex; flex-direction: column; border-right: 1px solid var(--border); flex-shrink: 0; }
    .sidebar-header { padding: 16px; border-bottom: 1px solid var(--border); font-family: 'Syne', sans-serif; font-weight: 700; font-size: 0.95rem; }
    .sidebar-search { padding: 8px 12px; }
    .sidebar-search input { width: 100%; background: var(--surface2); border: 1px solid var(--border); border-radius: 6px; padding: 7px 10px; color: var(--text); font-family: 'DM Sans', sans-serif; font-size: 0.82rem; outline: none; }
    .sidebar-search input::placeholder { color: var(--muted); }
    .sidebar-section-label { padding: 12px 12px 4px; font-size: 0.7rem; font-weight: 700; letter-spacing: 0.08em; color: var(--muted); text-transform: uppercase; display: flex; align-items: center; justify-content: space-between; }
    .sidebar-section-label span { cursor: pointer; font-size: 1rem; opacity: 0.6; transition: opacity 0.2s; }
    .sidebar-section-label span:hover { opacity: 1; }
    .sidebar-item { display: flex; align-items: center; gap: 10px; padding: 7px 12px; border-radius: 6px; margin: 1px 8px; cursor: pointer; transition: background 0.15s; font-size: 0.88rem; color: var(--muted); }
    .sidebar-item:hover { background: var(--surface2); color: var(--text); }
    .sidebar-item.active { background: var(--surface3); color: var(--text); }
    .item-avatar { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.78rem; font-weight: 700; flex-shrink: 0; position: relative; overflow: hidden; }
    .item-avatar img { width: 100%; height: 100%; object-fit: cover; }
    .status-dot { position: absolute; bottom: -1px; right: -1px; width: 10px; height: 10px; border-radius: 50%; border: 2px solid var(--surface); }
    .status-dot.online { background: var(--online); }
    .status-dot.idle { background: var(--idle); }
    .status-dot.dnd { background: var(--dnd); }
    .status-dot.offline { background: var(--muted); }

    /* ‚îÄ‚îÄ USER PANEL ‚îÄ‚îÄ */
    .user-panel { margin-top: auto; padding: 10px 8px; border-top: 1px solid var(--border); display: flex; align-items: center; gap: 8px; cursor: pointer; border-radius: 8px; transition: background 0.15s; }
    .user-panel:hover { background: var(--surface2); }
    .user-panel-avatar { width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.9rem; color: #fff; flex-shrink: 0; overflow: hidden; }
    .user-panel-avatar img { width: 100%; height: 100%; object-fit: cover; }
    .user-panel-info { flex: 1; min-width: 0; }
    .user-panel-name { font-size: 0.85rem; font-weight: 600; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .user-panel-tag { font-size: 0.72rem; color: var(--muted); }
    .user-panel-actions { display: flex; gap: 4px; }
    .icon-btn { width: 28px; height: 28px; border-radius: 6px; background: none; border: none; color: var(--muted); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1rem; transition: background 0.15s, color 0.15s; }
    .icon-btn:hover { background: var(--surface3); color: var(--text); }

    /* ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ */
    .main { flex: 1; display: flex; flex-direction: column; overflow: hidden; min-width: 0; }
    .main-header { padding: 0 20px; height: 52px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 12px; flex-shrink: 0; }
    .main-header h2 { font-family: 'Syne', sans-serif; font-weight: 700; font-size: 1rem; }
    .header-tabs { display: flex; gap: 4px; margin-left: 20px; }
    .tab { padding: 5px 14px; border-radius: 6px; font-size: 0.85rem; font-weight: 500; cursor: pointer; color: var(--muted); transition: background 0.15s, color 0.15s; border: none; background: none; font-family: 'DM Sans', sans-serif; }
    .tab:hover { background: var(--surface2); color: var(--text); }
    .tab.active { background: var(--surface2); color: var(--text); }
    .add-friend-btn { margin-left: auto; padding: 6px 16px; background: var(--success); color: #fff; border: none; border-radius: 6px; font-family: 'DM Sans', sans-serif; font-size: 0.82rem; font-weight: 600; cursor: pointer; transition: background 0.2s; }
    .add-friend-btn:hover { background: #1db97a; }
    .main-content { flex: 1; overflow-y: auto; padding: 24px; }

    /* ‚îÄ‚îÄ FRIENDS ‚îÄ‚îÄ */
    .friends-list { display: flex; flex-direction: column; gap: 2px; }
    .friend-row { display: flex; align-items: center; gap: 14px; padding: 12px 16px; border-radius: 10px; transition: background 0.15s; border-bottom: 1px solid var(--border); }
    .friend-row:hover { background: var(--surface2); }
    .friend-avatar { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.95rem; color: #fff; flex-shrink: 0; position: relative; overflow: hidden; cursor: pointer; }
    .friend-avatar img { width: 100%; height: 100%; object-fit: cover; }
    .friend-info { flex: 1; cursor: pointer; }
    .friend-name { font-weight: 600; font-size: 0.92rem; }
    .friend-status { font-size: 0.78rem; color: var(--muted); margin-top: 1px; }
    .friend-actions { display: flex; gap: 8px; }
    .friend-btn { width: 36px; height: 36px; border-radius: 50%; background: var(--surface2); border: none; color: var(--muted); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1rem; transition: background 0.15s, color 0.15s; }
    .friend-btn:hover { background: var(--surface3); color: var(--text); }

    /* ‚îÄ‚îÄ CHAT ‚îÄ‚îÄ */
    .chat-view { display: flex; flex-direction: column; height: 100%; }
    .chat-messages { flex: 1; overflow-y: auto; padding: 20px 24px; display: flex; flex-direction: column; gap: 4px; }
    .chat-msg { display: flex; gap: 14px; padding: 4px 8px; border-radius: 8px; transition: background 0.1s; }
    .chat-msg:hover { background: rgba(255,255,255,0.02); }
    .chat-msg-avatar { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.9rem; color: #fff; flex-shrink: 0; overflow: hidden; cursor: pointer; }
    .chat-msg-avatar img { width: 100%; height: 100%; object-fit: cover; }
    .chat-msg-body { flex: 1; min-width: 0; }
    .chat-msg-header { display: flex; align-items: baseline; gap: 10px; margin-bottom: 4px; }
    .chat-msg-name { font-weight: 600; font-size: 0.9rem; cursor: pointer; }
    .chat-msg-name:hover { text-decoration: underline; }
    .chat-msg-time { font-size: 0.72rem; color: var(--muted); }
    .chat-msg-text { font-size: 0.9rem; color: #c8cce0; line-height: 1.55; word-break: break-word; }
    .msg-image { max-width: 320px; max-height: 240px; border-radius: 10px; margin-top: 6px; cursor: zoom-in; display: block; object-fit: cover; }
    .msg-video { max-width: 360px; border-radius: 10px; margin-top: 6px; display: block; }
    .msg-audio { margin-top: 6px; width: 280px; }
    .msg-file { display: inline-flex; align-items: center; gap: 10px; background: var(--surface2); border: 1px solid var(--border); border-radius: 10px; padding: 10px 14px; margin-top: 6px; text-decoration: none; color: var(--text); transition: background 0.15s; max-width: 300px; }
    .msg-file:hover { background: var(--surface3); }
    .msg-file-icon { font-size: 1.4rem; flex-shrink: 0; }
    .msg-file-name { font-size: 0.85rem; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 180px; }
    .msg-file-size { font-size: 0.72rem; color: var(--muted); }
    .upload-progress { display: flex; align-items: center; gap: 10px; padding: 8px 12px; background: var(--surface2); border-radius: 8px; font-size: 0.82rem; color: var(--muted); margin: 4px 8px; }
    .progress-bar { flex: 1; height: 4px; background: var(--surface3); border-radius: 2px; overflow: hidden; }
    .progress-fill { height: 100%; background: var(--accent); border-radius: 2px; transition: width 0.3s; width: 0%; }
    .chat-input-area { padding: 0 16px 16px; flex-shrink: 0; }
    .chat-input-box { display: flex; align-items: center; gap: 8px; background: var(--surface2); border: 1px solid var(--border); border-radius: 12px; padding: 0 12px; transition: border-color 0.2s; }
    .chat-input-box:focus-within { border-color: rgba(91,106,240,0.4); }
    .chat-attach-btn { background: none; border: none; color: var(--muted); cursor: pointer; font-size: 1.2rem; padding: 4px; transition: color 0.2s; flex-shrink: 0; }
    .chat-attach-btn:hover { color: var(--text); }
    .chat-input-box input { flex: 1; background: none; border: none; padding: 14px 0; color: var(--text); font-family: 'DM Sans', sans-serif; font-size: 0.92rem; outline: none; }
    .chat-input-box input::placeholder { color: var(--muted); }
    .chat-send-btn { background: none; border: none; color: var(--muted); cursor: pointer; font-size: 1.1rem; transition: color 0.2s; }
    .chat-send-btn:hover { color: var(--accent); }
    .deactivated-bar { padding: 12px 20px; background: rgba(255,95,87,0.08); border-top: 1px solid rgba(255,95,87,0.15); text-align: center; font-size: 0.85rem; color: var(--error); flex-shrink: 0; }

    /* ‚îÄ‚îÄ ADMIN PANEL ‚îÄ‚îÄ */
    .admin-panel { padding: 0; }
    .admin-toolbar { display: flex; align-items: center; gap: 12px; padding: 20px 24px 16px; border-bottom: 1px solid var(--border); flex-shrink: 0; flex-wrap: wrap; }
    .admin-search { flex: 1; min-width: 200px; background: var(--surface2); border: 1px solid var(--border); border-radius: 8px; padding: 9px 14px; color: var(--text); font-family: 'DM Sans', sans-serif; font-size: 0.88rem; outline: none; transition: border-color 0.2s; }
    .admin-search:focus { border-color: var(--admin); }
    .admin-search::placeholder { color: var(--muted); }
    .admin-filter { padding: 9px 14px; background: var(--surface2); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-family: 'DM Sans', sans-serif; font-size: 0.85rem; outline: none; cursor: pointer; }
    .admin-stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; padding: 16px 24px; border-bottom: 1px solid var(--border); }
    .admin-stat { background: var(--surface2); border: 1px solid var(--border); border-radius: 10px; padding: 14px 16px; }
    .admin-stat-num { font-family: 'Syne', sans-serif; font-weight: 800; font-size: 1.5rem; margin-bottom: 2px; }
    .admin-stat-label { font-size: 0.75rem; color: var(--muted); }
    .admin-table { flex: 1; overflow-y: auto; }
    .admin-table-header { display: grid; grid-template-columns: 2fr 1.5fr 1fr 1fr 1.2fr; padding: 10px 24px; font-size: 0.72rem; font-weight: 700; letter-spacing: 0.06em; text-transform: uppercase; color: var(--muted); border-bottom: 1px solid var(--border); }
    .admin-user-row { display: grid; grid-template-columns: 2fr 1.5fr 1fr 1fr 1.2fr; align-items: center; padding: 12px 24px; border-bottom: 1px solid var(--border); transition: background 0.15s; gap: 8px; }
    .admin-user-row:hover { background: var(--surface2); }
    .admin-user-info { display: flex; align-items: center; gap: 10px; min-width: 0; }
    .admin-avatar { width: 34px; height: 34px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.8rem; color: #fff; flex-shrink: 0; overflow: hidden; }
    .admin-avatar img { width: 100%; height: 100%; object-fit: cover; }
    .admin-user-name { font-weight: 600; font-size: 0.88rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .admin-user-tag { font-size: 0.75rem; color: var(--muted); }
    .admin-badge { display: inline-flex; align-items: center; gap: 4px; padding: 3px 8px; border-radius: 20px; font-size: 0.72rem; font-weight: 600; }
    .badge-active { background: rgba(35,209,139,0.12); color: var(--success); }
    .badge-banned { background: rgba(255,95,87,0.12); color: var(--error); }
    .badge-warned { background: rgba(255,167,38,0.12); color: var(--idle); }
    .badge-deleted { background: rgba(124,128,160,0.12); color: var(--muted); }
    .badge-temp { background: rgba(245,158,11,0.12); color: var(--admin); }
    .admin-actions { display: flex; gap: 6px; flex-wrap: wrap; }
    .admin-btn { padding: 5px 10px; border-radius: 6px; font-family: 'DM Sans', sans-serif; font-size: 0.75rem; font-weight: 600; cursor: pointer; border: none; transition: all 0.15s; }
    .admin-btn-warn { background: rgba(255,167,38,0.15); color: var(--idle); }
    .admin-btn-warn:hover { background: rgba(255,167,38,0.3); }
    .admin-btn-temp { background: rgba(245,158,11,0.15); color: var(--admin); }
    .admin-btn-temp:hover { background: rgba(245,158,11,0.3); }
    .admin-btn-ban { background: rgba(255,95,87,0.15); color: var(--error); }
    .admin-btn-ban:hover { background: rgba(255,95,87,0.3); }
    .admin-btn-unban { background: rgba(35,209,139,0.15); color: var(--success); }
    .admin-btn-unban:hover { background: rgba(35,209,139,0.3); }
    .admin-btn-delete { background: rgba(124,128,160,0.1); color: var(--muted); }
    .admin-btn-delete:hover { background: rgba(255,95,87,0.15); color: var(--error); }
    .admin-empty { padding: 48px; text-align: center; color: var(--muted); font-size: 0.9rem; }

    /* ‚îÄ‚îÄ RIGHT PROFILE PANEL ‚îÄ‚îÄ */
    .profile-panel { width: 260px; background: var(--surface); border-left: 1px solid var(--border); flex-shrink: 0; display: flex; flex-direction: column; overflow-y: auto; transition: width 0.25s; }
    .profile-panel.hidden { width: 0; overflow: hidden; border: none; }
    .pp-banner { height: 80px; flex-shrink: 0; position: relative; }
    .pp-close-btn { position: absolute; top: 8px; right: 8px; background: rgba(0,0,0,0.3); border: none; color: #fff; width: 24px; height: 24px; border-radius: 50%; cursor: pointer; font-size: 0.9rem; display: flex; align-items: center; justify-content: center; }
    .pp-body { padding: 0 16px 24px; }
    .pp-avatar-wrap { position: relative; margin-top: -30px; margin-bottom: 12px; }
    .pp-avatar { width: 60px; height: 60px; border-radius: 50%; border: 4px solid var(--surface); display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1.3rem; color: #fff; overflow: hidden; }
    .pp-avatar img { width: 100%; height: 100%; object-fit: cover; }
    .pp-status-badge { position: absolute; bottom: 2px; right: 2px; width: 16px; height: 16px; border-radius: 50%; border: 3px solid var(--surface); }
    .pp-name { font-family: 'Syne', sans-serif; font-weight: 700; font-size: 1.05rem; margin-bottom: 2px; }
    .pp-username { font-size: 0.8rem; color: var(--muted); margin-bottom: 6px; }
    .pp-status-line { font-size: 0.82rem; color: var(--muted); margin-bottom: 14px; display: flex; align-items: center; gap: 6px; }
    .pp-divider { height: 1px; background: var(--border); margin: 12px 0; }
    .pp-section-title { font-size: 0.7rem; font-weight: 700; letter-spacing: 0.08em; text-transform: uppercase; color: var(--muted); margin-bottom: 6px; }
    .pp-bio { font-size: 0.85rem; color: #c8cce0; line-height: 1.6; white-space: pre-wrap; word-break: break-word; }
    .pp-since { font-size: 0.82rem; color: var(--muted); }
    .pp-dm-btn { width: 100%; margin-top: 16px; padding: 10px; background: var(--accent); color: #fff; border: none; border-radius: 8px; font-family: 'DM Sans', sans-serif; font-size: 0.88rem; font-weight: 600; cursor: pointer; transition: background 0.2s; }
    .pp-dm-btn:hover { background: #6b7af8; }

    /* ‚îÄ‚îÄ MODALS ‚îÄ‚îÄ */
    .modal-overlay { position: fixed; inset: 0; z-index: 999; background: rgba(0,0,0,0.75); backdrop-filter: blur(8px); display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.2s; }
    .modal-overlay.open { opacity: 1; pointer-events: all; }
    .modal { background: var(--surface); border: 1px solid var(--border); border-radius: 20px; padding: 40px 36px; width: 100%; max-width: 460px; position: relative; transform: translateY(16px); transition: transform 0.2s; max-height: 90vh; overflow-y: auto; }
    .modal-overlay.open .modal { transform: translateY(0); }
    .modal-close { position: absolute; top: 16px; right: 18px; background: none; border: none; color: var(--muted); font-size: 1.4rem; cursor: pointer; }
    .modal-close:hover { color: var(--text); }
    .modal h2 { font-family: 'Syne', sans-serif; font-weight: 700; font-size: 1.4rem; margin-bottom: 6px; }
    .modal > p { color: var(--muted); font-size: 0.88rem; margin-bottom: 24px; }
    .form-group { display: flex; flex-direction: column; gap: 6px; margin-bottom: 16px; }
    .form-group label { font-size: 0.78rem; font-weight: 700; color: var(--muted); letter-spacing: 0.06em; text-transform: uppercase; }
    .form-group input, .form-group textarea, .form-group select { background: var(--surface2); border: 1px solid var(--border); border-radius: 8px; padding: 11px 14px; color: var(--text); font-family: 'DM Sans', sans-serif; font-size: 0.92rem; outline: none; transition: border-color 0.2s; resize: none; }
    .form-group input:focus, .form-group textarea:focus { border-color: var(--accent); }
    .form-group input::placeholder, .form-group textarea::placeholder { color: #4a4f6a; }
    .form-group input:disabled { opacity: 0.5; cursor: not-allowed; }
    .modal-btn { width: 100%; padding: 13px; background: var(--accent); color: #fff; border: none; border-radius: 8px; font-family: 'DM Sans', sans-serif; font-size: 0.92rem; font-weight: 600; cursor: pointer; transition: background 0.2s; box-shadow: 0 0 20px var(--glow); }
    .modal-btn:hover { background: #6b7af8; }
    .modal-btn.danger { background: var(--error); box-shadow: none; }
    .modal-btn.danger:hover { background: #e04040; }
    .modal-btn.secondary { background: var(--surface2); color: var(--text); box-shadow: none; }
    .modal-btn.secondary:hover { background: var(--surface3); }
    .modal-btn-row { display: flex; gap: 10px; }
    .modal-btn-row .modal-btn { flex: 1; }
    .avatar-upload-area { display: flex; align-items: center; gap: 20px; margin-bottom: 24px; }
    .avatar-preview { width: 80px; height: 80px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1.8rem; color: #fff; flex-shrink: 0; overflow: hidden; border: 3px solid var(--border); }
    .avatar-preview img { width: 100%; height: 100%; object-fit: cover; }
    .avatar-upload-btns { display: flex; flex-direction: column; gap: 6px; }
    .avatar-upload-btns button { padding: 8px 16px; border-radius: 8px; font-family: 'DM Sans', sans-serif; font-size: 0.82rem; font-weight: 600; cursor: pointer; border: none; transition: all 0.2s; }
    .upload-btn { background: var(--accent); color: #fff; }
    .upload-btn:hover { background: #6b7af8; }
    .remove-btn { background: var(--surface2); color: var(--muted); }
    .remove-btn:hover { color: var(--error); }
    .avatar-upload-btns p { font-size: 0.75rem; color: var(--muted); }
    .status-selector { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 20px; }
    .status-option { display: flex; align-items: center; gap: 8px; padding: 10px 14px; background: var(--surface2); border: 2px solid var(--border); border-radius: 10px; cursor: pointer; transition: all 0.15s; font-size: 0.85rem; }
    .status-option:hover { border-color: rgba(255,255,255,0.15); }
    .status-option.selected { border-color: var(--accent); background: rgba(91,106,240,0.1); }
    .status-pip { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
    .server-type-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
    .server-type-card { background: var(--surface2); border: 2px solid var(--border); border-radius: 10px; padding: 16px; cursor: pointer; transition: all 0.2s; text-align: center; }
    .server-type-card:hover, .server-type-card.selected { border-color: var(--accent); background: rgba(91,106,240,0.08); }
    .server-type-card .type-icon { font-size: 1.8rem; margin-bottom: 8px; }
    .server-type-card .type-name { font-size: 0.82rem; font-weight: 600; }
    .call-display { text-align: center; padding: 20px 0; }
    .call-avatar { width: 90px; height: 90px; border-radius: 50%; margin: 0 auto 16px; display: flex; align-items: center; justify-content: center; font-size: 2.2rem; font-weight: 700; color: #fff; overflow: hidden; animation: callPulse 2s infinite; }
    .call-avatar img { width: 100%; height: 100%; object-fit: cover; }
    @keyframes callPulse { 0%, 100% { box-shadow: 0 0 0 0 rgba(91,106,240,0.4); } 50% { box-shadow: 0 0 0 16px rgba(91,106,240,0); } }
    .call-name { font-family: 'Syne', sans-serif; font-weight: 700; font-size: 1.3rem; margin-bottom: 6px; }
    .call-status { color: var(--muted); font-size: 0.88rem; margin-bottom: 28px; }
    .call-actions { display: flex; justify-content: center; gap: 20px; }
    .call-action-btn { width: 56px; height: 56px; border-radius: 50%; border: none; cursor: pointer; font-size: 1.3rem; display: flex; align-items: center; justify-content: center; transition: transform 0.15s; }
    .call-action-btn:hover { transform: scale(1.1); }
    .call-action-btn.end { background: var(--error); color: #fff; }
    .call-action-btn.mute, .call-action-btn.video { background: var(--surface2); color: var(--text); }

    /* Danger zone in settings */
    .danger-zone { border: 1px solid rgba(255,95,87,0.2); border-radius: 12px; padding: 20px; margin-top: 8px; }
    .danger-zone h4 { font-family: 'Syne', sans-serif; font-weight: 700; color: var(--error); margin-bottom: 8px; font-size: 0.95rem; }
    .danger-zone p { color: var(--muted); font-size: 0.82rem; margin-bottom: 16px; line-height: 1.5; }

    /* Misc */
    .pending-badge { background: var(--error); color: #fff; font-size: 0.65rem; font-weight: 700; border-radius: 10px; padding: 1px 6px; margin-left: auto; }
    .request-row { display: flex; align-items: center; gap: 12px; padding: 12px 16px; border-radius: 10px; border-bottom: 1px solid var(--border); }
    .request-actions { margin-left: auto; display: flex; gap: 8px; }
    .req-btn { padding: 6px 14px; border-radius: 6px; font-family: 'DM Sans', sans-serif; font-size: 0.8rem; font-weight: 600; cursor: pointer; border: none; transition: all 0.15s; }
    .req-btn.accept { background: var(--success); color: #fff; }
    .req-btn.accept:hover { background: #1db97a; }
    .req-btn.decline { background: var(--surface2); color: var(--muted); }
    .req-btn.decline:hover { color: var(--error); }
    .add-result { font-size: 0.88rem; padding: 10px 14px; border-radius: 8px; display: none; margin-bottom: 12px; }
    .add-result.success { background: rgba(35,209,139,0.1); color: var(--success); border: 1px solid rgba(35,209,139,0.2); display: block; }
    .add-result.error { background: rgba(255,95,87,0.1); color: var(--error); border: 1px solid rgba(255,95,87,0.2); display: block; }
    .empty-state { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; text-align: center; gap: 16px; }
    .empty-state .empty-icon { font-size: 4rem; }
    .empty-state h3 { font-family: 'Syne', sans-serif; font-weight: 700; font-size: 1.3rem; }
    .empty-state p { color: var(--muted); font-size: 0.9rem; max-width: 320px; line-height: 1.6; }
    .lightbox { position: fixed; inset: 0; z-index: 9998; background: rgba(0,0,0,0.9); display: flex; align-items: center; justify-content: center; cursor: zoom-out; opacity: 0; pointer-events: none; transition: opacity 0.2s; }
    .lightbox.open { opacity: 1; pointer-events: all; }
    .lightbox img { max-width: 90vw; max-height: 90vh; border-radius: 10px; object-fit: contain; }
    .toast { position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%) translateY(20px); background: var(--surface2); border: 1px solid var(--border); border-radius: 10px; padding: 12px 20px; font-size: 0.88rem; color: var(--text); z-index: 9999; opacity: 0; transition: all 0.3s; pointer-events: none; white-space: nowrap; }
    .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
    .toast.success { border-color: rgba(35,209,139,0.3); color: var(--success); }
    .toast.error { border-color: rgba(255,95,87,0.3); color: var(--error); }
    ::-webkit-scrollbar { width: 4px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--surface3); border-radius: 2px; }
  </style>
</head>
<body>

<div class="lightbox" id="lightbox" onclick="this.classList.remove('open')"><img id="lightbox-img" src="" alt=""/></div>
<div class="toast" id="toast"></div>

<!-- CREATE SERVER MODAL -->
<div class="modal-overlay" id="createServerModal">
  <div class="modal">
    <button class="modal-close" onclick="closeModal('createServerModal')">√ó</button>
    <h2>Create a Server</h2><p>Give your community a home.</p>
    <div class="server-type-grid">
      <div class="server-type-card selected" onclick="selectServerType(this)"><div class="type-icon">üéÆ</div><div class="type-name">Gaming</div></div>
      <div class="server-type-card" onclick="selectServerType(this)"><div class="type-icon">üé®</div><div class="type-name">Creative</div></div>
      <div class="server-type-card" onclick="selectServerType(this)"><div class="type-icon">üìö</div><div class="type-name">Education</div></div>
      <div class="server-type-card" onclick="selectServerType(this)"><div class="type-icon">üí¨</div><div class="type-name">Community</div></div>
    </div>
    <div class="form-group"><label>Server Name</label><input type="text" id="server-name-input" placeholder="My awesome server"/></div>
    <button class="modal-btn" onclick="createServer()">Create Server</button>
  </div>
</div>

<!-- PROFILE / SETTINGS MODAL -->
<div class="modal-overlay" id="profileModal">
  <div class="modal">
    <button class="modal-close" onclick="closeModal('profileModal')">√ó</button>
    <h2>Edit Profile</h2><p>Customize how others see you on Nexus.</p>
    <div class="avatar-upload-area">
      <div class="avatar-preview" id="profile-avatar-preview"></div>
      <div class="avatar-upload-btns">
        <button class="upload-btn" onclick="document.getElementById('avatar-file-input').click()">Upload Photo</button>
        <button class="remove-btn" onclick="removeAvatar()">Remove</button>
        <p>JPG, PNG or GIF ¬∑ Max 8MB</p>
      </div>
    </div>
    <input type="file" id="avatar-file-input" accept="image/*" style="display:none" onchange="handleAvatarUpload(event)"/>
    <div class="form-group"><label>Display Name</label><input type="text" id="display-name-input" placeholder="Your display name"/></div>
    <div class="form-group"><label>Bio</label><textarea id="bio-input" rows="3" placeholder="Tell people a little about yourself..."></textarea></div>
    <div class="form-group">
      <label>Status</label>
      <div class="status-selector">
        <div class="status-option selected" data-status="online" onclick="selectStatus(this)"><div class="status-pip" style="background:var(--online)"></div>Online</div>
        <div class="status-option" data-status="idle" onclick="selectStatus(this)"><div class="status-pip" style="background:var(--idle)"></div>Idle</div>
        <div class="status-option" data-status="dnd" onclick="selectStatus(this)"><div class="status-pip" style="background:var(--dnd)"></div>Do Not Disturb</div>
        <div class="status-option" data-status="invisible" onclick="selectStatus(this)"><div class="status-pip" style="background:var(--muted)"></div>Invisible</div>
      </div>
    </div>
    <div class="form-group"><label>Username (cannot be changed)</label><input type="text" id="username-readonly" disabled/></div>
    <div class="modal-btn-row" style="margin-bottom:20px">
      <button class="modal-btn secondary" onclick="closeModal('profileModal')">Cancel</button>
      <button class="modal-btn" onclick="saveProfile()">Save Changes</button>
    </div>
    <div class="danger-zone">
      <h4>‚ö†Ô∏è Danger Zone</h4>
      <p>Deleting your account is permanent in the sense that your profile will be removed. Your messages will show as "Deleted User" to others. This cannot be undone.</p>
      <button class="modal-btn danger" onclick="confirmDeleteAccount()">Delete My Account</button>
    </div>
  </div>
</div>

<!-- CONFIRM DELETE ACCOUNT MODAL -->
<div class="modal-overlay" id="deleteAccountModal">
  <div class="modal" style="max-width:400px">
    <button class="modal-close" onclick="closeModal('deleteAccountModal')">√ó</button>
    <h2>Delete Account</h2>
    <p>Are you absolutely sure? Your profile will be permanently removed. Your past messages will show as "Deleted User" to others.</p>
    <div class="form-group"><label>Type DELETE to confirm</label><input type="text" id="delete-confirm-input" placeholder="DELETE"/></div>
    <div class="modal-btn-row">
      <button class="modal-btn secondary" onclick="closeModal('deleteAccountModal')">Cancel</button>
      <button class="modal-btn danger" onclick="deleteAccount()">Yes, Delete My Account</button>
    </div>
  </div>
</div>

<!-- CALL MODAL -->
<div class="modal-overlay" id="callModal">
  <div class="modal" style="max-width:340px;text-align:center;">
    <div class="call-display">
      <div class="call-avatar" id="call-avatar"></div>
      <div class="call-name" id="call-name"></div>
      <div class="call-status" id="call-status">Calling...</div>
      <div class="call-actions">
        <button class="call-action-btn mute">üé§</button>
        <button class="call-action-btn end" onclick="endCall()">üìµ</button>
        <button class="call-action-btn video">üì∑</button>
      </div>
    </div>
  </div>
</div>

<!-- ADD FRIEND MODAL -->
<div class="modal-overlay" id="addFriendModal">
  <div class="modal">
    <button class="modal-close" onclick="closeModal('addFriendModal')">√ó</button>
    <h2>Add Friend</h2><p>Add friends with their Nexus username.</p>
    <div class="add-result" id="add-friend-result-modal"></div>
    <div class="form-group"><label>Username</label><input type="text" id="add-friend-input-modal" placeholder="Enter a username e.g. cool_user"/></div>
    <button class="modal-btn" onclick="sendFriendRequest()">Send Friend Request</button>
  </div>
</div>

<!-- ADMIN ACTION MODAL -->
<div class="modal-overlay" id="adminActionModal">
  <div class="modal" style="max-width:440px">
    <button class="modal-close" onclick="closeModal('adminActionModal')">√ó</button>
    <h2 id="admin-action-title">Action</h2>
    <p id="admin-action-desc"></p>
    <div class="form-group" id="admin-reason-group">
      <label>Reason</label>
      <textarea id="admin-reason-input" rows="3" placeholder="Enter a reason..."></textarea>
    </div>
    <div class="form-group" id="admin-date-group" style="display:none">
      <label>Ban Until (date)</label>
      <input type="date" id="admin-ban-until"/>
    </div>
    <div class="modal-btn-row">
      <button class="modal-btn secondary" onclick="closeModal('adminActionModal')">Cancel</button>
      <button class="modal-btn" id="admin-action-confirm-btn" onclick="executeAdminAction()">Confirm</button>
    </div>
  </div>
</div>

<!-- LAYOUT -->
<div class="servers-bar" id="servers-bar">
  <div class="server-icon home active" onclick="showView()" title="Home"><span class="server-pip"></span>‚åÇ</div>
  <div class="server-divider"></div>
  <div class="server-icon add" onclick="openModal('createServerModal')" title="Create Server">+</div>
</div>

<div class="sidebar">
  <div class="sidebar-header"><span>üí¨</span> Direct Messages</div>
  <div class="sidebar-search"><input type="text" placeholder="Find a conversation..."/></div>
  <div class="sidebar-section-label">Friends <span onclick="openModal('addFriendModal')">+</span></div>
  <div id="dm-list"></div>
  <div class="user-panel" onclick="openProfileModal()">
    <div class="user-panel-avatar" id="sidebar-avatar"></div>
    <div class="user-panel-info">
      <div class="user-panel-name" id="sidebar-display-name">Loading...</div>
      <div class="user-panel-tag" id="sidebar-username">@...</div>
    </div>
    <div class="user-panel-actions">
      <button class="icon-btn" onclick="event.stopPropagation();openProfileModal()" title="Settings">‚öôÔ∏è</button>
      <button class="icon-btn" onclick="event.stopPropagation();handleSignOut()" title="Sign Out">üö™</button>
    </div>
  </div>
</div>

<div class="main">
  <div class="main-header" id="main-header">
    <span>üë•</span><h2>Friends</h2>
    <div class="header-tabs">
      <button class="tab active" onclick="switchTab(this,'online')">Online</button>
      <button class="tab" onclick="switchTab(this,'all')">All</button>
      <button class="tab" onclick="switchTab(this,'pending')">Pending <span id="pending-count" style="display:none" class="pending-badge">0</span></button>
    </div>
    <button class="add-friend-btn" onclick="openModal('addFriendModal')">+ Add Friend</button>
  </div>
  <div class="main-content" id="main-content">
    <div class="empty-state"><div class="empty-icon">üëã</div><h3>Welcome to Nexus!</h3><p>Add some friends to get started.</p></div>
  </div>
</div>

<div class="profile-panel hidden" id="profile-panel">
  <div class="pp-banner" id="pp-banner">
    <button class="pp-close-btn" onclick="document.getElementById('profile-panel').classList.add('hidden')">√ó</button>
  </div>
  <div class="pp-body">
    <div class="pp-avatar-wrap">
      <div class="pp-avatar" id="pp-avatar"></div>
      <div class="pp-status-badge" id="pp-status-badge"></div>
    </div>
    <div class="pp-name" id="pp-name"></div>
    <div class="pp-username" id="pp-username"></div>
    <div class="pp-status-line" id="pp-status-line"></div>
    <div class="pp-divider"></div>
    <div id="pp-bio-wrap" style="display:none">
      <div class="pp-section-title">About Me</div>
      <div class="pp-bio" id="pp-bio"></div>
      <div class="pp-divider"></div>
    </div>
    <div class="pp-section-title">Member Since</div>
    <div class="pp-since" id="pp-since"></div>
    <button class="pp-dm-btn" id="pp-dm-btn" style="display:none" onclick="openDmFromPanel()">üí¨ Send Message</button>
  </div>
</div>

<input type="file" id="dm-file-input" style="display:none" accept="image/*,video/*,audio/*,.pdf,.doc,.docx,.txt,.zip,.rar" onchange="handleDmFileUpload(event)"/>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut, deleteUser } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc, collection, query, where, getDocs, addDoc, onSnapshot, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

  const CLOUDINARY_CLOUD = 'dskssf3tn';
  const CLOUDINARY_PRESET = 'nexus_avatars';
  const ADMIN_USERNAMES = ['rivalsonts', 'ds64'];

  const app = initializeApp({
    apiKey: "AIzaSyDKGqss5jcCNd_AYYohYs-KaSKvZUemX-4",
    authDomain: "nexus-app-74493.firebaseapp.com",
    projectId: "nexus-app-74493",
    storageBucket: "nexus-app-74493.firebasestorage.app",
    messagingSenderId: "179885556901",
    appId: "1:179885556901:web:1966afe8102de60d9cb94c"
  });
  const auth = getAuth(app);
  const db = getFirestore(app);

  let currentUser = null, currentProfile = null, pendingAvatarDataUrl = null;
  let currentDmFriend = null, dmUnsubscribe = null, selectedStatus = 'online';
  let profilePanelUser = null, isAdmin = false;
  let adminActionTarget = null, adminActionType = null;

  // ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ
  onAuthStateChanged(auth, async (user) => {
    if (!user) { window.location.href = 'index.html'; return; }
    currentUser = user;
    await loadProfile();

    // Check if banned
    const banSnap = await getDoc(doc(db, 'bans', currentUser.uid));
    if (banSnap.exists()) {
      const ban = banSnap.data();
      if (ban.type === 'permanent') { await signOut(auth); window.location.href = 'banned.html'; return; }
      if (ban.type === 'temporary' && ban.until) {
        const until = ban.until.toDate ? ban.until.toDate() : new Date(ban.until);
        if (new Date() < until) { await signOut(auth); window.location.href = 'banned.html'; return; }
        else await deleteDoc(doc(db, 'bans', currentUser.uid)); // expired ban
      }
    }

    isAdmin = ADMIN_USERNAMES.includes(currentProfile.username);
    if (isAdmin) addAdminButton();

    try { await updateDoc(doc(db,'users',currentUser.uid),{status: currentProfile.manualStatus || 'online'}); } catch(e){}
    await loadFriends();
    await loadServers();

    window.addEventListener('beforeunload', async () => {
      try { await updateDoc(doc(db,'users',currentUser.uid),{status: currentProfile.manualStatus === 'invisible' ? 'invisible' : 'offline'}); } catch(e){}
    });
  });

  function addAdminButton() {
    const bar = document.getElementById('servers-bar');
    const addBtn = bar.querySelector('.server-icon.add');
    const adminIcon = document.createElement('div');
    adminIcon.className = 'server-icon admin-icon';
    adminIcon.title = 'Admin Panel';
    adminIcon.innerHTML = `<span class="server-pip"></span>üõ°Ô∏è`;
    adminIcon.onclick = () => {
      document.querySelectorAll('.server-icon').forEach(i => i.classList.remove('active'));
      adminIcon.classList.add('active');
      showAdminPanel();
    };
    bar.insertBefore(adminIcon, addBtn);
  }

  async function loadProfile() {
    const snap = await getDoc(doc(db,'users',currentUser.uid));
    currentProfile = snap.exists() ? snap.data() : { username: currentUser.email, displayName: '', avatarUrl: '', bio: '', status: 'online' };
    if (currentProfile.deleted) { await signOut(auth); window.location.href = 'index.html'; return; }
    selectedStatus = currentProfile.status || 'online';
    updateSidebarUser();
  }

  function updateSidebarUser() {
    const name = currentProfile.displayName || currentProfile.username;
    document.getElementById('sidebar-display-name').textContent = name;
    document.getElementById('sidebar-username').textContent = '@' + currentProfile.username;
    const av = document.getElementById('sidebar-avatar');
    if (currentProfile.avatarUrl) { av.innerHTML = `<img src="${currentProfile.avatarUrl}"/>`; av.style.background = ''; }
    else { av.innerHTML = name[0].toUpperCase(); av.style.background = color(currentProfile.username); }
  }

  // ‚îÄ‚îÄ ADMIN PANEL ‚îÄ‚îÄ
  window.showAdminPanel = async function() {
    if (!isAdmin) return;
    document.getElementById('profile-panel').classList.add('hidden');
    document.getElementById('main-content').style.padding = '0';
    document.getElementById('main-header').innerHTML = `<span>üõ°Ô∏è</span><h2 style="color:var(--admin)">Admin Panel</h2><span style="font-size:0.78rem;color:var(--muted);margin-left:4px">¬∑ Manage all accounts</span>`;

    document.getElementById('main-content').innerHTML = `
      <div style="display:flex;flex-direction:column;height:100%">
        <div class="admin-toolbar">
          <input class="admin-search" id="admin-search" placeholder="Search by username or email..." oninput="filterAdminUsers()"/>
          <select class="admin-filter" id="admin-filter" onchange="filterAdminUsers()">
            <option value="all">All Users</option>
            <option value="active">Active</option>
            <option value="banned">Banned</option>
            <option value="warned">Warned</option>
            <option value="deleted">Deleted</option>
          </select>
        </div>
        <div class="admin-stats" id="admin-stats">
          <div class="admin-stat"><div class="admin-stat-num" id="stat-total">‚Äî</div><div class="admin-stat-label">Total Accounts</div></div>
          <div class="admin-stat"><div class="admin-stat-num" id="stat-active" style="color:var(--success)">‚Äî</div><div class="admin-stat-label">Active</div></div>
          <div class="admin-stat"><div class="admin-stat-num" id="stat-banned" style="color:var(--error)">‚Äî</div><div class="admin-stat-label">Banned</div></div>
          <div class="admin-stat"><div class="admin-stat-num" id="stat-deleted" style="color:var(--muted)">‚Äî</div><div class="admin-stat-label">Deleted</div></div>
        </div>
        <div class="admin-table-header"><div>User</div><div>Email</div><div>Joined</div><div>Status</div><div>Actions</div></div>
        <div class="admin-table" id="admin-user-list"><div class="admin-empty">Loading users...</div></div>
      </div>`;

    await loadAdminUsers();
  };

  let allAdminUsers = [];

  async function loadAdminUsers() {
    const snap = await getDocs(collection(db, 'users'));
    const bansSnap = await getDocs(collection(db, 'bans'));
    const bans = {};
    bansSnap.docs.forEach(d => { bans[d.id] = d.data(); });

    allAdminUsers = snap.docs.map(d => ({ id: d.id, ...d.data(), ban: bans[d.id] || null }));

    // Stats
    const total = allAdminUsers.length;
    const banned = allAdminUsers.filter(u => u.ban && (u.ban.type === 'permanent' || u.ban.type === 'temporary')).length;
    const deleted = allAdminUsers.filter(u => u.deleted).length;
    const active = total - banned - deleted;
    const el = id => document.getElementById(id);
    if (el('stat-total')) { el('stat-total').textContent = total; el('stat-active').textContent = active; el('stat-banned').textContent = banned; el('stat-deleted').textContent = deleted; }

    renderAdminUsers(allAdminUsers);
  }

  window.filterAdminUsers = function() {
    const search = (document.getElementById('admin-search')?.value || '').toLowerCase();
    const filter = document.getElementById('admin-filter')?.value || 'all';
    let users = allAdminUsers;
    if (search) users = users.filter(u => (u.username||'').includes(search) || (u.email||'').includes(search) || (u.displayName||'').includes(search));
    if (filter === 'active') users = users.filter(u => !u.deleted && !u.ban);
    else if (filter === 'banned') users = users.filter(u => u.ban && (u.ban.type === 'permanent' || u.ban.type === 'temporary'));
    else if (filter === 'warned') users = users.filter(u => u.ban && u.ban.type === 'warning');
    else if (filter === 'deleted') users = users.filter(u => u.deleted);
    renderAdminUsers(users);
  };

  function renderAdminUsers(users) {
    const list = document.getElementById('admin-user-list');
    if (!list) return;
    if (!users.length) { list.innerHTML = '<div class="admin-empty">No users found.</div>'; return; }
    list.innerHTML = '';
    users.forEach(u => {
      const name = u.displayName || u.username || 'Unknown';
      const joined = u.createdAt ? new Date(u.createdAt).toLocaleDateString() : '‚Äî';
      const isSelf = u.id === currentUser.uid;
      const isAdminAcc = ADMIN_USERNAMES.includes(u.username);

      // Determine badge
      let badge = '';
      if (u.deleted) badge = `<span class="admin-badge badge-deleted">üóë Deleted</span>`;
      else if (u.ban?.type === 'permanent') badge = `<span class="admin-badge badge-banned">üî® Banned</span>`;
      else if (u.ban?.type === 'temporary') {
        const until = u.ban.until?.toDate ? u.ban.until.toDate() : new Date(u.ban.until || 0);
        badge = `<span class="admin-badge badge-temp">‚è≥ Temp Ban</span>`;
        if (new Date() > until) badge = `<span class="admin-badge badge-active">‚úì Active</span>`; // expired
      } else if (u.ban?.type === 'warning') badge = `<span class="admin-badge badge-warned">‚ö†Ô∏è Warned</span>`;
      else badge = `<span class="admin-badge badge-active">‚úì Active</span>`;

      // Action buttons (don't show for self or other admins)
      let actions = '';
      if (!isSelf && !isAdminAcc && !u.deleted) {
        const hasBan = u.ban && (u.ban.type === 'permanent' || u.ban.type === 'temporary');
        actions = `
          <button class="admin-btn admin-btn-warn" onclick="openAdminAction('${u.id}','warn','${esc(name)}')">‚ö†Ô∏è Warn</button>
          <button class="admin-btn admin-btn-temp" onclick="openAdminAction('${u.id}','temp','${esc(name)}')">‚è≥ Temp</button>
          ${hasBan
            ? `<button class="admin-btn admin-btn-unban" onclick="openAdminAction('${u.id}','unban','${esc(name)}')">‚úì Unban</button>`
            : `<button class="admin-btn admin-btn-ban" onclick="openAdminAction('${u.id}','ban','${esc(name)}')">üî® Ban</button>`}
          <button class="admin-btn admin-btn-delete" onclick="openAdminAction('${u.id}','admindelete','${esc(name)}')">üóë</button>
        `;
      } else if (isSelf) actions = `<span style="font-size:0.75rem;color:var(--muted)">You</span>`;
      else if (isAdminAcc) actions = `<span style="font-size:0.75rem;color:var(--admin)">Admin</span>`;
      else if (u.deleted) actions = `<span style="font-size:0.75rem;color:var(--muted)">Deleted</span>`;

      const row = document.createElement('div');
      row.className = 'admin-user-row';
      row.innerHTML = `
        <div class="admin-user-info">
          <div class="admin-avatar" style="background:${color(u.username||'x')}">
            ${u.avatarUrl ? `<img src="${u.avatarUrl}"/>` : (name[0]||'?').toUpperCase()}
          </div>
          <div>
            <div class="admin-user-name">${esc(name)} ${isAdminAcc ? 'üõ°Ô∏è' : ''}</div>
            <div class="admin-user-tag">@${u.username||'‚Äî'}</div>
          </div>
        </div>
        <div style="font-size:0.82rem;color:var(--muted);overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(u.email||'‚Äî')}</div>
        <div style="font-size:0.82rem;color:var(--muted)">${joined}</div>
        <div>${badge}</div>
        <div class="admin-actions">${actions}</div>
      `;
      list.appendChild(row);

      // Show ban reason below if warned/banned
      if (u.ban?.reason) {
        const reasonRow = document.createElement('div');
        reasonRow.style.cssText = 'padding:4px 24px 8px 80px;font-size:0.78rem;color:var(--muted);border-bottom:1px solid var(--border)';
        reasonRow.textContent = `Reason: ${u.ban.reason}`;
        list.appendChild(reasonRow);
      }
    });
  }

  window.openAdminAction = function(uid, type, name) {
    adminActionTarget = uid;
    adminActionType = type;
    const titles = { warn: '‚ö†Ô∏è Warn User', temp: '‚è≥ Temporary Ban', ban: 'üî® Permanent Ban', unban: '‚úì Unban User', admindelete: 'üóë Delete Account' };
    const descs = {
      warn: `Send a warning to <strong>${name}</strong>. Their account stays active but the warning is recorded.`,
      temp: `Temporarily ban <strong>${name}</strong>. They won't be able to log in until the ban expires.`,
      ban: `Permanently ban <strong>${name}</strong>. They will be unable to log into their account.`,
      unban: `Remove all bans and warnings from <strong>${name}</strong>'s account.`,
      admindelete: `Soft-delete <strong>${name}</strong>'s account. Their profile will be removed and messages will show as "Deleted User".`
    };
    document.getElementById('admin-action-title').textContent = titles[type];
    document.getElementById('admin-action-desc').innerHTML = descs[type];
    document.getElementById('admin-reason-input').value = '';
    const dateGroup = document.getElementById('admin-date-group');
    const reasonGroup = document.getElementById('admin-reason-group');
    dateGroup.style.display = type === 'temp' ? 'flex' : 'none';
    reasonGroup.style.display = type === 'unban' ? 'none' : 'flex';
    const confirmBtn = document.getElementById('admin-action-confirm-btn');
    confirmBtn.className = 'modal-btn' + (type === 'ban' || type === 'admindelete' ? ' danger' : type === 'unban' ? ' secondary' : '');
    confirmBtn.textContent = type === 'unban' ? 'Remove Ban' : type === 'admindelete' ? 'Delete Account' : 'Confirm';
    openModal('adminActionModal');
  };

  window.executeAdminAction = async function() {
    const uid = adminActionTarget;
    const type = adminActionType;
    const reason = document.getElementById('admin-reason-input')?.value.trim() || '';
    if (!uid || !type) return;

    try {
      if (type === 'warn') {
        await setDoc(doc(db,'bans',uid), { type: 'warning', reason, issuedBy: currentUser.uid, issuedAt: serverTimestamp() });
        showToast('Warning issued.', 'success');
      } else if (type === 'temp') {
        const until = document.getElementById('admin-ban-until').value;
        if (!until) { showToast('Please select a date.', 'error'); return; }
        await setDoc(doc(db,'bans',uid), { type: 'temporary', reason, until: new Date(until), issuedBy: currentUser.uid, issuedAt: serverTimestamp() });
        showToast('Temporary ban applied.', 'success');
      } else if (type === 'ban') {
        await setDoc(doc(db,'bans',uid), { type: 'permanent', reason, issuedBy: currentUser.uid, issuedAt: serverTimestamp() });
        showToast('User permanently banned.', 'success');
      } else if (type === 'unban') {
        await deleteDoc(doc(db,'bans',uid));
        showToast('Ban removed.', 'success');
      } else if (type === 'admindelete') {
        await updateDoc(doc(db,'users',uid), { deleted: true, deletedAt: serverTimestamp(), displayName: 'Deleted User', avatarUrl: '', bio: '' });
        showToast('Account deleted.', 'success');
      }
      closeModal('adminActionModal');
      await loadAdminUsers();
    } catch(e) {
      showToast('Action failed: ' + e.message, 'error');
    }
  };

  // ‚îÄ‚îÄ DELETE OWN ACCOUNT ‚îÄ‚îÄ
  window.confirmDeleteAccount = function() {
    closeModal('profileModal');
    document.getElementById('delete-confirm-input').value = '';
    openModal('deleteAccountModal');
  };

  window.deleteAccount = async function() {
    const input = document.getElementById('delete-confirm-input').value.trim();
    if (input !== 'DELETE') { showToast('Please type DELETE to confirm.', 'error'); return; }
    try {
      // Soft delete: mark profile as deleted, wipe personal info
      await updateDoc(doc(db,'users',currentUser.uid), {
        deleted: true, deletedAt: serverTimestamp(),
        displayName: 'Deleted User', avatarUrl: '', bio: '',
        status: 'offline', email: ''
      });
      // Sign out and delete auth account
      const user = auth.currentUser;
      await signOut(auth);
      try { await deleteUser(user); } catch(e) {} // may fail if session old, that's ok
      window.location.href = 'index.html';
    } catch(e) {
      showToast('Could not delete account. Please sign out and sign back in, then try again.', 'error');
    }
  };

  // ‚îÄ‚îÄ FRIENDS ‚îÄ‚îÄ
  async function loadFriends() {
    const snap = await getDocs(query(collection(db,'friendships'), where('users','array-contains',currentUser.uid), where('status','==','accepted')));
    const friends = [];
    for (const d of snap.docs) {
      const friendId = d.data().users.find(id => id !== currentUser.uid);
      const fs = await getDoc(doc(db,'users',friendId));
      if (fs.exists()) friends.push({ id: friendId, ...fs.data() });
    }
    window._friends = friends;
    renderDmList(friends);
    renderFriendsView(friends);
    await loadPendingRequests();
  }

  function statusColor(s) { return s==='online'?'var(--online)':s==='idle'?'var(--idle)':s==='dnd'?'var(--dnd)':'var(--muted)'; }
  function statusLabel(s) { return {online:'Online',idle:'Idle',dnd:'Do Not Disturb',invisible:'Offline',offline:'Offline'}[s]||'Offline'; }
  function visibleStatus(s) { return s==='invisible'?'offline':(s||'offline'); }

  function renderDmList(friends) {
    const list = document.getElementById('dm-list');
    list.innerHTML = !friends.length ? '<div style="padding:8px 16px;font-size:0.78rem;color:var(--muted)">No friends yet</div>' : '';
    friends.forEach(f => {
      const name = f.deleted ? 'Deleted User' : (f.displayName || f.username);
      const vs = f.deleted ? 'offline' : visibleStatus(f.status);
      const div = document.createElement('div');
      div.className = 'sidebar-item';
      div.innerHTML = `<div class="item-avatar" style="background:${f.deleted?'var(--muted)':color(f.username)}">${f.avatarUrl&&!f.deleted?`<img src="${f.avatarUrl}"/>`:`${name[0].toUpperCase()}`}<span class="status-dot ${vs}"></span></div><span style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap${f.deleted?';color:var(--muted)':''}">${name}</span>`;
      div.onclick = () => openDm(f);
      list.appendChild(div);
    });
  }

  function renderFriendsView(friends) {
    const content = document.getElementById('main-content');
    content.style.padding = '24px';
    if (!friends.length) { content.innerHTML = `<div class="empty-state"><div class="empty-icon">ü§ù</div><h3>No friends yet</h3><p>Add friends by clicking "+ Add Friend".</p></div>`; return; }
    content.innerHTML = `<div class="friends-list"></div>`;
    friends.forEach(f => {
      const name = f.deleted ? 'Deleted User' : (f.displayName || f.username);
      const vs = f.deleted ? 'offline' : visibleStatus(f.status);
      const row = document.createElement('div');
      row.className = 'friend-row';
      row.innerHTML = `
        <div class="friend-avatar" style="background:${f.deleted?'var(--muted)':color(f.username)}" onclick='${f.deleted?'':` showProfilePanel(${sj(f)})`}'>
          ${f.avatarUrl&&!f.deleted?`<img src="${f.avatarUrl}"/>`:`${name[0].toUpperCase()}`}
          <span class="status-dot ${vs}" style="position:absolute;bottom:0;right:0;border-color:var(--bg)"></span>
        </div>
        <div class="friend-info" onclick='${f.deleted?'':` showProfilePanel(${sj(f)})`}'>
          <div class="friend-name" style="${f.deleted?'color:var(--muted)':''}">${name}</div>
          <div class="friend-status">${f.deleted?'Account deleted':statusLabel(vs)+' ¬∑ @'+f.username}</div>
        </div>
        <div class="friend-actions">
          <button class="friend-btn" title="Message" onclick='openDm(${sj(f)})'>üí¨</button>
          ${!f.deleted?`<button class="friend-btn" title="Voice Call" onclick='startCall(${sj(f)})'>üìû</button>`:''}
        </div>`;
      document.querySelector('.friends-list').appendChild(row);
    });
  }

  // ‚îÄ‚îÄ PROFILE PANEL ‚îÄ‚îÄ
  window.showProfilePanel = function(f) {
    if (f.deleted) return;
    profilePanelUser = f;
    document.getElementById('profile-panel').classList.remove('hidden');
    const name = f.displayName || f.username;
    const vs = visibleStatus(f.status);
    document.getElementById('pp-banner').style.background = `linear-gradient(135deg,${color(f.username)},${color(f.username+'2')})`;
    const av = document.getElementById('pp-avatar'); av.style.background = color(f.username);
    av.innerHTML = f.avatarUrl ? `<img src="${f.avatarUrl}"/>` : name[0].toUpperCase();
    const badge = document.getElementById('pp-status-badge'); badge.style.background = statusColor(vs);
    document.getElementById('pp-name').textContent = name;
    document.getElementById('pp-username').textContent = '@' + f.username;
    document.getElementById('pp-status-line').innerHTML = `<span style="width:8px;height:8px;border-radius:50%;background:${statusColor(vs)};display:inline-block;flex-shrink:0"></span>${statusLabel(vs)}`;
    const bioWrap = document.getElementById('pp-bio-wrap');
    if (f.bio) { bioWrap.style.display='block'; document.getElementById('pp-bio').textContent=f.bio; } else { bioWrap.style.display='none'; }
    const since = f.createdAt ? new Date(f.createdAt).toLocaleDateString('en-US',{month:'long',day:'numeric',year:'numeric'}) : 'Unknown';
    document.getElementById('pp-since').textContent = since;
    document.getElementById('pp-dm-btn').style.display = (!f.id||f.id===currentUser.uid) ? 'none' : 'block';
  };
  window.openDmFromPanel = function() { if (profilePanelUser) openDm(profilePanelUser); };

  // ‚îÄ‚îÄ PENDING ‚îÄ‚îÄ
  async function loadPendingRequests() {
    const snap = await getDocs(query(collection(db,'friendships'), where('to','==',currentUser.uid), where('status','==','pending')));
    window._pendingRequests = [];
    for (const d of snap.docs) {
      const fs = await getDoc(doc(db,'users',d.data().from));
      if (fs.exists() && !fs.data().deleted) window._pendingRequests.push({ docId: d.id, ...fs.data(), fromUid: d.data().from });
    }
    const badge = document.getElementById('pending-count');
    if (badge) { if (window._pendingRequests.length) { badge.textContent=window._pendingRequests.length; badge.style.display='inline'; } else badge.style.display='none'; }
  }

  function renderPendingView() {
    const content = document.getElementById('main-content'); content.style.padding='24px';
    const reqs = window._pendingRequests||[];
    if (!reqs.length) { content.innerHTML=`<div class="empty-state"><div class="empty-icon">üì≠</div><h3>No pending requests</h3><p>When someone sends you a friend request it'll show here.</p></div>`; return; }
    content.innerHTML=`<div class="friends-list"></div>`;
    const list=content.querySelector('.friends-list');
    reqs.forEach(r => {
      const name=r.displayName||r.username;
      const row=document.createElement('div'); row.className='request-row';
      row.innerHTML=`<div style="width:40px;height:40px;border-radius:50%;background:${color(r.username)};display:flex;align-items:center;justify-content:center;font-weight:700;color:#fff;overflow:hidden;flex-shrink:0">${r.avatarUrl?`<img src="${r.avatarUrl}" style="width:100%;height:100%;object-fit:cover"/>`:name[0].toUpperCase()}</div><div><div style="font-weight:600;font-size:0.92rem">${name}</div><div style="font-size:0.78rem;color:var(--muted)">@${r.username} ¬∑ Incoming Request</div></div><div class="request-actions"><button class="req-btn accept" onclick="acceptRequest('${r.docId}')">‚úì Accept</button><button class="req-btn decline" onclick="declineRequest('${r.docId}')">‚úó Decline</button></div>`;
      list.appendChild(row);
    });
  }
  window.acceptRequest = async (docId) => { await updateDoc(doc(db,'friendships',docId),{status:'accepted'}); showToast('Friend added! üéâ','success'); await loadFriends(); };
  window.declineRequest = async (docId) => { await updateDoc(doc(db,'friendships',docId),{status:'declined'}); showToast('Request declined.',''); await loadPendingRequests(); renderPendingView(); };

  // ‚îÄ‚îÄ ADD FRIEND ‚îÄ‚îÄ
  window.sendFriendRequest = async function() {
    const input=document.getElementById('add-friend-input-modal');
    const resultBox=document.getElementById('add-friend-result-modal');
    const username=input.value.trim().toLowerCase();
    resultBox.className='add-result';
    if (!username) { resultBox.textContent='Please enter a username.'; resultBox.className='add-result error'; return; }
    if (username===currentProfile.username) { resultBox.textContent="You can't add yourself!"; resultBox.className='add-result error'; return; }
    const usSnap=await getDoc(doc(db,'usernames',username));
    if (!usSnap.exists()) { resultBox.textContent=`No user found with username "${username}".`; resultBox.className='add-result error'; return; }
    const targetUid=usSnap.data().uid;
    const targetSnap=await getDoc(doc(db,'users',targetUid));
    if (targetSnap.exists()&&targetSnap.data().deleted) { resultBox.textContent='That account no longer exists.'; resultBox.className='add-result error'; return; }
    const existSnap=await getDocs(query(collection(db,'friendships'),where('users','array-contains',currentUser.uid)));
    for (const d of existSnap.docs) {
      if (d.data().users.includes(targetUid)) { resultBox.textContent=d.data().status==='accepted'?"You're already friends!":'Request already sent.'; resultBox.className='add-result error'; return; }
    }
    await addDoc(collection(db,'friendships'),{users:[currentUser.uid,targetUid],from:currentUser.uid,to:targetUid,status:'pending',createdAt:serverTimestamp()});
    resultBox.textContent=`Friend request sent to @${username}! üéâ`; resultBox.className='add-result success'; input.value='';
  };

  // ‚îÄ‚îÄ DM ‚îÄ‚îÄ
  window.openDm = function(friend) {
    currentDmFriend = friend;
    if (dmUnsubscribe) dmUnsubscribe();
    document.getElementById('profile-panel').classList.add('hidden');
    const name = friend.deleted ? 'Deleted User' : (friend.displayName || friend.username);
    const vs = friend.deleted ? 'offline' : visibleStatus(friend.status);
    document.getElementById('main-header').innerHTML = `
      <div style="width:36px;height:36px;border-radius:50%;background:${friend.deleted?'var(--muted)':color(friend.username)};display:flex;align-items:center;justify-content:center;font-weight:700;color:#fff;overflow:hidden;flex-shrink:0;${!friend.deleted?'cursor:pointer':''}" ${!friend.deleted?`onclick='showProfilePanel(${sj(friend)})'`:''}>
        ${friend.avatarUrl&&!friend.deleted?`<img src="${friend.avatarUrl}" style="width:100%;height:100%;object-fit:cover"/>`:name[0].toUpperCase()}
      </div>
      <h2 ${!friend.deleted?`style="cursor:pointer" onclick='showProfilePanel(${sj(friend)})'`:''}>${name}</h2>
      <span style="font-size:0.78rem;color:var(--muted)">¬∑ ${friend.deleted?'Account deleted':statusLabel(vs)}</span>
      ${!friend.deleted?`<button style="margin-left:auto" class="friend-btn" onclick='startCall(${sj(friend)})'>üìû</button><button class="friend-btn" onclick='showProfilePanel(${sj(friend)})'>üë§</button>`:'<span style="margin-left:auto"></span>'}
    `;
    const content = document.getElementById('main-content');
    content.style.padding = '0';
    content.innerHTML = `
      <div class="chat-view">
        <div class="chat-messages" id="chat-messages"></div>
        ${friend.deleted
          ? `<div class="deactivated-bar">‚ö†Ô∏è This user's account has been deactivated. You can no longer send them messages.</div>`
          : `<div class="chat-input-area"><div class="chat-input-box"><button class="chat-attach-btn" onclick="document.getElementById('dm-file-input').click()" title="Attach file">üìé</button><input type="text" id="chat-input" placeholder="Message @${name}" onkeydown="if(event.key==='Enter')sendMessage()"/><button class="chat-send-btn" onclick="sendMessage()">‚û§</button></div></div>`
        }
      </div>`;

    const roomId = [currentUser.uid, friend.id].sort().join('_');
    dmUnsubscribe = onSnapshot(query(collection(db,'dms',roomId,'messages'), orderBy('createdAt')), snap => {
      const container = document.getElementById('chat-messages');
      if (!container) return;
      container.innerHTML = '';
      if (snap.empty) { container.innerHTML=`<div class="empty-state" style="flex:1"><div class="empty-icon">üëã</div><h3>${friend.deleted?'Conversation history':'Start the conversation!'}</h3><p>${friend.deleted?'This account has been deactivated.':'This is the beginning of your DM with '+name+'.'}</p></div>`; return; }
      snap.docs.forEach(d => {
        const data = d.data();
        const isMe = data.senderId === currentUser.uid;
        const senderIsDeleted = !isMe && friend.deleted;
        const sName = isMe ? (currentProfile.displayName||currentProfile.username) : (senderIsDeleted?'Deleted User':name);
        const sAvatar = isMe ? currentProfile.avatarUrl : (senderIsDeleted?'':friend.avatarUrl);
        const sColor = isMe ? color(currentProfile.username) : (senderIsDeleted?'var(--muted)':color(friend.username));
        const sData = isMe ? {...currentProfile,id:currentUser.uid} : friend;
        const time = data.createdAt ? new Date(data.createdAt.toDate()).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}) : '';
        let body = '';
        if (data.type==='image') body=`<img class="msg-image" src="${data.fileUrl}" alt="image" onclick="openLightbox('${data.fileUrl}')"/>`;
        else if (data.type==='video') body=`<video class="msg-video" controls src="${data.fileUrl}"></video>`;
        else if (data.type==='audio') body=`<audio class="msg-audio" controls src="${data.fileUrl}"></audio>`;
        else if (data.type==='file') body=`<a class="msg-file" href="${data.fileUrl}" target="_blank"><span class="msg-file-icon">${fileIcon(data.fileName||'')}</span><div><div class="msg-file-name">${esc(data.fileName||'File')}</div><div class="msg-file-size">${data.fileSize||''} ¬∑ Click to download</div></div></a>`;
        else body=`<div class="chat-msg-text">${esc(data.text||'')}</div>`;
        const el=document.createElement('div'); el.className='chat-msg';
        el.innerHTML=`<div class="chat-msg-avatar" style="background:${sColor}" ${!senderIsDeleted&&!isMe?`onclick='showProfilePanel(${sj(sData)})'`:isMe?`onclick='showProfilePanel(${sj(sData)})'`:''}>${sAvatar?`<img src="${sAvatar}"/>`:`${sName[0].toUpperCase()}`}</div><div class="chat-msg-body"><div class="chat-msg-header"><span class="chat-msg-name" style="${senderIsDeleted?'color:var(--muted);cursor:default':''}">${sName}</span><span class="chat-msg-time">${time}</span></div>${body}</div>`;
        container.appendChild(el);
      });
      container.scrollTop = container.scrollHeight;
    });
  };

  window.sendMessage = async function() {
    const input=document.getElementById('chat-input');
    const text=input?.value.trim();
    if (!text||!currentDmFriend||currentDmFriend.deleted) return;
    input.value='';
    const roomId=[currentUser.uid,currentDmFriend.id].sort().join('_');
    await addDoc(collection(db,'dms',roomId,'messages'),{text,senderId:currentUser.uid,type:'text',createdAt:serverTimestamp()});
  };

  // ‚îÄ‚îÄ FILE UPLOAD ‚îÄ‚îÄ
  window.handleDmFileUpload = async function(event) {
    const file=event.target.files[0]; event.target.value='';
    if (!file||!currentDmFriend||currentDmFriend.deleted) return;
    if (file.size>100*1024*1024) { showToast('File must be under 100MB','error'); return; }
    const container=document.getElementById('chat-messages');
    const indicator=document.createElement('div'); indicator.className='upload-progress';
    indicator.innerHTML=`<span>‚¨ÜÔ∏è Uploading ${esc(file.name)}...</span><div class="progress-bar"><div class="progress-fill" id="upload-fill"></div></div>`;
    if (container) { container.appendChild(indicator); container.scrollTop=container.scrollHeight; }
    try {
      const fd=new FormData(); fd.append('file',file); fd.append('upload_preset',CLOUDINARY_PRESET); fd.append('resource_type','auto');
      let prog=0;
      const iv=setInterval(()=>{ prog=Math.min(prog+8,85); const el=document.getElementById('upload-fill'); if(el) el.style.width=prog+'%'; },200);
      const res=await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD}/auto/upload`,{method:'POST',body:fd});
      const data=await res.json(); clearInterval(iv);
      const fill=document.getElementById('upload-fill'); if(fill) fill.style.width='100%';
      if (indicator.parentNode) indicator.remove();
      if (!data.secure_url) throw new Error('Upload failed');
      const roomId=[currentUser.uid,currentDmFriend.id].sort().join('_');
      let ftype='file';
      if (file.type.startsWith('image/')) ftype='image';
      else if (file.type.startsWith('video/')) ftype='video';
      else if (file.type.startsWith('audio/')) ftype='audio';
      await addDoc(collection(db,'dms',roomId,'messages'),{senderId:currentUser.uid,type:ftype,fileUrl:data.secure_url,fileName:file.name,fileSize:fmtSize(file.size),createdAt:serverTimestamp()});
    } catch(e) { if(indicator.parentNode) indicator.remove(); showToast('Upload failed. Please try again.','error'); }
  };

  window.openLightbox = url => { document.getElementById('lightbox-img').src=url; document.getElementById('lightbox').classList.add('open'); };

  // ‚îÄ‚îÄ PROFILE EDIT ‚îÄ‚îÄ
  window.openProfileModal = function() {
    document.getElementById('display-name-input').value=currentProfile.displayName||'';
    document.getElementById('bio-input').value=currentProfile.bio||'';
    document.getElementById('username-readonly').value='@'+currentProfile.username;
    selectedStatus=currentProfile.status||'online';
    document.querySelectorAll('.status-option').forEach(o=>o.classList.toggle('selected',o.dataset.status===selectedStatus));
    const preview=document.getElementById('profile-avatar-preview');
    const name=currentProfile.displayName||currentProfile.username;
    if (currentProfile.avatarUrl) { preview.innerHTML=`<img src="${currentProfile.avatarUrl}"/>`; preview.style.background=''; }
    else { preview.innerHTML=name[0].toUpperCase(); preview.style.background=color(currentProfile.username); }
    pendingAvatarDataUrl=null;
    openModal('profileModal');
  };
  window.selectStatus = card => { document.querySelectorAll('.status-option').forEach(c=>c.classList.remove('selected')); card.classList.add('selected'); selectedStatus=card.dataset.status; };
  window.handleAvatarUpload = function(event) {
    const file=event.target.files[0]; if (!file) return;
    if (file.size>8*1024*1024) { showToast('Image must be under 8MB','error'); return; }
    const reader=new FileReader(); reader.onload=e=>{ pendingAvatarDataUrl=e.target.result; const p=document.getElementById('profile-avatar-preview'); p.innerHTML=`<img src="${pendingAvatarDataUrl}"/>`; p.style.background=''; }; reader.readAsDataURL(file);
  };
  window.removeAvatar = function() { pendingAvatarDataUrl='remove'; const p=document.getElementById('profile-avatar-preview'); const n=document.getElementById('display-name-input').value||currentProfile.username; p.innerHTML=n[0].toUpperCase(); p.style.background=color(currentProfile.username); };
  window.saveProfile = async function() {
    const displayName=document.getElementById('display-name-input').value.trim();
    const bio=document.getElementById('bio-input').value.trim();
    let avatarUrl=currentProfile.avatarUrl||'';
    if (pendingAvatarDataUrl==='remove') { avatarUrl=''; }
    else if (pendingAvatarDataUrl?.startsWith('data:')) {
      try {
        const file=document.getElementById('avatar-file-input').files[0];
        if (file) {
          showToast('Uploading photo...','');
          const fd=new FormData(); fd.append('file',file); fd.append('upload_preset',CLOUDINARY_PRESET); fd.append('public_id',`avatars/${currentUser.uid}`);
          const res=await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD}/image/upload`,{method:'POST',body:fd});
          const data=await res.json();
          if (data.secure_url) avatarUrl=data.secure_url; else { showToast('Image upload failed.','error'); return; }
        }
      } catch { showToast('Image upload failed.','error'); return; }
    }
    const manualStatus=selectedStatus!=='online'?selectedStatus:null;
    await updateDoc(doc(db,'users',currentUser.uid),{displayName,bio,avatarUrl,status:selectedStatus,manualStatus});
    currentProfile={...currentProfile,displayName,bio,avatarUrl,status:selectedStatus,manualStatus};
    updateSidebarUser(); closeModal('profileModal'); showToast('Profile updated! ‚ú®','success');
  };

  // ‚îÄ‚îÄ SERVERS ‚îÄ‚îÄ
  async function loadServers() {
    const snap=await getDocs(query(collection(db,'servers'),where('ownerId','==',currentUser.uid)));
    const bar=document.getElementById('servers-bar');
    bar.querySelectorAll('.server-icon.user-server').forEach(e=>e.remove());
    const before=bar.querySelector('.server-icon.add');
    snap.docs.forEach(d=>{
      const data={ id:d.id, ...d.data() }; const icon=document.createElement('div'); icon.className='server-icon user-server';
      icon.style.cssText=`background:${color(data.name)};color:#fff`; icon.title=data.name;
      icon.innerHTML=`<span class="server-pip"></span>${data.name[0].toUpperCase()}`;
      icon.onclick=()=>{ document.querySelectorAll('.server-icon').forEach(i=>i.classList.remove('active')); icon.classList.add('active'); showServerView(data); };
      bar.insertBefore(icon,before);
    });
  }
  window.createServer = async function() {
    const name=document.getElementById('server-name-input').value.trim();
    if (!name) { showToast('Please enter a server name.','error'); return; }
    const serverRef = await addDoc(collection(db,'servers'),{
  name,
  ownerId: currentUser.uid,
  iconURL:"",
  createdAt: serverTimestamp()
});

await addDoc(collection(db,"servers",serverRef.id,"channels"),{
 name:"general",
 createdAt:serverTimestamp()
});

await setDoc(doc(db,"servers",serverRef.id,"members",currentUser.uid),{
 role:"owner",
 joinedAt:serverTimestamp()
});
    document.getElementById('server-name-input').value=''; closeModal('createServerModal'); showToast(`Server "${name}" created! üéâ`,'success'); await loadServers();
  };
  let activeServer=null;
let activeChannel=null;

function showServerView(server){
 activeServer=server;
 document.getElementById('main-header').innerHTML=`<span>#</span><h2>${server.name}</h2>`;
 loadChannels(server.id);
}</h2>`;
    const c=document.getElementById('main-content'); c.style.padding='24px';
    c.innerHTML=`<div class="empty-state"><div class="empty-icon">üè∞</div><h3>${server.name}</h3><p>Your server is ready! Full channel features coming soon.</p></div>`;
  }

  
async function loadChannels(serverId){
 const content=document.getElementById('main-content');
 content.style.padding="0";
 content.innerHTML=`<div id="channel-list"></div><div id="chat-area"></div>`;
 const list=document.getElementById('channel-list');

 onSnapshot(collection(db,"servers",serverId,"channels"),snap=>{
  list.innerHTML="";
  snap.forEach(docu=>{
   const ch={id:docu.id,...docu.data()};
   const el=document.createElement("div");
   el.className="sidebar-item";
   el.textContent="# "+ch.name;
   el.onclick=()=>openChannel(ch);
   list.appendChild(el);
  });
 });
}

function openChannel(channel){
 activeChannel=channel;
 const chat=document.getElementById("chat-area");
 chat.innerHTML=`<div id="messages"></div><input id="msgBox" placeholder="Message #${channel.name}" />`;

 const box=document.getElementById("msgBox");

 box.onkeydown=async e=>{
  if(e.key==="Enter" && box.value.trim()){
   await addDoc(collection(db,"servers",activeServer.id,"messages"),{
    text:box.value,
    sender:currentUser.uid,
    channelId:channel.id,
    timestamp:serverTimestamp()
   });
   box.value="";
  }
 };

 onSnapshot(
  query(
   collection(db,"servers",activeServer.id,"messages"),
   where("channelId","==",channel.id),
   orderBy("timestamp")
  ),
  snap=>{
   const msgDiv=document.getElementById("messages");
   msgDiv.innerHTML="";
   snap.forEach(d=>{
    const m=d.data();
    const el=document.createElement("div");
    el.textContent=m.text;
    msgDiv.appendChild(el);
   });
  }
 );
}

// ‚îÄ‚îÄ CALL ‚îÄ‚îÄ
  window.startCall = function(friend) {
    const name=friend.displayName||friend.username;
    const av=document.getElementById('call-avatar'); av.style.background=color(friend.username);
    av.innerHTML=friend.avatarUrl?`<img src="${friend.avatarUrl}" style="width:100%;height:100%;object-fit:cover;border-radius:50%"/>`:name[0].toUpperCase();
    document.getElementById('call-name').textContent=name; document.getElementById('call-status').textContent='Calling...';
    openModal('callModal'); setTimeout(()=>{ const s=document.getElementById('call-status'); if(s) s.textContent='Ringing... (demo mode)'; },2000);
  };
  window.endCall=()=>{ closeModal('callModal'); showToast('Call ended.',''); };

  // ‚îÄ‚îÄ SIGN OUT ‚îÄ‚îÄ
  window.handleSignOut = async function() {
    try { await updateDoc(doc(db,'users',currentUser.uid),{status:'offline'}); } catch(e){}
    await signOut(auth); window.location.href='index.html';
  };

  // ‚îÄ‚îÄ NAV ‚îÄ‚îÄ
  window.showView = function() {
    document.querySelectorAll('.server-icon').forEach(i=>i.classList.remove('active'));
    document.querySelector('.server-icon.home').classList.add('active');
    document.getElementById('profile-panel').classList.add('hidden');
    document.getElementById('main-content').style.padding='24px';
    document.getElementById('main-header').innerHTML=`<span>üë•</span><h2>Friends</h2><div class="header-tabs"><button class="tab active" onclick="switchTab(this,'online')">Online</button><button class="tab" onclick="switchTab(this,'all')">All</button><button class="tab" onclick="switchTab(this,'pending')">Pending <span id="pending-count" style="display:none" class="pending-badge">0</span></button></div><button class="add-friend-btn" onclick="openModal('addFriendModal')">+ Add Friend</button>`;
    renderFriendsView(window._friends||[]);
  };
  window.switchTab = function(btn,tab) { document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active')); btn.classList.add('active'); if(tab==='pending') renderPendingView(); else renderFriendsView(window._friends||[]); };
  window.selectServerType = card => { document.querySelectorAll('.server-type-card').forEach(c=>c.classList.remove('selected')); card.classList.add('selected'); };

  // ‚îÄ‚îÄ UTILS ‚îÄ‚îÄ
  function color(str) {
    if (!str) return '#5b6af0';
    let h=0; for(let i=0;i<str.length;i++) h=str.charCodeAt(i)+((h<<5)-h);
    return ['#5b6af0','#e040fb','#00bcd4','#ff7043','#66bb6a','#ffa726','#ab47bc','#26c6da'][Math.abs(h)%8];
  }
  function esc(t) { return String(t).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
  function sj(obj) { return "JSON.parse('"+JSON.stringify(obj).replace(/\\/g,'\\\\').replace(/'/g,"\\'")+"')"; }
  function fmtSize(b) { if(b<1024) return b+' B'; if(b<1048576) return (b/1024).toFixed(1)+' KB'; return (b/1048576).toFixed(1)+' MB'; }
  function fileIcon(name) { const e=(name||'').split('.').pop().toLowerCase(); return {pdf:'üìÑ',doc:'üìù',docx:'üìù',txt:'üìÑ',zip:'üóúÔ∏è',rar:'üóúÔ∏è',mp3:'üéµ',wav:'üéµ',mp4:'üé¨',mov:'üé¨'}[e]||'üìÅ'; }
  function showToast(msg,type) { const t=document.getElementById('toast'); t.textContent=msg; t.className=`toast ${type} show`; setTimeout(()=>{t.className='toast';},3500); }
  window.showToast=showToast;
</script>

<script>
  function openModal(id) { document.getElementById(id).classList.add('open'); }
  function closeModal(id) { document.getElementById(id).classList.remove('open'); }
  document.querySelectorAll('.modal-overlay').forEach(o => { o.addEventListener('click', e => { if(e.target===o) o.classList.remove('open'); }); });
  document.addEventListener('keydown', e => { if(e.key==='Escape') document.querySelectorAll('.modal-overlay.open').forEach(m=>m.classList.remove('open')); });
</script>
</body>
</html>
