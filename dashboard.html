<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Nexus ‚Äî Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet"/>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --bg: #0b0c10;
      --surface: #13151c;
      --surface2: #1c1f2b;
      --surface3: #242838;
      --accent: #5b6af0;
      --accent2: #e040fb;
      --text: #eaedf8;
      --muted: #7c80a0;
      --border: rgba(255,255,255,0.07);
      --glow: rgba(91,106,240,0.3);
      --error: #ff5f57;
      --success: #28c840;
      --online: #23d18b;
    }
    html, body { height: 100%; overflow: hidden; }
    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'DM Sans', sans-serif;
      display: flex;
    }

    /* ‚îÄ‚îÄ SERVERS SIDEBAR ‚îÄ‚îÄ */
    .servers-bar {
      width: 72px;
      background: #080a0f;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 12px 0;
      gap: 8px;
      border-right: 1px solid var(--border);
      flex-shrink: 0;
      overflow-y: auto;
    }
    .server-icon {
      width: 48px; height: 48px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; font-size: 1.2rem; font-weight: 700;
      transition: border-radius 0.2s, background 0.2s;
      position: relative; flex-shrink: 0;
    }
    .server-icon:hover, .server-icon.active { border-radius: 16px; }
    .server-icon.home { background: var(--accent); color: #fff; font-size: 1.3rem; }
    .server-icon.home:hover, .server-icon.home.active { background: #4a59e0; }
    .server-icon.add {
      background: var(--surface2);
      color: var(--success);
      font-size: 1.5rem;
      border-radius: 50%;
    }
    .server-icon.add:hover { background: var(--success); color: #fff; border-radius: 16px; }
    .server-divider { width: 32px; height: 2px; background: var(--border); border-radius: 1px; margin: 4px 0; }
    .server-pip {
      position: absolute; left: -4px; top: 50%; transform: translateY(-50%);
      width: 4px; border-radius: 0 2px 2px 0;
      background: var(--text); transition: height 0.2s;
    }
    .server-icon:hover .server-pip { height: 20px; }
    .server-icon.active .server-pip { height: 36px; }

    /* ‚îÄ‚îÄ CHANNEL / FRIENDS SIDEBAR ‚îÄ‚îÄ */
    .sidebar {
      width: 240px;
      background: var(--surface);
      display: flex; flex-direction: column;
      border-right: 1px solid var(--border);
      flex-shrink: 0;
    }
    .sidebar-header {
      padding: 16px;
      border-bottom: 1px solid var(--border);
      font-family: 'Syne', sans-serif;
      font-weight: 700; font-size: 0.95rem;
    }
    .sidebar-search {
      padding: 8px 12px;
    }
    .sidebar-search input {
      width: 100%;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 7px 10px;
      color: var(--text);
      font-family: 'DM Sans', sans-serif;
      font-size: 0.82rem;
      outline: none;
    }
    .sidebar-search input::placeholder { color: var(--muted); }
    .sidebar-section-label {
      padding: 12px 12px 4px;
      font-size: 0.7rem; font-weight: 700;
      letter-spacing: 0.08em; color: var(--muted);
      text-transform: uppercase;
      display: flex; align-items: center; justify-content: space-between;
    }
    .sidebar-section-label span { cursor: pointer; font-size: 1rem; opacity: 0.6; transition: opacity 0.2s; }
    .sidebar-section-label span:hover { opacity: 1; }
    .sidebar-item {
      display: flex; align-items: center; gap: 10px;
      padding: 7px 12px;
      border-radius: 6px; margin: 1px 8px;
      cursor: pointer; transition: background 0.15s;
      font-size: 0.88rem; color: var(--muted);
    }
    .sidebar-item:hover { background: var(--surface2); color: var(--text); }
    .sidebar-item.active { background: var(--surface3); color: var(--text); }
    .sidebar-item .item-avatar {
      width: 32px; height: 32px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 0.78rem; font-weight: 700; flex-shrink: 0;
      position: relative;
    }
    .status-dot {
      position: absolute; bottom: -1px; right: -1px;
      width: 10px; height: 10px; border-radius: 50%;
      border: 2px solid var(--surface);
    }
    .status-dot.online { background: var(--online); }
    .status-dot.offline { background: var(--muted); }

    /* User panel at bottom of sidebar */
    .user-panel {
      margin-top: auto;
      padding: 10px 8px;
      border-top: 1px solid var(--border);
      display: flex; align-items: center; gap: 8px;
      cursor: pointer;
      border-radius: 8px;
      transition: background 0.15s;
    }
    .user-panel:hover { background: var(--surface2); }
    .user-panel-avatar {
      width: 36px; height: 36px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-weight: 700; font-size: 0.9rem; color: #fff;
      flex-shrink: 0; overflow: hidden; position: relative;
    }
    .user-panel-avatar img { width: 100%; height: 100%; object-fit: cover; }
    .user-panel-info { flex: 1; min-width: 0; }
    .user-panel-name { font-size: 0.85rem; font-weight: 600; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .user-panel-tag { font-size: 0.72rem; color: var(--muted); }
    .user-panel-actions { display: flex; gap: 4px; }
    .icon-btn {
      width: 28px; height: 28px; border-radius: 6px;
      background: none; border: none; color: var(--muted);
      cursor: pointer; display: flex; align-items: center; justify-content: center;
      font-size: 1rem; transition: background 0.15s, color 0.15s;
    }
    .icon-btn:hover { background: var(--surface3); color: var(--text); }

    /* ‚îÄ‚îÄ MAIN CONTENT ‚îÄ‚îÄ */
    .main {
      flex: 1; display: flex; flex-direction: column;
      overflow: hidden;
    }
    .main-header {
      padding: 0 20px;
      height: 52px;
      border-bottom: 1px solid var(--border);
      display: flex; align-items: center; gap: 12px;
      flex-shrink: 0;
    }
    .main-header h2 {
      font-family: 'Syne', sans-serif;
      font-weight: 700; font-size: 1rem;
    }
    .main-header .header-tabs {
      display: flex; gap: 4px; margin-left: 20px;
    }
    .tab {
      padding: 5px 14px; border-radius: 6px;
      font-size: 0.85rem; font-weight: 500;
      cursor: pointer; color: var(--muted);
      transition: background 0.15s, color 0.15s;
      border: none; background: none;
      font-family: 'DM Sans', sans-serif;
    }
    .tab:hover { background: var(--surface2); color: var(--text); }
    .tab.active { background: var(--surface2); color: var(--text); }
    .add-friend-btn {
      margin-left: auto;
      padding: 6px 16px;
      background: var(--success);
      color: #fff; border: none; border-radius: 6px;
      font-family: 'DM Sans', sans-serif;
      font-size: 0.82rem; font-weight: 600;
      cursor: pointer; transition: background 0.2s;
    }
    .add-friend-btn:hover { background: #1db97a; }

    .main-content {
      flex: 1; overflow-y: auto; padding: 24px;
    }

    /* Friends view */
    .friends-list { display: flex; flex-direction: column; gap: 2px; }
    .friend-row {
      display: flex; align-items: center; gap: 14px;
      padding: 12px 16px; border-radius: 10px;
      cursor: pointer; transition: background 0.15s;
      border-bottom: 1px solid var(--border);
    }
    .friend-row:hover { background: var(--surface2); }
    .friend-avatar {
      width: 40px; height: 40px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-weight: 700; font-size: 0.95rem; color: #fff;
      flex-shrink: 0; position: relative; overflow: hidden;
    }
    .friend-avatar img { width: 100%; height: 100%; object-fit: cover; }
    .friend-info { flex: 1; }
    .friend-name { font-weight: 600; font-size: 0.92rem; }
    .friend-status { font-size: 0.78rem; color: var(--muted); margin-top: 1px; }
    .friend-actions { display: flex; gap: 8px; }
    .friend-btn {
      width: 36px; height: 36px; border-radius: 50%;
      background: var(--surface2); border: none;
      color: var(--muted); cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      font-size: 1rem; transition: background 0.15s, color 0.15s;
    }
    .friend-btn:hover { background: var(--surface3); color: var(--text); }

    /* Add friend panel */
    .add-friend-panel {
      max-width: 680px;
    }
    .add-friend-panel h3 {
      font-family: 'Syne', sans-serif;
      font-weight: 700; font-size: 1.1rem; margin-bottom: 6px;
    }
    .add-friend-panel p { color: var(--muted); font-size: 0.88rem; margin-bottom: 20px; }
    .add-friend-input-row {
      display: flex; gap: 0;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 10px; overflow: hidden;
      transition: border-color 0.2s;
    }
    .add-friend-input-row:focus-within { border-color: var(--accent); }
    .add-friend-input-row input {
      flex: 1; background: none; border: none;
      padding: 14px 16px; color: var(--text);
      font-family: 'DM Sans', sans-serif; font-size: 0.95rem;
      outline: none;
    }
    .add-friend-input-row input::placeholder { color: var(--muted); }
    .add-friend-input-row button {
      padding: 10px 20px; background: var(--accent);
      color: #fff; border: none; font-family: 'DM Sans', sans-serif;
      font-size: 0.88rem; font-weight: 600; cursor: pointer;
      margin: 6px; border-radius: 6px; transition: background 0.2s;
    }
    .add-friend-input-row button:hover { background: #6b7af8; }
    .add-result { margin-top: 16px; font-size: 0.88rem; padding: 10px 14px; border-radius: 8px; display: none; }
    .add-result.success { background: rgba(35,209,139,0.1); color: var(--success); border: 1px solid rgba(35,209,139,0.2); display: block; }
    .add-result.error { background: rgba(255,95,87,0.1); color: var(--error); border: 1px solid rgba(255,95,87,0.2); display: block; }

    /* DM / Chat view */
    .chat-view {
      display: flex; flex-direction: column; height: 100%;
    }
    .chat-messages {
      flex: 1; overflow-y: auto;
      padding: 20px 24px;
      display: flex; flex-direction: column; gap: 16px;
    }
    .chat-msg { display: flex; gap: 14px; }
    .chat-msg-avatar {
      width: 40px; height: 40px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-weight: 700; font-size: 0.9rem; color: #fff;
      flex-shrink: 0; overflow: hidden;
    }
    .chat-msg-avatar img { width: 100%; height: 100%; object-fit: cover; }
    .chat-msg-body { flex: 1; }
    .chat-msg-header { display: flex; align-items: baseline; gap: 10px; margin-bottom: 4px; }
    .chat-msg-name { font-weight: 600; font-size: 0.9rem; }
    .chat-msg-time { font-size: 0.72rem; color: var(--muted); }
    .chat-msg-text { font-size: 0.9rem; color: #c8cce0; line-height: 1.55; }
    .chat-input-area {
      padding: 0 24px 20px;
      flex-shrink: 0;
    }
    .chat-input-box {
      display: flex; align-items: center; gap: 12px;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 0 16px;
      transition: border-color 0.2s;
    }
    .chat-input-box:focus-within { border-color: rgba(91,106,240,0.4); }
    .chat-input-box input {
      flex: 1; background: none; border: none;
      padding: 14px 0; color: var(--text);
      font-family: 'DM Sans', sans-serif; font-size: 0.92rem;
      outline: none;
    }
    .chat-input-box input::placeholder { color: var(--muted); }
    .chat-send-btn {
      background: none; border: none; color: var(--muted);
      cursor: pointer; font-size: 1.1rem;
      transition: color 0.2s;
    }
    .chat-send-btn:hover { color: var(--accent); }

    /* Empty / welcome state */
    .empty-state {
      display: flex; flex-direction: column; align-items: center;
      justify-content: center; height: 100%;
      text-align: center; gap: 16px;
    }
    .empty-state .empty-icon { font-size: 4rem; }
    .empty-state h3 { font-family: 'Syne', sans-serif; font-weight: 700; font-size: 1.3rem; }
    .empty-state p { color: var(--muted); font-size: 0.9rem; max-width: 320px; line-height: 1.6; }

    /* ‚îÄ‚îÄ MODALS ‚îÄ‚îÄ */
    .modal-overlay {
      position: fixed; inset: 0; z-index: 999;
      background: rgba(0,0,0,0.75); backdrop-filter: blur(8px);
      display: flex; align-items: center; justify-content: center;
      opacity: 0; pointer-events: none; transition: opacity 0.2s;
    }
    .modal-overlay.open { opacity: 1; pointer-events: all; }
    .modal {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 20px; padding: 40px 36px;
      width: 100%; max-width: 460px; position: relative;
      transform: translateY(16px); transition: transform 0.2s;
    }
    .modal-overlay.open .modal { transform: translateY(0); }
    .modal-close { position: absolute; top: 16px; right: 18px; background: none; border: none; color: var(--muted); font-size: 1.4rem; cursor: pointer; }
    .modal-close:hover { color: var(--text); }
    .modal h2 { font-family: 'Syne', sans-serif; font-weight: 700; font-size: 1.4rem; margin-bottom: 6px; }
    .modal > p { color: var(--muted); font-size: 0.88rem; margin-bottom: 28px; }
    .form-group { display: flex; flex-direction: column; gap: 6px; margin-bottom: 18px; }
    .form-group label { font-size: 0.78rem; font-weight: 700; color: var(--muted); letter-spacing: 0.06em; text-transform: uppercase; }
    .form-group input, .form-group select {
      background: var(--surface2); border: 1px solid var(--border);
      border-radius: 8px; padding: 11px 14px;
      color: var(--text); font-family: 'DM Sans', sans-serif;
      font-size: 0.92rem; outline: none; transition: border-color 0.2s;
    }
    .form-group input:focus { border-color: var(--accent); }
    .form-group input::placeholder { color: #4a4f6a; }
    .modal-btn {
      width: 100%; padding: 13px;
      background: var(--accent); color: #fff; border: none;
      border-radius: 8px; font-family: 'DM Sans', sans-serif;
      font-size: 0.92rem; font-weight: 600; cursor: pointer;
      transition: background 0.2s; box-shadow: 0 0 20px var(--glow);
    }
    .modal-btn:hover { background: #6b7af8; }
    .modal-btn.danger { background: var(--error); box-shadow: none; }
    .modal-btn.danger:hover { background: #e04040; }
    .modal-btn-row { display: flex; gap: 10px; }
    .modal-btn-row .modal-btn { flex: 1; }
    .modal-btn.secondary { background: var(--surface2); color: var(--text); box-shadow: none; }
    .modal-btn.secondary:hover { background: var(--surface3); }

    /* Avatar upload */
    .avatar-upload-area {
      display: flex; align-items: center; gap: 20px; margin-bottom: 24px;
    }
    .avatar-preview {
      width: 80px; height: 80px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-weight: 700; font-size: 1.8rem; color: #fff;
      flex-shrink: 0; overflow: hidden;
      border: 3px solid var(--border);
    }
    .avatar-preview img { width: 100%; height: 100%; object-fit: cover; }
    .avatar-upload-btn {
      display: flex; flex-direction: column; gap: 6px;
    }
    .avatar-upload-btn button {
      padding: 8px 16px; border-radius: 8px;
      font-family: 'DM Sans', sans-serif; font-size: 0.82rem; font-weight: 600;
      cursor: pointer; transition: all 0.2s; border: none;
    }
    .upload-btn { background: var(--accent); color: #fff; }
    .upload-btn:hover { background: #6b7af8; }
    .remove-btn { background: var(--surface2); color: var(--muted); }
    .remove-btn:hover { background: var(--surface3); color: var(--error); }
    .avatar-upload-btn p { font-size: 0.75rem; color: var(--muted); }

    /* Server create modal */
    .server-type-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
    .server-type-card {
      background: var(--surface2); border: 2px solid var(--border);
      border-radius: 10px; padding: 16px; cursor: pointer;
      transition: all 0.2s; text-align: center;
    }
    .server-type-card:hover, .server-type-card.selected { border-color: var(--accent); background: rgba(91,106,240,0.08); }
    .server-type-card .type-icon { font-size: 1.8rem; margin-bottom: 8px; }
    .server-type-card .type-name { font-size: 0.82rem; font-weight: 600; }

    /* Call modal */
    .call-display {
      text-align: center; padding: 20px 0;
    }
    .call-avatar {
      width: 90px; height: 90px; border-radius: 50%;
      margin: 0 auto 16px;
      display: flex; align-items: center; justify-content: center;
      font-size: 2.2rem; font-weight: 700; color: #fff;
      overflow: hidden;
      animation: callPulse 2s infinite;
    }
    .call-avatar img { width: 100%; height: 100%; object-fit: cover; }
    @keyframes callPulse {
      0%, 100% { box-shadow: 0 0 0 0 rgba(91,106,240,0.4); }
      50% { box-shadow: 0 0 0 16px rgba(91,106,240,0); }
    }
    .call-name { font-family: 'Syne', sans-serif; font-weight: 700; font-size: 1.3rem; margin-bottom: 6px; }
    .call-status { color: var(--muted); font-size: 0.88rem; margin-bottom: 28px; }
    .call-actions { display: flex; justify-content: center; gap: 20px; }
    .call-action-btn {
      width: 56px; height: 56px; border-radius: 50%;
      border: none; cursor: pointer; font-size: 1.3rem;
      display: flex; align-items: center; justify-content: center;
      transition: transform 0.15s;
    }
    .call-action-btn:hover { transform: scale(1.1); }
    .call-action-btn.end { background: var(--error); color: #fff; }
    .call-action-btn.mute { background: var(--surface2); color: var(--text); }
    .call-action-btn.video { background: var(--surface2); color: var(--text); }

    /* Toast notification */
    .toast {
      position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%) translateY(20px);
      background: var(--surface2); border: 1px solid var(--border);
      border-radius: 10px; padding: 12px 20px;
      font-size: 0.88rem; color: var(--text);
      z-index: 9999; opacity: 0;
      transition: all 0.3s; pointer-events: none;
      white-space: nowrap;
    }
    .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
    .toast.success { border-color: rgba(35,209,139,0.3); color: var(--success); }
    .toast.error { border-color: rgba(255,95,87,0.3); color: var(--error); }

    /* Scrollbar styling */
    ::-webkit-scrollbar { width: 4px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--surface3); border-radius: 2px; }

    .pending-badge {
      background: var(--error); color: #fff;
      font-size: 0.65rem; font-weight: 700;
      border-radius: 10px; padding: 1px 6px;
      margin-left: auto;
    }

    /* incoming friend request item */
    .request-row {
      display: flex; align-items: center; gap: 12px;
      padding: 12px 16px; border-radius: 10px;
      border-bottom: 1px solid var(--border);
    }
    .request-row .request-actions { margin-left: auto; display: flex; gap: 8px; }
    .req-btn {
      padding: 6px 14px; border-radius: 6px;
      font-family: 'DM Sans', sans-serif; font-size: 0.8rem; font-weight: 600;
      cursor: pointer; border: none; transition: all 0.15s;
    }
    .req-btn.accept { background: var(--success); color: #fff; }
    .req-btn.accept:hover { background: #1db97a; }
    .req-btn.decline { background: var(--surface2); color: var(--muted); }
    .req-btn.decline:hover { background: var(--surface3); color: var(--error); }
  </style>
</head>
<body>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<!-- CREATE SERVER MODAL -->
<div class="modal-overlay" id="createServerModal">
  <div class="modal">
    <button class="modal-close" onclick="closeModal('createServerModal')">√ó</button>
    <h2>Create a Server</h2>
    <p>Give your community a home. You can always change this later.</p>
    <div class="server-type-grid">
      <div class="server-type-card selected" onclick="selectServerType(this)">
        <div class="type-icon">üéÆ</div>
        <div class="type-name">Gaming</div>
      </div>
      <div class="server-type-card" onclick="selectServerType(this)">
        <div class="type-icon">üé®</div>
        <div class="type-name">Creative</div>
      </div>
      <div class="server-type-card" onclick="selectServerType(this)">
        <div class="type-icon">üìö</div>
        <div class="type-name">Education</div>
      </div>
      <div class="server-type-card" onclick="selectServerType(this)">
        <div class="type-icon">üí¨</div>
        <div class="type-name">Community</div>
      </div>
    </div>
    <div class="form-group">
      <label>Server Name</label>
      <input type="text" id="server-name-input" placeholder="My awesome server" />
    </div>
    <button class="modal-btn" onclick="createServer()">Create Server</button>
  </div>
</div>

<!-- PROFILE EDIT MODAL -->
<div class="modal-overlay" id="profileModal">
  <div class="modal">
    <button class="modal-close" onclick="closeModal('profileModal')">√ó</button>
    <h2>Edit Profile</h2>
    <p>Customize how others see you on Nexus.</p>
    <div class="avatar-upload-area">
      <div class="avatar-preview" id="profile-avatar-preview"></div>
      <div class="avatar-upload-btn">
        <button class="upload-btn" onclick="document.getElementById('avatar-file-input').click()">Upload Photo</button>
        <button class="remove-btn" onclick="removeAvatar()">Remove</button>
        <p>JPG, PNG or GIF ¬∑ Max 8MB</p>
      </div>
    </div>
    <input type="file" id="avatar-file-input" accept="image/*" style="display:none" onchange="handleAvatarUpload(event)"/>
    <div class="form-group">
      <label>Display Name</label>
      <input type="text" id="display-name-input" placeholder="Your display name" />
    </div>
    <div class="form-group">
      <label>Username (cannot be changed)</label>
      <input type="text" id="username-readonly" disabled style="opacity:0.5;cursor:not-allowed;" />
    </div>
    <div class="modal-btn-row">
      <button class="modal-btn secondary" onclick="closeModal('profileModal')">Cancel</button>
      <button class="modal-btn" onclick="saveProfile()">Save Changes</button>
    </div>
  </div>
</div>

<!-- CALL MODAL -->
<div class="modal-overlay" id="callModal">
  <div class="modal" style="max-width:340px; text-align:center;">
    <div class="call-display">
      <div class="call-avatar" id="call-avatar"></div>
      <div class="call-name" id="call-name"></div>
      <div class="call-status" id="call-status">Calling...</div>
      <div class="call-actions">
        <button class="call-action-btn mute" title="Mute">üé§</button>
        <button class="call-action-btn end" onclick="endCall()" title="End call">üìµ</button>
        <button class="call-action-btn video" title="Video">üì∑</button>
      </div>
    </div>
  </div>
</div>

<!-- ADD FRIEND MODAL (quick) -->
<div class="modal-overlay" id="addFriendModal">
  <div class="modal">
    <button class="modal-close" onclick="closeModal('addFriendModal')">√ó</button>
    <h2>Add Friend</h2>
    <p>You can add friends with their Nexus username.</p>
    <div class="form-group">
      <label>Username</label>
      <input type="text" id="add-friend-input-modal" placeholder="Enter a username e.g. cool_user" />
    </div>
    <div class="add-result" id="add-friend-result-modal"></div>
    <button class="modal-btn" onclick="sendFriendRequest()">Send Friend Request</button>
  </div>
</div>

<!-- LAYOUT -->
<!-- Servers bar -->
<div class="servers-bar" id="servers-bar">
  <div class="server-icon home active" onclick="showView('friends')" title="Home">
    <span class="server-pip" style="height:36px"></span>
    ‚åÇ
  </div>
  <div class="server-divider"></div>
  <div class="server-icon add" onclick="openModal('createServerModal')" title="Create Server">+</div>
</div>

<!-- Left sidebar -->
<div class="sidebar">
  <div class="sidebar-header">
    <div style="display:flex;align-items:center;gap:8px;">
      <span>üí¨</span> Direct Messages
    </div>
  </div>
  <div class="sidebar-search">
    <input type="text" placeholder="Find a conversation..." />
  </div>

  <div class="sidebar-section-label">
    Friends <span onclick="openModal('addFriendModal')" title="Add Friend">+</span>
  </div>
  <div id="dm-list">
    <!-- populated by JS -->
  </div>

  <!-- User panel -->
  <div class="user-panel" onclick="openProfileModal()">
    <div class="user-panel-avatar" id="sidebar-avatar"></div>
    <div class="user-panel-info">
      <div class="user-panel-name" id="sidebar-display-name">Loading...</div>
      <div class="user-panel-tag" id="sidebar-username">@...</div>
    </div>
    <div class="user-panel-actions">
      <button class="icon-btn" title="Settings" onclick="event.stopPropagation();openProfileModal()">‚öôÔ∏è</button>
      <button class="icon-btn" title="Sign Out" onclick="event.stopPropagation();handleSignOut()">üö™</button>
    </div>
  </div>
</div>

<!-- Main area -->
<div class="main">
  <div class="main-header" id="main-header">
    <span>üë•</span>
    <h2>Friends</h2>
    <div class="header-tabs">
      <button class="tab active" onclick="switchTab(this,'online')">Online</button>
      <button class="tab" onclick="switchTab(this,'all')">All</button>
      <button class="tab" onclick="switchTab(this,'pending')">Pending <span id="pending-count" style="display:none;" class="pending-badge">0</span></button>
    </div>
    <button class="add-friend-btn" onclick="openModal('addFriendModal')">+ Add Friend</button>
  </div>
  <div class="main-content" id="main-content">
    <div class="empty-state">
      <div class="empty-icon">üëã</div>
      <h3>Welcome to Nexus!</h3>
      <p>Add some friends to get started. Click "Add Friend" above or search for someone by username.</p>
    </div>
  </div>
</div>

<!-- FIREBASE -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, query, where, getDocs, addDoc, onSnapshot, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";
  // Cloudinary config (no Firebase Storage needed)
  const CLOUDINARY_CLOUD = 'dskssf3tn';
  const CLOUDINARY_PRESET = 'nexus_avatars';

  const firebaseConfig = {
    apiKey: "AIzaSyDKGqss5jcCNd_AYYohYs-KaSKvZUemX-4",
    authDomain: "nexus-app-74493.firebaseapp.com",
    projectId: "nexus-app-74493",
    storageBucket: "nexus-app-74493.firebasestorage.app",
    messagingSenderId: "179885556901",
    appId: "1:179885556901:web:1966afe8102de60d9cb94c",
    measurementId: "G-LP2YGN7S4B"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);


  // Global state
  let currentUser = null;
  let currentProfile = null;
  let pendingAvatarDataUrl = null;
  let currentDmFriend = null;
  let dmUnsubscribe = null;
  let servers = [];

  // ‚îÄ‚îÄ AUTH GUARD ‚îÄ‚îÄ
  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      window.location.href = 'index.html';
      return;
    }
    currentUser = user;
    await loadProfile();
    await loadFriends();
    await loadServers();
  });

  async function loadProfile() {
    const snap = await getDoc(doc(db, 'users', currentUser.uid));
    if (snap.exists()) {
      currentProfile = snap.data();
    } else {
      currentProfile = { username: currentUser.email, displayName: '', avatarUrl: '' };
    }
    updateSidebarUser();
  }

  function updateSidebarUser() {
    const displayName = currentProfile.displayName || currentProfile.username;
    const username = currentProfile.username;

    document.getElementById('sidebar-display-name').textContent = displayName;
    document.getElementById('sidebar-username').textContent = '@' + username;

    const av = document.getElementById('sidebar-avatar');
    if (currentProfile.avatarUrl) {
      av.innerHTML = `<img src="${currentProfile.avatarUrl}" alt="avatar"/>`;
      av.style.background = '';
    } else {
      av.innerHTML = displayName[0].toUpperCase();
      av.style.background = 'linear-gradient(135deg,#5b6af0,#e040fb)';
    }
  }

  // ‚îÄ‚îÄ LOAD FRIENDS ‚îÄ‚îÄ
  async function loadFriends() {
    const friendsSnap = await getDocs(query(
      collection(db, 'friendships'),
      where('users', 'array-contains', currentUser.uid),
      where('status', '==', 'accepted')
    ));

    const friends = [];
    for (const d of friendsSnap.docs) {
      const data = d.data();
      const friendId = data.users.find(id => id !== currentUser.uid);
      const friendSnap = await getDoc(doc(db, 'users', friendId));
      if (friendSnap.exists()) {
        friends.push({ id: friendId, ...friendSnap.data() });
      }
    }

    window._friends = friends;
    renderDmList(friends);
    renderFriendsView(friends, 'online');
    await loadPendingRequests();
  }

  function renderDmList(friends) {
    const list = document.getElementById('dm-list');
    list.innerHTML = '';
    if (!friends.length) {
      list.innerHTML = '<div style="padding:8px 16px;font-size:0.78rem;color:var(--muted)">No friends yet</div>';
      return;
    }
    friends.forEach(f => {
      const displayName = f.displayName || f.username;
      const div = document.createElement('div');
      div.className = 'sidebar-item';
      div.innerHTML = `
        <div class="item-avatar" style="background:${stringToColor(f.username)}">
          ${f.avatarUrl ? `<img src="${f.avatarUrl}" style="width:100%;height:100%;object-fit:cover;border-radius:50%"/>` : displayName[0].toUpperCase()}
          <span class="status-dot offline"></span>
        </div>
        <span>${displayName}</span>
      `;
      div.onclick = () => openDm(f);
      list.appendChild(div);
    });
  }

  function renderFriendsView(friends, tab) {
    const content = document.getElementById('main-content');
    if (!friends.length) {
      content.innerHTML = `<div class="empty-state"><div class="empty-icon">ü§ù</div><h3>No friends yet</h3><p>Add friends by clicking "+ Add Friend" and entering their username.</p></div>`;
      return;
    }
    content.innerHTML = `<div class="friends-list" id="friends-list-container"></div>`;
    const container = document.getElementById('friends-list-container');
    friends.forEach(f => {
      const displayName = f.displayName || f.username;
      const row = document.createElement('div');
      row.className = 'friend-row';
      row.innerHTML = `
        <div class="friend-avatar" style="background:${stringToColor(f.username)}">
          ${f.avatarUrl ? `<img src="${f.avatarUrl}"/>` : displayName[0].toUpperCase()}
          <span class="status-dot offline" style="position:absolute;bottom:0;right:0;border-color:var(--bg)"></span>
        </div>
        <div class="friend-info">
          <div class="friend-name">${displayName}</div>
          <div class="friend-status">@${f.username} ¬∑ Offline</div>
        </div>
        <div class="friend-actions">
          <button class="friend-btn" title="Message" onclick="openDm(${JSON.stringify(f).replace(/"/g,'&quot;')})">üí¨</button>
          <button class="friend-btn" title="Voice Call" onclick="startCall(${JSON.stringify(f).replace(/"/g,'&quot;')})">üìû</button>
        </div>
      `;
      container.appendChild(row);
    });
  }

  // ‚îÄ‚îÄ PENDING FRIEND REQUESTS ‚îÄ‚îÄ
  async function loadPendingRequests() {
    const snap = await getDocs(query(
      collection(db, 'friendships'),
      where('to', '==', currentUser.uid),
      where('status', '==', 'pending')
    ));
    const count = snap.size;
    const badge = document.getElementById('pending-count');
    if (count > 0) {
      badge.textContent = count;
      badge.style.display = 'inline';
      window._pendingRequests = [];
      for (const d of snap.docs) {
        const fromSnap = await getDoc(doc(db, 'users', d.data().from));
        if (fromSnap.exists()) {
          window._pendingRequests.push({ docId: d.id, ...fromSnap.data(), fromUid: d.data().from });
        }
      }
    } else {
      badge.style.display = 'none';
      window._pendingRequests = [];
    }
  }

  function renderPendingView() {
    const content = document.getElementById('main-content');
    const reqs = window._pendingRequests || [];
    if (!reqs.length) {
      content.innerHTML = `<div class="empty-state"><div class="empty-icon">üì≠</div><h3>No pending requests</h3><p>When someone sends you a friend request, it'll show up here.</p></div>`;
      return;
    }
    content.innerHTML = `<div class="friends-list"></div>`;
    const list = content.querySelector('.friends-list');
    reqs.forEach(r => {
      const displayName = r.displayName || r.username;
      const row = document.createElement('div');
      row.className = 'request-row';
      row.innerHTML = `
        <div class="friend-avatar" style="background:${stringToColor(r.username)};width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;color:#fff;overflow:hidden;">
          ${r.avatarUrl ? `<img src="${r.avatarUrl}" style="width:100%;height:100%;object-fit:cover"/>` : displayName[0].toUpperCase()}
        </div>
        <div>
          <div style="font-weight:600;font-size:0.92rem">${displayName}</div>
          <div style="font-size:0.78rem;color:var(--muted)">@${r.username} ¬∑ Incoming Friend Request</div>
        </div>
        <div class="request-actions">
          <button class="req-btn accept" onclick="acceptRequest('${r.docId}','${r.fromUid}')">‚úì Accept</button>
          <button class="req-btn decline" onclick="declineRequest('${r.docId}')">‚úó Decline</button>
        </div>
      `;
      list.appendChild(row);
    });
  }

  window.acceptRequest = async function(docId, fromUid) {
    await updateDoc(doc(db, 'friendships', docId), { status: 'accepted' });
    showToast('Friend request accepted! üéâ', 'success');
    await loadFriends();
  };
  window.declineRequest = async function(docId) {
    await updateDoc(doc(db, 'friendships', docId), { status: 'declined' });
    showToast('Request declined.', '');
    await loadPendingRequests();
    renderPendingView();
  };

  // ‚îÄ‚îÄ SEND FRIEND REQUEST ‚îÄ‚îÄ
  window.sendFriendRequest = async function() {
    const input = document.getElementById('add-friend-input-modal');
    const resultBox = document.getElementById('add-friend-result-modal');
    const username = input.value.trim().toLowerCase();
    resultBox.className = 'add-result';

    if (!username) { resultBox.textContent = 'Please enter a username.'; resultBox.className = 'add-result error'; return; }
    if (username === currentProfile.username) { resultBox.textContent = "You can't add yourself!"; resultBox.className = 'add-result error'; return; }

    // Find user by username
    const usernameSnap = await getDoc(doc(db, 'usernames', username));
    if (!usernameSnap.exists()) {
      resultBox.textContent = `Hmm, no user found with username "${username}".`;
      resultBox.className = 'add-result error';
      return;
    }
    const targetUid = usernameSnap.data().uid;

    // Check if already friends or request sent
    const existingSnap = await getDocs(query(
      collection(db, 'friendships'),
      where('users', 'array-contains', currentUser.uid)
    ));
    for (const d of existingSnap.docs) {
      const data = d.data();
      if (data.users.includes(targetUid)) {
        const statusMsg = data.status === 'accepted' ? "You're already friends!" : 'Friend request already sent.';
        resultBox.textContent = statusMsg;
        resultBox.className = 'add-result error';
        return;
      }
    }

    await addDoc(collection(db, 'friendships'), {
      users: [currentUser.uid, targetUid],
      from: currentUser.uid,
      to: targetUid,
      status: 'pending',
      createdAt: serverTimestamp()
    });

    resultBox.textContent = `Friend request sent to @${username}! üéâ`;
    resultBox.className = 'add-result success';
    input.value = '';
  };

  // ‚îÄ‚îÄ OPEN DM ‚îÄ‚îÄ
  window.openDm = function(friend) {
    currentDmFriend = friend;
    if (dmUnsubscribe) dmUnsubscribe();

    const header = document.getElementById('main-header');
    const displayName = friend.displayName || friend.username;
    header.innerHTML = `
      <div class="friend-avatar" style="background:${stringToColor(friend.username)};width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:0.85rem;color:#fff;overflow:hidden;flex-shrink:0;">
        ${friend.avatarUrl ? `<img src="${friend.avatarUrl}" style="width:100%;height:100%;object-fit:cover"/>` : displayName[0].toUpperCase()}
      </div>
      <h2>${displayName}</h2>
      <button style="margin-left:auto;" class="friend-btn" onclick="startCall(currentDmFriend)" title="Voice Call">üìû</button>
    `;

    const content = document.getElementById('main-content');
    content.innerHTML = `
      <div class="chat-view" style="height:100%;display:flex;flex-direction:column;">
        <div class="chat-messages" id="chat-messages"></div>
        <div class="chat-input-area">
          <div class="chat-input-box">
            <input type="text" id="chat-input" placeholder="Message @${displayName}" onkeydown="if(event.key==='Enter')sendMessage()"/>
            <button class="chat-send-btn" onclick="sendMessage()">‚û§</button>
          </div>
        </div>
      </div>
    `;

    // Get or create DM room
    const roomId = [currentUser.uid, friend.id].sort().join('_');
    const messagesRef = collection(db, 'dms', roomId, 'messages');

    dmUnsubscribe = onSnapshot(query(messagesRef, orderBy('createdAt')), (snap) => {
      const container = document.getElementById('chat-messages');
      if (!container) return;
      container.innerHTML = '';
      if (snap.empty) {
        container.innerHTML = `<div class="empty-state" style="flex:1"><div class="empty-icon">üëã</div><h3>Say hello!</h3><p>This is the beginning of your conversation with ${displayName}.</p></div>`;
        return;
      }
      snap.docs.forEach(d => {
        const data = d.data();
        const isMe = data.senderId === currentUser.uid;
        const senderName = isMe ? (currentProfile.displayName || currentProfile.username) : displayName;
        const senderAvatar = isMe ? currentProfile.avatarUrl : friend.avatarUrl;
        const senderColor = isMe ? stringToColor(currentProfile.username) : stringToColor(friend.username);
        const time = data.createdAt ? new Date(data.createdAt.toDate()).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}) : '';
        const msg = document.createElement('div');
        msg.className = 'chat-msg';
        msg.innerHTML = `
          <div class="chat-msg-avatar" style="background:${senderColor}">
            ${senderAvatar ? `<img src="${senderAvatar}"/>` : senderName[0].toUpperCase()}
          </div>
          <div class="chat-msg-body">
            <div class="chat-msg-header">
              <span class="chat-msg-name">${senderName}</span>
              <span class="chat-msg-time">${time}</span>
            </div>
            <div class="chat-msg-text">${escapeHtml(data.text)}</div>
          </div>
        `;
        container.appendChild(msg);
      });
      container.scrollTop = container.scrollHeight;
    });
  };

  window.sendMessage = async function() {
    const input = document.getElementById('chat-input');
    const text = input.value.trim();
    if (!text || !currentDmFriend) return;
    input.value = '';
    const roomId = [currentUser.uid, currentDmFriend.id].sort().join('_');
    await addDoc(collection(db, 'dms', roomId, 'messages'), {
      text, senderId: currentUser.uid,
      createdAt: serverTimestamp()
    });
  };

  // ‚îÄ‚îÄ PROFILE ‚îÄ‚îÄ
  window.openProfileModal = function() {
    const displayName = currentProfile.displayName || currentProfile.username;
    document.getElementById('display-name-input').value = currentProfile.displayName || '';
    document.getElementById('username-readonly').value = '@' + currentProfile.username;

    const preview = document.getElementById('profile-avatar-preview');
    if (currentProfile.avatarUrl) {
      preview.innerHTML = `<img src="${currentProfile.avatarUrl}"/>`;
      preview.style.background = '';
    } else {
      preview.innerHTML = displayName[0].toUpperCase();
      preview.style.background = stringToColor(currentProfile.username);
    }
    pendingAvatarDataUrl = null;
    openModal('profileModal');
  };

  window.handleAvatarUpload = function(event) {
    const file = event.target.files[0];
    if (!file) return;
    if (file.size > 8 * 1024 * 1024) { showToast('Image must be under 8MB', 'error'); return; }
    const reader = new FileReader();
    reader.onload = (e) => {
      pendingAvatarDataUrl = e.target.result;
      const preview = document.getElementById('profile-avatar-preview');
      preview.innerHTML = `<img src="${pendingAvatarDataUrl}"/>`;
      preview.style.background = '';
    };
    reader.readAsDataURL(file);
  };

  window.removeAvatar = function() {
    pendingAvatarDataUrl = 'remove';
    const preview = document.getElementById('profile-avatar-preview');
    const name = document.getElementById('display-name-input').value || currentProfile.username;
    preview.innerHTML = name[0].toUpperCase();
    preview.style.background = stringToColor(currentProfile.username);
  };

  window.saveProfile = async function() {
    const displayName = document.getElementById('display-name-input').value.trim();
    let avatarUrl = currentProfile.avatarUrl || '';

    // Handle avatar
    if (pendingAvatarDataUrl === 'remove') {
      avatarUrl = '';
    } else if (pendingAvatarDataUrl && pendingAvatarDataUrl.startsWith('data:')) {
      try {
        const fileInput = document.getElementById('avatar-file-input');
        const file = fileInput.files[0];
        if (file) {
          showToast('Uploading photo...', '');
          const formData = new FormData();
          formData.append('file', file);
          formData.append('upload_preset', CLOUDINARY_PRESET);
          formData.append('public_id', `avatars/${currentUser.uid}`);
          const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD}/image/upload`, {
            method: 'POST',
            body: formData
          });
          const data = await res.json();
          if (data.secure_url) {
            avatarUrl = data.secure_url;
          } else {
            showToast('Image upload failed. Please try again.', 'error');
            return;
          }
        }
      } catch (e) {
        showToast('Image upload failed. Please try again.', 'error');
        return;
      }
    }

    await updateDoc(doc(db, 'users', currentUser.uid), { displayName, avatarUrl });
    currentProfile.displayName = displayName;
    currentProfile.avatarUrl = avatarUrl;
    updateSidebarUser();
    closeModal('profileModal');
    showToast('Profile updated! ‚ú®', 'success');
  };

  // ‚îÄ‚îÄ SERVERS ‚îÄ‚îÄ
  async function loadServers() {
    const snap = await getDocs(query(
      collection(db, 'servers'),
      where('ownerId', '==', currentUser.uid)
    ));
    const bar = document.getElementById('servers-bar');
    // Remove existing server icons (keep home, divider, add)
    const existing = bar.querySelectorAll('.server-icon.user-server');
    existing.forEach(e => e.remove());

    const insertBefore = bar.querySelector('.server-icon.add');
    snap.docs.forEach(d => {
      const data = d.data();
      const icon = document.createElement('div');
      icon.className = 'server-icon user-server';
      icon.style.background = stringToColor(data.name);
      icon.style.color = '#fff';
      icon.title = data.name;
      icon.innerHTML = `<span class="server-pip" style="height:0"></span>${data.name[0].toUpperCase()}`;
      icon.onclick = () => {
        document.querySelectorAll('.server-icon').forEach(i => i.classList.remove('active'));
        icon.classList.add('active');
        showServerView(data);
      };
      bar.insertBefore(icon, insertBefore);
    });
  }

  window.createServer = async function() {
    const name = document.getElementById('server-name-input').value.trim();
    if (!name) { showToast('Please enter a server name.', 'error'); return; }
    await addDoc(collection(db, 'servers'), {
      name, ownerId: currentUser.uid,
      createdAt: serverTimestamp()
    });
    document.getElementById('server-name-input').value = '';
    closeModal('createServerModal');
    showToast(`Server "${name}" created! üéâ`, 'success');
    await loadServers();
  };

  function showServerView(server) {
    const header = document.getElementById('main-header');
    header.innerHTML = `<span>#</span><h2>${server.name}</h2>`;
    const content = document.getElementById('main-content');
    content.innerHTML = `
      <div class="empty-state">
        <div class="empty-icon">üè∞</div>
        <h3>${server.name}</h3>
        <p>Your server is ready! Full server features like channels and member management are coming soon.</p>
      </div>
    `;
  }

  // ‚îÄ‚îÄ CALL ‚îÄ‚îÄ
  window.startCall = function(friend) {
    if (!friend) return;
    currentDmFriend = friend;
    const displayName = friend.displayName || friend.username;
    const callAvatar = document.getElementById('call-avatar');
    callAvatar.style.background = stringToColor(friend.username);
    callAvatar.innerHTML = friend.avatarUrl ? `<img src="${friend.avatarUrl}" style="width:100%;height:100%;object-fit:cover;border-radius:50%"/>` : displayName[0].toUpperCase();
    document.getElementById('call-name').textContent = displayName;
    document.getElementById('call-status').textContent = 'Calling...';
    openModal('callModal');
    setTimeout(() => {
      const s = document.getElementById('call-status');
      if (s) s.textContent = 'Ringing... (demo mode)';
    }, 2000);
  };
  window.endCall = function() { closeModal('callModal'); showToast('Call ended.', ''); };

  // ‚îÄ‚îÄ SIGN OUT ‚îÄ‚îÄ
  window.handleSignOut = async function() {
    await signOut(auth);
    window.location.href = 'index.html';
  };

  // ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ
  window.showView = function(view) {
    document.querySelectorAll('.server-icon').forEach(i => i.classList.remove('active'));
    document.querySelector('.server-icon.home').classList.add('active');
    const header = document.getElementById('main-header');
    header.innerHTML = `
      <span>üë•</span>
      <h2>Friends</h2>
      <div class="header-tabs">
        <button class="tab active" onclick="switchTab(this,'online')">Online</button>
        <button class="tab" onclick="switchTab(this,'all')">All</button>
        <button class="tab" onclick="switchTab(this,'pending')">Pending <span id="pending-count" style="display:none;" class="pending-badge">0</span></button>
      </div>
      <button class="add-friend-btn" onclick="openModal('addFriendModal')">+ Add Friend</button>
    `;
    renderFriendsView(window._friends || [], 'online');
  };

  window.switchTab = function(btn, tab) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    btn.classList.add('active');
    if (tab === 'pending') renderPendingView();
    else renderFriendsView(window._friends || [], tab);
  };

  window.selectServerType = function(card) {
    document.querySelectorAll('.server-type-card').forEach(c => c.classList.remove('selected'));
    card.classList.add('selected');
  };

  function stringToColor(str) {
    let hash = 0;
    for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
    const colors = ['#5b6af0','#e040fb','#00bcd4','#ff7043','#66bb6a','#ffa726','#ab47bc','#26c6da'];
    return colors[Math.abs(hash) % colors.length];
  }

  function escapeHtml(text) {
    return text.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  }

  function showToast(message, type) {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.className = `toast ${type} show`;
    setTimeout(() => { toast.className = 'toast'; }, 3000);
  }
</script>

<!-- Non-module helpers -->
<script>
  function openModal(id) { document.getElementById(id).classList.add('open'); }
  function closeModal(id) { document.getElementById(id).classList.remove('open'); }
  document.querySelectorAll('.modal-overlay').forEach(o => {
    o.addEventListener('click', e => { if (e.target === o) o.classList.remove('open'); });
  });
  document.addEventListener('keydown', e => {
    if (e.key === 'Escape') document.querySelectorAll('.modal-overlay.open').forEach(m => m.classList.remove('open'));
  });
</script>
</body>
</html>
