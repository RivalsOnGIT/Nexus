<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Nexus</title>
  <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet"/>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --bg: #0b0c10; --surface: #13151c; --surface2: #1c1f2b; --surface3: #242838;
      --accent: #5b6af0; --text: #eaedf8; --muted: #7c80a0;
      --border: rgba(255,255,255,0.07); --glow: rgba(91,106,240,0.3);
      --error: #ff5f57; --success: #23d18b; --online: #23d18b;
      --idle: #ffa726; --dnd: #ff5f57; --admin: #f59e0b;
      --mobile-nav-h: 60px;
    }
    html { height: 100%; }
    body { height: 100%; background: var(--bg); color: var(--text); font-family: 'DM Sans', sans-serif; display: flex; overflow: hidden; }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       DESKTOP LAYOUT
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .servers-bar { width: 72px; background: #080a0f; display: flex; flex-direction: column; align-items: center; padding: 12px 0; gap: 8px; border-right: 1px solid var(--border); flex-shrink: 0; overflow-y: auto; }
    .server-icon { width: 48px; height: 48px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 1.2rem; font-weight: 700; transition: border-radius 0.2s, background 0.2s; position: relative; flex-shrink: 0; user-select: none; }
    .server-icon:hover, .server-icon.active { border-radius: 16px; }
    .server-icon.home { background: var(--accent); color: #fff; font-size: 1.3rem; }
    .server-icon.home:hover, .server-icon.home.active { background: #4a59e0; }
    .server-icon.add { background: var(--surface2); color: var(--success); font-size: 1.5rem; border-radius: 50%; }
    .server-icon.add:hover { background: var(--success); color: #fff; border-radius: 16px; }
    .server-icon.admin-icon { background: var(--admin); color: #fff; font-size: 1.1rem; }
    .server-icon.admin-icon:hover, .server-icon.admin-icon.active { background: #d97706; }
    .server-divider { width: 32px; height: 2px; background: var(--border); border-radius: 1px; margin: 4px 0; }
    .server-pip { position: absolute; left: -4px; top: 50%; transform: translateY(-50%); width: 4px; border-radius: 0 2px 2px 0; background: var(--text); transition: height 0.2s; height: 0; }
    .server-icon:hover .server-pip { height: 20px; }
    .server-icon.active .server-pip { height: 36px; }

    .sidebar { width: 240px; background: var(--surface); display: flex; flex-direction: column; border-right: 1px solid var(--border); flex-shrink: 0; transition: transform 0.3s; }
    .sidebar-header { padding: 0 16px; height: 52px; border-bottom: 1px solid var(--border); font-family: 'Syne', sans-serif; font-weight: 700; font-size: 0.95rem; display: flex; align-items: center; justify-content: space-between; flex-shrink: 0; }
    .sidebar-search { padding: 8px 12px; flex-shrink: 0; }
    .sidebar-search input { width: 100%; background: var(--surface2); border: 1px solid var(--border); border-radius: 6px; padding: 7px 10px; color: var(--text); font-family: 'DM Sans', sans-serif; font-size: 0.82rem; outline: none; }
    .sidebar-search input::placeholder { color: var(--muted); }
    .sidebar-scroll { flex: 1; overflow-y: auto; }
    .sidebar-section-label { padding: 12px 12px 4px; font-size: 0.7rem; font-weight: 700; letter-spacing: 0.08em; color: var(--muted); text-transform: uppercase; display: flex; align-items: center; justify-content: space-between; }
    .sidebar-section-label .sl-btn { cursor: pointer; font-size: 1rem; opacity: 0.6; transition: opacity 0.2s; background: none; border: none; color: var(--muted); }
    .sidebar-section-label .sl-btn:hover { opacity: 1; }
    .sidebar-item { display: flex; align-items: center; gap: 10px; padding: 7px 12px; border-radius: 6px; margin: 1px 8px; cursor: pointer; transition: background 0.15s; font-size: 0.88rem; color: var(--muted); }
    .sidebar-item:hover { background: var(--surface2); color: var(--text); }
    .sidebar-item.active { background: var(--surface3); color: var(--text); }
    .item-avatar { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.78rem; font-weight: 700; flex-shrink: 0; position: relative; overflow: hidden; }
    .item-avatar img { width: 100%; height: 100%; object-fit: cover; }
    .status-dot { position: absolute; bottom: -1px; right: -1px; width: 10px; height: 10px; border-radius: 50%; border: 2px solid var(--surface); }
    .status-dot.online { background: var(--online); }
    .status-dot.idle { background: var(--idle); }
    .status-dot.dnd { background: var(--dnd); }
    .status-dot.offline { background: var(--muted); }
    /* channel item */
    .channel-item { display: flex; align-items: center; gap: 8px; padding: 6px 12px; border-radius: 6px; margin: 1px 8px; cursor: pointer; transition: background 0.15s; font-size: 0.88rem; color: var(--muted); }
    .channel-item:hover { background: var(--surface2); color: var(--text); }
    .channel-item.active { background: var(--surface3); color: var(--text); }
    .channel-item .ch-lock { font-size: 0.7rem; margin-left: auto; opacity: 0.5; }

    .user-panel { padding: 10px 8px; border-top: 1px solid var(--border); display: flex; align-items: center; gap: 8px; cursor: pointer; border-radius: 8px; transition: background 0.15s; flex-shrink: 0; }
    .user-panel:hover { background: var(--surface2); }
    .user-panel-avatar { width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.9rem; color: #fff; flex-shrink: 0; overflow: hidden; }
    .user-panel-avatar img { width: 100%; height: 100%; object-fit: cover; }
    .user-panel-info { flex: 1; min-width: 0; }
    .user-panel-name { font-size: 0.85rem; font-weight: 600; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .user-panel-tag { font-size: 0.72rem; color: var(--muted); }
    .user-panel-actions { display: flex; gap: 4px; }
    .icon-btn { width: 28px; height: 28px; border-radius: 6px; background: none; border: none; color: var(--muted); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1rem; transition: background 0.15s, color 0.15s; }
    .icon-btn:hover { background: var(--surface3); color: var(--text); }

    .main { flex: 1; display: flex; flex-direction: column; overflow: hidden; min-width: 0; }
    .main-header { padding: 0 16px; height: 52px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 10px; flex-shrink: 0; }
    .main-header h2 { font-family: 'Syne', sans-serif; font-weight: 700; font-size: 1rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .header-tabs { display: flex; gap: 4px; margin-left: 16px; }
    .tab { padding: 5px 12px; border-radius: 6px; font-size: 0.82rem; font-weight: 500; cursor: pointer; color: var(--muted); transition: background 0.15s, color 0.15s; border: none; background: none; font-family: 'DM Sans', sans-serif; white-space: nowrap; }
    .tab:hover { background: var(--surface2); color: var(--text); }
    .tab.active { background: var(--surface2); color: var(--text); }
    .add-friend-btn { margin-left: auto; padding: 6px 14px; background: var(--success); color: #fff; border: none; border-radius: 6px; font-family: 'DM Sans', sans-serif; font-size: 0.8rem; font-weight: 600; cursor: pointer; transition: background 0.2s; white-space: nowrap; flex-shrink: 0; }
    .add-friend-btn:hover { background: #1db97a; }
    .main-content { flex: 1; overflow-y: auto; padding: 20px; min-height: 0; }

    /* hamburger for mobile */
    .hamburger { display: none; background: none; border: none; color: var(--text); font-size: 1.4rem; cursor: pointer; padding: 4px; flex-shrink: 0; }

    /* â”€â”€ FRIENDS â”€â”€ */
    .friends-list { display: flex; flex-direction: column; gap: 2px; }
    .friend-row { display: flex; align-items: center; gap: 12px; padding: 10px 14px; border-radius: 10px; transition: background 0.15s; border-bottom: 1px solid var(--border); }
    .friend-row:hover { background: var(--surface2); }
    .friend-avatar { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.95rem; color: #fff; flex-shrink: 0; position: relative; overflow: hidden; cursor: pointer; }
    .friend-avatar img { width: 100%; height: 100%; object-fit: cover; }
    .friend-info { flex: 1; cursor: pointer; min-width: 0; }
    .friend-name { font-weight: 600; font-size: 0.92rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .friend-status { font-size: 0.76rem; color: var(--muted); margin-top: 1px; }
    .friend-actions { display: flex; gap: 6px; flex-shrink: 0; }
    .friend-btn { width: 34px; height: 34px; border-radius: 50%; background: var(--surface2); border: none; color: var(--muted); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 0.95rem; transition: background 0.15s, color 0.15s; }
    .friend-btn:hover { background: var(--surface3); color: var(--text); }

    /* â”€â”€ CHAT â”€â”€ */
    .chat-view { display: flex; flex-direction: column; height: 100%; overflow: hidden; flex: 1; min-height: 0; }
    .chat-messages { flex: 1; overflow-y: auto; padding: 16px 16px 8px; display: flex; flex-direction: column; gap: 2px; min-height: 0; }
    .typing-indicator { flex-shrink: 0; }
    .chat-input-area { flex-shrink: 0; padding: 0 12px 12px; }
    .no-perm-bar { flex-shrink: 0; }
    .deactivated-bar { flex-shrink: 0; }
    .chat-msg { display: flex; gap: 12px; padding: 4px 6px; border-radius: 8px; transition: background 0.1s; }
    .chat-msg:hover { background: rgba(255,255,255,0.02); }
    .chat-msg-avatar { width: 38px; height: 38px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.85rem; color: #fff; flex-shrink: 0; overflow: hidden; cursor: pointer; }
    .chat-msg-avatar img { width: 100%; height: 100%; object-fit: cover; }
    .chat-msg-body { flex: 1; min-width: 0; }
    .chat-msg-header { display: flex; align-items: baseline; gap: 8px; margin-bottom: 3px; flex-wrap: wrap; }
    .chat-msg-name { font-weight: 600; font-size: 0.88rem; cursor: pointer; }
    .chat-msg-name:hover { text-decoration: underline; }
    .chat-msg-time { font-size: 0.7rem; color: var(--muted); }
    .chat-msg-text { font-size: 0.88rem; color: #c8cce0; line-height: 1.55; word-break: break-word; }
    .role-badge { display: inline-block; padding: 1px 6px; border-radius: 4px; font-size: 0.65rem; font-weight: 700; margin-right: 4px; vertical-align: middle; }
    .msg-image { max-width: min(320px, 90%); max-height: 220px; border-radius: 10px; margin-top: 6px; cursor: zoom-in; display: block; object-fit: cover; }
    .msg-video { max-width: min(360px, 90%); border-radius: 10px; margin-top: 6px; display: block; }
    .msg-audio { margin-top: 6px; width: min(280px, 90%); }
    .msg-file { display: inline-flex; align-items: center; gap: 10px; background: var(--surface2); border: 1px solid var(--border); border-radius: 10px; padding: 10px 14px; margin-top: 6px; text-decoration: none; color: var(--text); transition: background 0.15s; max-width: min(300px, 90%); }
    .msg-file:hover { background: var(--surface3); }
    .msg-file-icon { font-size: 1.4rem; flex-shrink: 0; }
    .msg-file-name { font-size: 0.82rem; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 160px; }
    .msg-file-size { font-size: 0.7rem; color: var(--muted); }
    .typing-indicator { padding: 4px 22px 8px; font-size: 0.78rem; color: var(--muted); font-style: italic; min-height: 24px; flex-shrink: 0; }
    .typing-dots { display: inline-flex; gap: 3px; margin-left: 4px; vertical-align: middle; }
    .typing-dots span { width: 4px; height: 4px; border-radius: 50%; background: var(--muted); display: inline-block; animation: typeBounce 1.2s infinite; }
    .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
    .typing-dots span:nth-child(3) { animation-delay: 0.4s; }
    @keyframes typeBounce { 0%,60%,100%{transform:translateY(0)}30%{transform:translateY(-4px)} }
    .upload-progress { display: flex; align-items: center; gap: 10px; padding: 8px 12px; background: var(--surface2); border-radius: 8px; font-size: 0.82rem; color: var(--muted); margin: 4px 8px; }
    .progress-bar { flex: 1; height: 4px; background: var(--surface3); border-radius: 2px; overflow: hidden; }
    .progress-fill { height: 100%; background: var(--accent); border-radius: 2px; transition: width 0.3s; width: 0%; }
    .chat-input-box { display: flex; align-items: center; gap: 8px; background: var(--surface2); border: 1px solid var(--border); border-radius: 12px; padding: 0 12px; transition: border-color 0.2s; }
    .chat-input-box:focus-within { border-color: rgba(91,106,240,0.4); }
    .chat-attach-btn { background: none; border: none; color: var(--muted); cursor: pointer; font-size: 1.2rem; padding: 4px; transition: color 0.2s; flex-shrink: 0; }
    .chat-attach-btn:hover { color: var(--text); }
    .chat-input-box input { flex: 1; background: none; border: none; padding: 13px 0; color: var(--text); font-family: 'DM Sans', sans-serif; font-size: 0.92rem; outline: none; min-width: 0; }
    .chat-input-box input::placeholder { color: var(--muted); }
    .chat-send-btn { background: none; border: none; color: var(--muted); cursor: pointer; font-size: 1.1rem; transition: color 0.2s; flex-shrink: 0; }
    .chat-send-btn:hover { color: var(--accent); }
    .deactivated-bar { padding: 12px 20px; background: rgba(255,95,87,0.08); border-top: 1px solid rgba(255,95,87,0.15); text-align: center; font-size: 0.84rem; color: var(--error); flex-shrink: 0; }
    .no-perm-bar { padding: 12px 20px; background: rgba(124,128,160,0.08); border-top: 1px solid var(--border); text-align: center; font-size: 0.84rem; color: var(--muted); flex-shrink: 0; }

    /* â”€â”€ SERVER VIEW â”€â”€ */
    .server-sidebar { display: flex; flex-direction: column; height: 100%; }
    .server-header { padding: 0 14px; height: 52px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; flex-shrink: 0; font-family: 'Syne', sans-serif; font-weight: 700; font-size: 0.95rem; }
    .server-header-actions { display: flex; gap: 4px; }

    /* â”€â”€ RIGHT PROFILE PANEL â”€â”€ */
    .profile-panel { width: 260px; background: var(--surface); border-left: 1px solid var(--border); flex-shrink: 0; display: flex; flex-direction: column; overflow-y: auto; transition: width 0.25s; }
    .profile-panel.hidden { width: 0; overflow: hidden; border: none; }
    .pp-banner { height: 80px; flex-shrink: 0; position: relative; }
    .pp-close-btn { position: absolute; top: 8px; right: 8px; background: rgba(0,0,0,0.3); border: none; color: #fff; width: 24px; height: 24px; border-radius: 50%; cursor: pointer; font-size: 0.9rem; display: flex; align-items: center; justify-content: center; }
    .pp-body { padding: 0 16px 24px; }
    .pp-avatar-wrap { position: relative; margin-top: -30px; margin-bottom: 12px; }
    .pp-avatar { width: 60px; height: 60px; border-radius: 50%; border: 4px solid var(--surface); display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1.3rem; color: #fff; overflow: hidden; }
    .pp-avatar img { width: 100%; height: 100%; object-fit: cover; }
    .pp-status-badge { position: absolute; bottom: 2px; right: 2px; width: 16px; height: 16px; border-radius: 50%; border: 3px solid var(--surface); }
    .pp-name { font-family: 'Syne', sans-serif; font-weight: 700; font-size: 1.05rem; margin-bottom: 2px; }
    .pp-username { font-size: 0.8rem; color: var(--muted); margin-bottom: 6px; }
    .pp-status-line { font-size: 0.82rem; color: var(--muted); margin-bottom: 14px; display: flex; align-items: center; gap: 6px; }
    .pp-divider { height: 1px; background: var(--border); margin: 12px 0; }
    .pp-section-title { font-size: 0.7rem; font-weight: 700; letter-spacing: 0.08em; text-transform: uppercase; color: var(--muted); margin-bottom: 6px; }
    .pp-bio { font-size: 0.85rem; color: #c8cce0; line-height: 1.6; white-space: pre-wrap; word-break: break-word; }
    .pp-since { font-size: 0.82rem; color: var(--muted); }
    .pp-dm-btn { width: 100%; margin-top: 16px; padding: 10px; background: var(--accent); color: #fff; border: none; border-radius: 8px; font-family: 'DM Sans', sans-serif; font-size: 0.88rem; font-weight: 600; cursor: pointer; transition: background 0.2s; }
    .pp-dm-btn:hover { background: #6b7af8; }

    /* â”€â”€ ADMIN PANEL â”€â”€ */
    .admin-toolbar { display: flex; align-items: center; gap: 10px; padding: 16px 20px; border-bottom: 1px solid var(--border); flex-wrap: wrap; }
    .admin-search { flex: 1; min-width: 160px; background: var(--surface2); border: 1px solid var(--border); border-radius: 8px; padding: 9px 12px; color: var(--text); font-family: 'DM Sans', sans-serif; font-size: 0.85rem; outline: none; }
    .admin-search:focus { border-color: var(--admin); }
    .admin-search::placeholder { color: var(--muted); }
    .admin-filter { padding: 9px 12px; background: var(--surface2); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-family: 'DM Sans', sans-serif; font-size: 0.82rem; outline: none; cursor: pointer; }
    .admin-stats { display: grid; grid-template-columns: repeat(4,1fr); gap: 10px; padding: 14px 20px; border-bottom: 1px solid var(--border); }
    .admin-stat { background: var(--surface2); border: 1px solid var(--border); border-radius: 10px; padding: 12px 14px; }
    .admin-stat-num { font-family: 'Syne', sans-serif; font-weight: 800; font-size: 1.4rem; margin-bottom: 2px; }
    .admin-stat-label { font-size: 0.72rem; color: var(--muted); }
    .admin-table { flex: 1; overflow-y: auto; }
    .admin-table-header { display: grid; grid-template-columns: 2fr 1.5fr 0.8fr 0.8fr 1.4fr; padding: 8px 20px; font-size: 0.7rem; font-weight: 700; letter-spacing: 0.06em; text-transform: uppercase; color: var(--muted); border-bottom: 1px solid var(--border); }
    .admin-user-row { display: grid; grid-template-columns: 2fr 1.5fr 0.8fr 0.8fr 1.4fr; align-items: center; padding: 10px 20px; border-bottom: 1px solid var(--border); transition: background 0.15s; gap: 8px; }
    .admin-user-row:hover { background: var(--surface2); }
    .admin-user-info { display: flex; align-items: center; gap: 8px; min-width: 0; }
    .admin-avatar { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.78rem; color: #fff; flex-shrink: 0; overflow: hidden; }
    .admin-avatar img { width: 100%; height: 100%; object-fit: cover; }
    .admin-user-name { font-weight: 600; font-size: 0.85rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .admin-user-tag { font-size: 0.72rem; color: var(--muted); }
    .admin-badge { display: inline-flex; align-items: center; padding: 2px 7px; border-radius: 20px; font-size: 0.7rem; font-weight: 600; }
    .badge-active { background: rgba(35,209,139,0.12); color: var(--success); }
    .badge-banned { background: rgba(255,95,87,0.12); color: var(--error); }
    .badge-warned { background: rgba(255,167,38,0.12); color: var(--idle); }
    .badge-deleted { background: rgba(124,128,160,0.12); color: var(--muted); }
    .badge-temp { background: rgba(245,158,11,0.12); color: var(--admin); }
    .admin-actions { display: flex; gap: 4px; flex-wrap: wrap; }
    .admin-btn { padding: 4px 8px; border-radius: 5px; font-family: 'DM Sans', sans-serif; font-size: 0.72rem; font-weight: 600; cursor: pointer; border: none; transition: all 0.15s; }
    .admin-btn-warn { background: rgba(255,167,38,0.15); color: var(--idle); }
    .admin-btn-warn:hover { background: rgba(255,167,38,0.3); }
    .admin-btn-temp { background: rgba(245,158,11,0.15); color: var(--admin); }
    .admin-btn-temp:hover { background: rgba(245,158,11,0.3); }
    .admin-btn-ban { background: rgba(255,95,87,0.15); color: var(--error); }
    .admin-btn-ban:hover { background: rgba(255,95,87,0.3); }
    .admin-btn-unban { background: rgba(35,209,139,0.15); color: var(--success); }
    .admin-btn-unban:hover { background: rgba(35,209,139,0.3); }
    .admin-btn-delete { background: rgba(124,128,160,0.1); color: var(--muted); }
    .admin-btn-delete:hover { background: rgba(255,95,87,0.15); color: var(--error); }
    .admin-empty { padding: 40px; text-align: center; color: var(--muted); font-size: 0.88rem; }

    /* â”€â”€ MODALS â”€â”€ */
    .modal-overlay { position: fixed; inset: 0; z-index: 999; background: rgba(0,0,0,0.75); backdrop-filter: blur(8px); display: flex; align-items: center; justify-content: center; padding: 16px; opacity: 0; pointer-events: none; transition: opacity 0.2s; }
    .modal-overlay.open { opacity: 1; pointer-events: all; }
    .modal { background: var(--surface); border: 1px solid var(--border); border-radius: 20px; padding: 32px 28px; width: 100%; max-width: 460px; position: relative; transform: translateY(16px); transition: transform 0.2s; max-height: calc(100vh - 32px); overflow-y: auto; }
    .modal-overlay.open .modal { transform: translateY(0); }
    .modal-close { position: absolute; top: 14px; right: 16px; background: none; border: none; color: var(--muted); font-size: 1.4rem; cursor: pointer; }
    .modal-close:hover { color: var(--text); }
    .modal h2 { font-family: 'Syne', sans-serif; font-weight: 700; font-size: 1.3rem; margin-bottom: 6px; }
    .modal > p, .modal-desc { color: var(--muted); font-size: 0.86rem; margin-bottom: 22px; }
    .form-group { display: flex; flex-direction: column; gap: 6px; margin-bottom: 14px; }
    .form-group label { font-size: 0.75rem; font-weight: 700; color: var(--muted); letter-spacing: 0.06em; text-transform: uppercase; }
    .form-group input, .form-group textarea, .form-group select { background: var(--surface2); border: 1px solid var(--border); border-radius: 8px; padding: 11px 13px; color: var(--text); font-family: 'DM Sans', sans-serif; font-size: 0.9rem; outline: none; transition: border-color 0.2s; resize: none; width: 100%; }
    .form-group input:focus, .form-group textarea:focus, .form-group select:focus { border-color: var(--accent); }
    .form-group input::placeholder, .form-group textarea::placeholder { color: #4a4f6a; }
    .form-group input:disabled { opacity: 0.5; cursor: not-allowed; }
    .modal-btn { width: 100%; padding: 12px; background: var(--accent); color: #fff; border: none; border-radius: 8px; font-family: 'DM Sans', sans-serif; font-size: 0.9rem; font-weight: 600; cursor: pointer; transition: background 0.2s; box-shadow: 0 0 20px var(--glow); }
    .modal-btn:hover { background: #6b7af8; }
    .modal-btn.danger { background: var(--error); box-shadow: none; }
    .modal-btn.danger:hover { background: #e04040; }
    .modal-btn.secondary { background: var(--surface2); color: var(--text); box-shadow: none; }
    .modal-btn.secondary:hover { background: var(--surface3); }
    .modal-btn-row { display: flex; gap: 10px; }
    .modal-btn-row .modal-btn { flex: 1; }
    .avatar-upload-area { display: flex; align-items: center; gap: 16px; margin-bottom: 20px; }
    .avatar-preview { width: 72px; height: 72px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1.6rem; color: #fff; flex-shrink: 0; overflow: hidden; border: 3px solid var(--border); }
    .avatar-preview img { width: 100%; height: 100%; object-fit: cover; }
    .avatar-upload-btns { display: flex; flex-direction: column; gap: 6px; }
    .avatar-upload-btns button { padding: 7px 14px; border-radius: 8px; font-family: 'DM Sans', sans-serif; font-size: 0.8rem; font-weight: 600; cursor: pointer; border: none; }
    .upload-btn { background: var(--accent); color: #fff; }
    .remove-btn { background: var(--surface2); color: var(--muted); }
    .avatar-upload-btns p { font-size: 0.72rem; color: var(--muted); }
    .status-selector { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 18px; }
    .status-option { display: flex; align-items: center; gap: 8px; padding: 9px 12px; background: var(--surface2); border: 2px solid var(--border); border-radius: 10px; cursor: pointer; transition: all 0.15s; font-size: 0.83rem; }
    .status-option:hover { border-color: rgba(255,255,255,0.15); }
    .status-option.selected { border-color: var(--accent); background: rgba(91,106,240,0.1); }
    .status-pip { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
    .server-type-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 18px; }
    .server-type-card { background: var(--surface2); border: 2px solid var(--border); border-radius: 10px; padding: 14px; cursor: pointer; transition: all 0.2s; text-align: center; }
    .server-type-card:hover, .server-type-card.selected { border-color: var(--accent); background: rgba(91,106,240,0.08); }
    .server-type-card .type-icon { font-size: 1.6rem; margin-bottom: 6px; }
    .server-type-card .type-name { font-size: 0.8rem; font-weight: 600; }
    .call-display { text-align: center; padding: 20px 0; }
    .call-avatar { width: 80px; height: 80px; border-radius: 50%; margin: 0 auto 14px; display: flex; align-items: center; justify-content: center; font-size: 2rem; font-weight: 700; color: #fff; overflow: hidden; animation: callPulse 2s infinite; }
    .call-avatar img { width: 100%; height: 100%; object-fit: cover; }
    @keyframes callPulse { 0%,100%{box-shadow:0 0 0 0 rgba(91,106,240,0.4)}50%{box-shadow:0 0 0 14px rgba(91,106,240,0)} }
    .call-name { font-family: 'Syne', sans-serif; font-weight: 700; font-size: 1.2rem; margin-bottom: 5px; }
    .call-status { color: var(--muted); font-size: 0.86rem; margin-bottom: 24px; }
    .call-actions { display: flex; justify-content: center; gap: 16px; }
    .call-action-btn { width: 52px; height: 52px; border-radius: 50%; border: none; cursor: pointer; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; transition: transform 0.15s; }
    .call-action-btn:hover { transform: scale(1.1); }
    .call-action-btn.end { background: var(--error); color: #fff; }
    .call-action-btn.mute, .call-action-btn.video { background: var(--surface2); color: var(--text); }
    .danger-zone { border: 1px solid rgba(255,95,87,0.2); border-radius: 12px; padding: 18px; margin-top: 8px; }
    .danger-zone h4 { font-family: 'Syne', sans-serif; font-weight: 700; color: var(--error); margin-bottom: 8px; font-size: 0.92rem; }
    .danger-zone p { color: var(--muted); font-size: 0.8rem; margin-bottom: 14px; line-height: 1.5; }
    /* invite link display */
    .invite-link-box { display: flex; align-items: center; gap: 8px; background: var(--surface2); border: 1px solid var(--border); border-radius: 8px; padding: 10px 14px; margin: 14px 0; }
    .invite-link-box span { flex: 1; font-size: 0.82rem; color: var(--text); word-break: break-all; }
    .copy-btn { padding: 6px 12px; background: var(--accent); color: #fff; border: none; border-radius: 6px; font-family: 'DM Sans', sans-serif; font-size: 0.78rem; font-weight: 600; cursor: pointer; flex-shrink: 0; }
    /* roles list */
    .role-row { display: flex; align-items: center; gap: 10px; padding: 8px 0; border-bottom: 1px solid var(--border); }
    .role-color-dot { width: 14px; height: 14px; border-radius: 50%; flex-shrink: 0; }
    .role-name { flex: 1; font-size: 0.88rem; font-weight: 600; }
    .role-perms { font-size: 0.72rem; color: var(--muted); }
    .role-del-btn { background: none; border: none; color: var(--muted); cursor: pointer; font-size: 0.9rem; padding: 2px 6px; border-radius: 4px; }
    .role-del-btn:hover { background: rgba(255,95,87,0.15); color: var(--error); }
    .perm-toggle { display: flex; align-items: center; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border); font-size: 0.86rem; }
    .perm-toggle:last-child { border: none; }
    .toggle-switch { position: relative; width: 36px; height: 20px; flex-shrink: 0; }
    .toggle-switch input { opacity: 0; width: 0; height: 0; }
    .toggle-slider { position: absolute; inset: 0; background: var(--surface3); border-radius: 20px; cursor: pointer; transition: background 0.2s; }
    .toggle-slider::before { content:''; position: absolute; width: 14px; height: 14px; left: 3px; top: 3px; background: #fff; border-radius: 50%; transition: transform 0.2s; }
    .toggle-switch input:checked + .toggle-slider { background: var(--accent); }
    .toggle-switch input:checked + .toggle-slider::before { transform: translateX(16px); }
    /* member rows in roles modal */
    .member-row { display: flex; align-items: center; gap: 10px; padding: 8px 0; border-bottom: 1px solid var(--border); }
    .member-row:last-child { border: none; }
    .member-row .member-info { flex: 1; min-width: 0; }
    .member-row .member-name { font-size: 0.88rem; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .member-row .member-tag { font-size: 0.72rem; color: var(--muted); }
    .member-role-select { background: var(--surface2); border: 1px solid var(--border); border-radius: 6px; padding: 5px 8px; color: var(--text); font-family: 'DM Sans', sans-serif; font-size: 0.78rem; outline: none; cursor: pointer; }

    /* misc */
    .pending-badge { background: var(--error); color: #fff; font-size: 0.62rem; font-weight: 700; border-radius: 10px; padding: 1px 5px; }
    .request-row { display: flex; align-items: center; gap: 10px; padding: 10px 14px; border-bottom: 1px solid var(--border); }
    .request-actions { margin-left: auto; display: flex; gap: 6px; }
    .req-btn { padding: 5px 12px; border-radius: 6px; font-family: 'DM Sans', sans-serif; font-size: 0.78rem; font-weight: 600; cursor: pointer; border: none; }
    .req-btn.accept { background: var(--success); color: #fff; }
    .req-btn.decline { background: var(--surface2); color: var(--muted); }
    .add-result { font-size: 0.86rem; padding: 9px 12px; border-radius: 8px; display: none; margin-bottom: 10px; }
    .add-result.success { background: rgba(35,209,139,0.1); color: var(--success); border: 1px solid rgba(35,209,139,0.2); display: block; }
    .add-result.error { background: rgba(255,95,87,0.1); color: var(--error); border: 1px solid rgba(255,95,87,0.2); display: block; }
    .empty-state { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; text-align: center; gap: 14px; padding: 24px; }
    .empty-state .empty-icon { font-size: 3.5rem; }
    .empty-state h3 { font-family: 'Syne', sans-serif; font-weight: 700; font-size: 1.2rem; }
    .empty-state p { color: var(--muted); font-size: 0.88rem; max-width: 300px; line-height: 1.6; }
    .lightbox { position: fixed; inset: 0; z-index: 9998; background: rgba(0,0,0,0.9); display: flex; align-items: center; justify-content: center; cursor: zoom-out; opacity: 0; pointer-events: none; transition: opacity 0.2s; }
    .lightbox.open { opacity: 1; pointer-events: all; }
    .lightbox img { max-width: 92vw; max-height: 90vh; border-radius: 10px; object-fit: contain; }
    .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%) translateY(20px); background: var(--surface2); border: 1px solid var(--border); border-radius: 10px; padding: 11px 18px; font-size: 0.86rem; color: var(--text); z-index: 9999; opacity: 0; transition: all 0.3s; pointer-events: none; white-space: nowrap; max-width: 90vw; }
    .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
    .toast.success { border-color: rgba(35,209,139,0.3); color: var(--success); }
    .toast.error { border-color: rgba(255,95,87,0.3); color: var(--error); }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       MOBILE LAYOUT  â‰¤ 680px
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    @media (max-width: 680px) {
      body { flex-direction: column; overflow: hidden; }
      .servers-bar { display: none; }
      /* Sidebar slides in from left, sits above everything */
      .sidebar {
        position: fixed; top: 0; left: 0;
        bottom: var(--mobile-nav-h); width: 80vw; max-width: 300px;
        z-index: 200; transform: translateX(-100%); box-shadow: 4px 0 24px rgba(0,0,0,0.5);
        transition: transform 0.3s;
      }
      .sidebar.open { transform: translateX(0); }
      .sidebar-overlay { display: none; position: fixed; inset: 0; bottom: var(--mobile-nav-h); background: rgba(0,0,0,0.5); z-index: 199; }
      .sidebar-overlay.open { display: block; }
      .profile-panel { display: none; }
      /* Main fills from top to just above mobile nav */
      .main {
        position: fixed;
        top: 0; left: 0; right: 0;
        bottom: var(--mobile-nav-h);
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }
      /* Header always 52px */
      .main-header { flex-shrink: 0; }
      /* main-content fills remainder */
      .main-content { flex: 1; min-height: 0; overflow-y: auto; }
      .main-content.chat-mode { overflow: hidden; display: flex; flex-direction: column; }
      /* chat-view fills chat-mode exactly */
      .chat-view { flex: 1; display: flex; flex-direction: column; min-height: 0; overflow: hidden; }
      .chat-messages { flex: 1; min-height: 0; overflow-y: auto; }
      /* Input box anchored at bottom, never hidden */
      .chat-input-area {
        flex-shrink: 0;
        padding: 8px 10px 10px;
        background: var(--bg);
      }
      .hamburger { display: flex; }
      /* bottom nav */
      .mobile-nav {
        position: fixed; bottom: 0; left: 0; right: 0; height: var(--mobile-nav-h);
        background: var(--surface); border-top: 1px solid var(--border);
        display: flex; align-items: center; justify-content: space-around;
        z-index: 300; padding: 0 4px;
      }
      .mobile-nav-btn {
        display: flex; flex-direction: column; align-items: center; gap: 3px;
        background: none; border: none; color: var(--muted); cursor: pointer;
        font-size: 1.3rem; padding: 6px 8px; border-radius: 10px; transition: color 0.15s;
        flex: 1;
      }
      .mobile-nav-btn span { font-size: 0.56rem; font-weight: 700; letter-spacing: 0.03em; text-transform: uppercase; }
      .mobile-nav-btn.active { color: var(--accent); }
      .mobile-nav-badge { position: relative; }
      .mobile-nav-badge::after { content: attr(data-badge); position: absolute; top: -4px; right: -6px; background: var(--error); color: #fff; font-size: 0.55rem; font-weight: 700; border-radius: 10px; padding: 1px 4px; display: none; }
      .mobile-nav-badge[data-badge]:not([data-badge=""])::after { display: block; }
      .admin-stats { grid-template-columns: 1fr 1fr; }
      .admin-table-header { display: none; }
      .admin-user-row { grid-template-columns: 1fr auto; grid-template-rows: auto auto; gap: 4px; }
      .admin-user-row > div:nth-child(2), .admin-user-row > div:nth-child(3) { display: none; }
      .header-tabs { overflow-x: auto; -webkit-overflow-scrolling: touch; }
      .header-tabs::-webkit-scrollbar { display: none; }
    }

    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

    ::-webkit-scrollbar { width: 4px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--surface3); border-radius: 2px; }
  </style>
</head>
<body>

<!-- MOBILE SIDEBAR OVERLAY -->
<div class="sidebar-overlay" id="sidebar-overlay" onclick="closeMobileSidebar()"></div>

<!-- LIGHTBOX -->
<div class="lightbox" id="lightbox" onclick="this.classList.remove('open')"><img id="lightbox-img" src="" alt=""/></div>
<div class="toast" id="toast"></div>

<!-- â•â•â• ALL MODALS â•â•â• -->

<!-- CREATE SERVER -->
<div class="modal-overlay" id="createServerModal">
  <div class="modal">
    <button class="modal-close" onclick="closeModal('createServerModal')">Ã—</button>
    <h2>Create a Server</h2><p>Give your community a home.</p>
    <div class="server-type-grid">
      <div class="server-type-card selected" onclick="selectServerType(this)"><div class="type-icon">ğŸ®</div><div class="type-name">Gaming</div></div>
      <div class="server-type-card" onclick="selectServerType(this)"><div class="type-icon">ğŸ¨</div><div class="type-name">Creative</div></div>
      <div class="server-type-card" onclick="selectServerType(this)"><div class="type-icon">ğŸ“š</div><div class="type-name">Education</div></div>
      <div class="server-type-card" onclick="selectServerType(this)"><div class="type-icon">ğŸ’¬</div><div class="type-name">Community</div></div>
    </div>
    <div class="form-group"><label>Server Name</label><input type="text" id="server-name-input" placeholder="My awesome server"/></div>
    <button class="modal-btn" onclick="createServer()">Create Server</button>
  </div>
</div>

<!-- JOIN SERVER VIA INVITE -->
<div class="modal-overlay" id="joinServerModal">
  <div class="modal">
    <button class="modal-close" onclick="closeModal('joinServerModal')">Ã—</button>
    <h2>Join a Server</h2><p>Enter an invite link or code to join a server.</p>
    <div class="add-result" id="join-result"></div>
    <div class="form-group"><label>Invite Link or Code</label><input type="text" id="join-invite-input" placeholder="https://nexus.app/invite/abc123 or abc123"/></div>
    <button class="modal-btn" onclick="joinServerViaInvite()">Join Server</button>
  </div>
</div>

<!-- INVITE LINK MODAL -->
<div class="modal-overlay" id="inviteModal">
  <div class="modal">
    <button class="modal-close" onclick="closeModal('inviteModal')">Ã—</button>
    <h2>Invite People</h2><p class="modal-desc" id="invite-server-name"></p>
    <div class="form-group">
      <label>Link Expiry</label>
      <select id="invite-expiry">
        <option value="never">Never expires</option>
        <option value="1">1 Day</option>
        <option value="7">7 Days</option>
      </select>
    </div>
    <button class="modal-btn secondary" onclick="generateInvite()">Generate Link</button>
    <div id="invite-link-display" style="display:none">
      <div class="invite-link-box">
        <span id="invite-link-text"></span>
        <button class="copy-btn" onclick="copyInviteLink()">Copy</button>
      </div>
      <p style="font-size:0.76rem;color:var(--muted)" id="invite-expiry-note"></p>
    </div>
  </div>
</div>

<!-- MANAGE ROLES MODAL -->
<div class="modal-overlay" id="rolesModal">
  <div class="modal" style="max-width:520px">
    <button class="modal-close" onclick="closeModal('rolesModal')">Ã—</button>
    <h2>Manage Roles</h2><p class="modal-desc">Create roles, set permissions, and assign them to members.</p>
    <div style="display:flex;gap:10px;margin-bottom:18px">
      <button class="modal-btn secondary" style="flex:none;width:auto;padding:8px 16px" onclick="showRolesTab('list')">Roles</button>
      <button class="modal-btn secondary" style="flex:none;width:auto;padding:8px 16px" onclick="showRolesTab('create')">+ New Role</button>
      <button class="modal-btn secondary" style="flex:none;width:auto;padding:8px 16px" onclick="showRolesTab('members')">Members</button>
    </div>
    <!-- Roles list tab -->
    <div id="roles-tab-list">
      <div id="roles-list-container"></div>
    </div>
    <!-- Create role tab -->
    <div id="roles-tab-create" style="display:none">
      <div class="form-group"><label>Role Name</label><input type="text" id="new-role-name" placeholder="e.g. Moderator"/></div>
      <div class="form-group">
        <label>Role Color</label>
        <div style="display:flex;gap:8px;flex-wrap:wrap" id="role-color-picker">
          <div class="role-color-swatch selected" data-color="#5b6af0" style="width:28px;height:28px;border-radius:50%;background:#5b6af0;cursor:pointer;border:3px solid #fff"></div>
          <div class="role-color-swatch" data-color="#e040fb" style="width:28px;height:28px;border-radius:50%;background:#e040fb;cursor:pointer;border:3px solid transparent"></div>
          <div class="role-color-swatch" data-color="#ff7043" style="width:28px;height:28px;border-radius:50%;background:#ff7043;cursor:pointer;border:3px solid transparent"></div>
          <div class="role-color-swatch" data-color="#23d18b" style="width:28px;height:28px;border-radius:50%;background:#23d18b;cursor:pointer;border:3px solid transparent"></div>
          <div class="role-color-swatch" data-color="#ffa726" style="width:28px;height:28px;border-radius:50%;background:#ffa726;cursor:pointer;border:3px solid transparent"></div>
          <div class="role-color-swatch" data-color="#f59e0b" style="width:28px;height:28px;border-radius:50%;background:#f59e0b;cursor:pointer;border:3px solid transparent"></div>
          <div class="role-color-swatch" data-color="#00bcd4" style="width:28px;height:28px;border-radius:50%;background:#00bcd4;cursor:pointer;border:3px solid transparent"></div>
          <div class="role-color-swatch" data-color="#ff5f57" style="width:28px;height:28px;border-radius:50%;background:#ff5f57;cursor:pointer;border:3px solid transparent"></div>
        </div>
      </div>
      <div class="form-group"><label>Permissions</label></div>
      <div class="perm-toggle"><span>Admin (can edit server, manage channels)</span><label class="toggle-switch"><input type="checkbox" id="perm-admin"/><span class="toggle-slider"></span></label></div>
      <div class="perm-toggle"><span>Manage Roles</span><label class="toggle-switch"><input type="checkbox" id="perm-manage-roles"/><span class="toggle-slider"></span></label></div>
      <div class="perm-toggle"><span>Send Messages</span><label class="toggle-switch"><input type="checkbox" id="perm-send" checked/><span class="toggle-slider"></span></label></div>
      <div class="perm-toggle"><span>View Channels</span><label class="toggle-switch"><input type="checkbox" id="perm-view" checked/><span class="toggle-slider"></span></label></div>
      <div class="perm-toggle"><span>Attach Files</span><label class="toggle-switch"><input type="checkbox" id="perm-files" checked/><span class="toggle-slider"></span></label></div>
      <button class="modal-btn" style="margin-top:16px" onclick="createRole()">Create Role</button>
    </div>
    <!-- Members tab -->
    <div id="roles-tab-members" style="display:none">
      <div id="members-roles-list"></div>
    </div>
  </div>
</div>

<!-- CHANNEL PERMISSIONS MODAL -->
<div class="modal-overlay" id="channelPermModal">
  <div class="modal" style="max-width:480px">
    <button class="modal-close" onclick="closeModal('channelPermModal')">Ã—</button>
    <h2>Channel Permissions</h2><p class="modal-desc" id="ch-perm-name"></p>
    <div class="form-group"><label>Who can view this channel?</label>
      <select id="ch-perm-view-select"><option value="everyone">Everyone</option><option value="role">Specific Role Only</option></select>
    </div>
    <div id="ch-perm-role-group" style="display:none" class="form-group">
      <label>Required Role</label>
      <select id="ch-perm-role-select"></select>
    </div>
    <div class="form-group"><label>Who can send messages?</label>
      <select id="ch-perm-send-select"><option value="everyone">Everyone</option><option value="role">Specific Role Only</option></select>
    </div>
    <div id="ch-perm-send-role-group" style="display:none" class="form-group">
      <label>Required Role for Sending</label>
      <select id="ch-perm-send-role-select"></select>
    </div>
    <button class="modal-btn" onclick="saveChannelPerms()">Save Permissions</button>
  </div>
</div>

<!-- PROFILE MODAL -->
<div class="modal-overlay" id="profileModal">
  <div class="modal">
    <button class="modal-close" onclick="closeModal('profileModal')">Ã—</button>
    <h2>Edit Profile</h2><p>Customize how others see you on Nexus.</p>
    <div class="avatar-upload-area">
      <div class="avatar-preview" id="profile-avatar-preview"></div>
      <div class="avatar-upload-btns">
        <button class="upload-btn" onclick="document.getElementById('avatar-file-input').click()">Upload Photo</button>
        <button class="remove-btn" onclick="removeAvatar()">Remove</button>
        <p>JPG, PNG or GIF Â· Max 8MB</p>
      </div>
    </div>
    <input type="file" id="avatar-file-input" accept="image/*" style="display:none" onchange="handleAvatarUpload(event)"/>
    <div class="form-group"><label>Display Name</label><input type="text" id="display-name-input" placeholder="Your display name"/></div>
    <div class="form-group"><label>Bio</label><textarea id="bio-input" rows="3" placeholder="Tell people a little about yourself..."></textarea></div>
    <div class="form-group">
      <label>Status</label>
      <div class="status-selector">
        <div class="status-option selected" data-status="online" onclick="selectStatus(this)"><div class="status-pip" style="background:var(--online)"></div>Online</div>
        <div class="status-option" data-status="idle" onclick="selectStatus(this)"><div class="status-pip" style="background:var(--idle)"></div>Idle</div>
        <div class="status-option" data-status="dnd" onclick="selectStatus(this)"><div class="status-pip" style="background:var(--dnd)"></div>Do Not Disturb</div>
        <div class="status-option" data-status="invisible" onclick="selectStatus(this)"><div class="status-pip" style="background:var(--muted)"></div>Invisible</div>
      </div>
    </div>
    <div class="form-group"><label>Username (cannot be changed)</label><input type="text" id="username-readonly" disabled/></div>
    <div class="modal-btn-row" style="margin-bottom:20px">
      <button class="modal-btn secondary" onclick="closeModal('profileModal')">Cancel</button>
      <button class="modal-btn" onclick="saveProfile()">Save Changes</button>
    </div>
    <div class="danger-zone">
      <h4>âš ï¸ Danger Zone</h4>
      <p>Deleting your account removes your profile. Messages will show as "Deleted User". This cannot be undone.</p>
      <button class="modal-btn danger" onclick="confirmDeleteAccount()">Delete My Account</button>
    </div>
  </div>
</div>

<!-- CONFIRM DELETE ACCOUNT -->
<div class="modal-overlay" id="deleteAccountModal">
  <div class="modal" style="max-width:400px">
    <button class="modal-close" onclick="closeModal('deleteAccountModal')">Ã—</button>
    <h2>Delete Account</h2><p>Are you absolutely sure? Type DELETE to confirm.</p>
    <div class="form-group"><input type="text" id="delete-confirm-input" placeholder="DELETE"/></div>
    <div class="modal-btn-row">
      <button class="modal-btn secondary" onclick="closeModal('deleteAccountModal')">Cancel</button>
      <button class="modal-btn danger" onclick="deleteAccount()">Yes, Delete</button>
    </div>
  </div>
</div>

<!-- CALL MODAL -->
<div class="modal-overlay" id="callModal">
  <div class="modal" style="max-width:320px;text-align:center;">
    <div class="call-display">
      <div class="call-avatar" id="call-avatar"></div>
      <div class="call-name" id="call-name"></div>
      <div class="call-status" id="call-status">Calling...</div>
      <div class="call-actions">
        <button class="call-action-btn mute">ğŸ¤</button>
        <button class="call-action-btn end" onclick="endCall()">ğŸ“µ</button>
        <button class="call-action-btn video">ğŸ“·</button>
      </div>
    </div>
  </div>
</div>

<!-- ADD FRIEND -->
<div class="modal-overlay" id="addFriendModal">
  <div class="modal">
    <button class="modal-close" onclick="closeModal('addFriendModal')">Ã—</button>
    <h2>Add Friend</h2><p>Add friends with their Nexus username.</p>
    <div class="add-result" id="add-friend-result-modal"></div>
    <div class="form-group"><label>Username</label><input type="text" id="add-friend-input-modal" placeholder="e.g. cool_user"/></div>
    <button class="modal-btn" onclick="sendFriendRequest()">Send Friend Request</button>
  </div>
</div>

<!-- ADMIN ACTION -->
<div class="modal-overlay" id="adminActionModal">
  <div class="modal" style="max-width:420px">
    <button class="modal-close" onclick="closeModal('adminActionModal')">Ã—</button>
    <h2 id="admin-action-title"></h2><p class="modal-desc" id="admin-action-desc"></p>
    <div class="form-group" id="admin-reason-group"><label>Reason</label><textarea id="admin-reason-input" rows="3" placeholder="Enter a reason..."></textarea></div>
    <div class="form-group" id="admin-date-group" style="display:none"><label>Ban Until</label><input type="date" id="admin-ban-until"/></div>
    <div class="modal-btn-row">
      <button class="modal-btn secondary" onclick="closeModal('adminActionModal')">Cancel</button>
      <button class="modal-btn" id="admin-action-confirm-btn" onclick="executeAdminAction()">Confirm</button>
    </div>
  </div>
</div>

<!-- â•â•â• LAYOUT â•â•â• -->
<div class="servers-bar" id="servers-bar">
  <div class="server-icon home active" onclick="showView()" title="Home"><span class="server-pip"></span>âŒ‚</div>
  <div class="server-divider"></div>
  <div class="server-icon add" id="add-server-btn" onclick="showServerOptions()" title="Add/Join Server">+</div>
</div>

<div class="sidebar" id="sidebar">
  <div class="sidebar-header">
    <span id="sidebar-title">ğŸ’¬ Direct Messages</span>
    <button class="icon-btn" id="sidebar-action-btn" onclick="openModal('addFriendModal')" title="Add Friend" style="font-size:1.1rem">+</button>
  </div>
  <div class="sidebar-search"><input type="text" id="sidebar-search-input" placeholder="Search..." oninput="filterSidebar()"/></div>
  <div class="sidebar-scroll" id="sidebar-scroll">
    <div class="sidebar-section-label">Friends</div>
    <div id="dm-list"></div>
  </div>
  <div class="user-panel" onclick="openProfileModal()">
    <div class="user-panel-avatar" id="sidebar-avatar"></div>
    <div class="user-panel-info">
      <div class="user-panel-name" id="sidebar-display-name">Loading...</div>
      <div class="user-panel-tag" id="sidebar-username">@...</div>
    </div>
    <div class="user-panel-actions">
      <button class="icon-btn" onclick="event.stopPropagation();openProfileModal()">âš™ï¸</button>
      <button class="icon-btn" onclick="event.stopPropagation();handleSignOut()">ğŸšª</button>
    </div>
  </div>
</div>

<div class="main">
  <div class="main-header" id="main-header">
    <button class="hamburger" id="hamburger-btn" onclick="toggleMobileSidebar()">â˜°</button>
    <span>ğŸ‘¥</span><h2>Friends</h2>
    <div class="header-tabs">
      <button class="tab active" onclick="switchTab(this,'online')">Online</button>
      <button class="tab" onclick="switchTab(this,'all')">All</button>
      <button class="tab" onclick="switchTab(this,'pending')">Pending&nbsp;<span id="pending-count" style="display:none" class="pending-badge">0</span></button>
    </div>
    <button class="add-friend-btn" onclick="openModal('addFriendModal')">+ Add Friend</button>
  </div>
  <div class="main-content" id="main-content">
    <div class="empty-state"><div class="empty-icon">ğŸ‘‹</div><h3>Welcome to Nexus!</h3><p>Add friends to get started.</p></div>
  </div>
</div>

<div class="profile-panel hidden" id="profile-panel">
  <div class="pp-banner" id="pp-banner">
    <button class="pp-close-btn" onclick="document.getElementById('profile-panel').classList.add('hidden')">Ã—</button>
  </div>
  <div class="pp-body">
    <div class="pp-avatar-wrap"><div class="pp-avatar" id="pp-avatar"></div><div class="pp-status-badge" id="pp-status-badge"></div></div>
    <div class="pp-name" id="pp-name"></div>
    <div class="pp-username" id="pp-username"></div>
    <div class="pp-status-line" id="pp-status-line"></div>
    <div class="pp-divider"></div>
    <div id="pp-bio-wrap" style="display:none"><div class="pp-section-title">About Me</div><div class="pp-bio" id="pp-bio"></div><div class="pp-divider"></div></div>
    <div class="pp-section-title">Member Since</div>
    <div class="pp-since" id="pp-since"></div>
    <button class="pp-dm-btn" id="pp-dm-btn" style="display:none" onclick="openDmFromPanel()">ğŸ’¬ Send Message</button>
  </div>
</div>

<!-- MOBILE BOTTOM NAV -->
<div class="mobile-nav" id="mobile-nav">
  <button class="mobile-nav-btn active" id="mnav-home" onclick="mobileNav('home',this)">ğŸ <span>Home</span></button>
  <button class="mobile-nav-btn mobile-nav-badge" id="mnav-dms" data-badge="" onclick="mobileNav('dms',this)">ğŸ’¬<span>DMs</span></button>
  <button class="mobile-nav-btn" id="mnav-servers" onclick="mobileNav('servers',this)">ğŸ°<span>Servers</span></button>
  <button class="mobile-nav-btn" id="mnav-profile" onclick="openProfileModal()">ğŸ‘¤<span>Profile</span></button>
</div>

<input type="file" id="dm-file-input" style="display:none" accept="image/*,video/*,audio/*,.pdf,.doc,.docx,.txt,.zip,.rar" onchange="handleDmFileUpload(event)"/>
<input type="file" id="ch-file-input" style="display:none" accept="image/*,video/*,audio/*,.pdf,.doc,.docx,.txt,.zip,.rar" onchange="handleChFileUpload(event)"/>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut, deleteUser } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc, collection, query, where, getDocs, addDoc, onSnapshot, orderBy, serverTimestamp, limit } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

  const CLOUDINARY_CLOUD = 'dskssf3tn';
  const CLOUDINARY_PRESET = 'nexus_avatars';
  const ADMIN_USERNAMES = ['rivalsonts', 'ds64'];
  const BASE_URL = window.location.origin + window.location.pathname.replace('dashboard.html','');

  const app = initializeApp({
    apiKey: "AIzaSyDKGqss5jcCNd_AYYohYs-KaSKvZUemX-4",
    authDomain: "nexus-app-74493.firebaseapp.com",
    projectId: "nexus-app-74493",
    storageBucket: "nexus-app-74493.firebasestorage.app",
    messagingSenderId: "179885556901",
    appId: "1:179885556901:web:1966afe8102de60d9cb94c"
  });
  const auth = getAuth(app);
  const db = getFirestore(app);

  let currentUser = null, currentProfile = null, pendingAvatarDataUrl = null;
  let currentDmFriend = null, dmUnsubscribe = null, chUnsubscribe = null;
  let selectedStatus = 'online', isAdmin = false;
  let adminActionTarget = null, adminActionType = null;
  let currentServer = null, currentChannel = null;
  let selectedRoleColor = '#5b6af0';
  let currentChannelForPerms = null;
  let typingTimeout = null, typingUnsubscribe = null;
  let currentInviteServerData = null;
  let profilePanelUser = null;

  // â”€â”€ AUTH â”€â”€
  onAuthStateChanged(auth, async user => {
    if (!user) { window.location.href = 'index.html'; return; }
    currentUser = user;
    await loadProfile();

    // Check ban
    const banSnap = await getDoc(doc(db,'bans',currentUser.uid));
    if (banSnap.exists()) {
      const ban = banSnap.data();
      if (ban.type === 'permanent') { await signOut(auth); window.location.href = 'index.html'; return; }
      if (ban.type === 'temporary' && ban.until) {
        const until = ban.until.toDate ? ban.until.toDate() : new Date(ban.until);
        if (new Date() < until) { await signOut(auth); window.location.href = 'index.html'; return; }
        else await deleteDoc(doc(db,'bans',currentUser.uid));
      }
    }

    isAdmin = ADMIN_USERNAMES.includes(currentProfile.username);
    if (isAdmin) addAdminButton();

    try { await updateDoc(doc(db,'users',currentUser.uid), { status: currentProfile.manualStatus || 'online' }); } catch(e){}
    await loadFriends();
    await loadServers();

    // Check for invite in URL
    const urlParams = new URLSearchParams(window.location.search);
    const inviteCode = urlParams.get('invite');
    if (inviteCode) handleInviteFromUrl(inviteCode);

    window.addEventListener('beforeunload', async () => {
      try { await updateDoc(doc(db,'users',currentUser.uid), { status: currentProfile.manualStatus==='invisible'?'invisible':'offline' }); } catch(e){}
    });
  });

  async function loadProfile() {
    const snap = await getDoc(doc(db,'users',currentUser.uid));
    currentProfile = snap.exists() ? snap.data() : { username: currentUser.email, displayName:'', avatarUrl:'', bio:'', status:'online' };
    if (currentProfile.deleted) { await signOut(auth); window.location.href='index.html'; return; }
    selectedStatus = currentProfile.status || 'online';
    updateSidebarUser();
  }

  function updateSidebarUser() {
    const name = currentProfile.displayName || currentProfile.username;
    document.getElementById('sidebar-display-name').textContent = name;
    document.getElementById('sidebar-username').textContent = '@' + currentProfile.username;
    const av = document.getElementById('sidebar-avatar');
    if (currentProfile.avatarUrl) { av.innerHTML = `<img src="${currentProfile.avatarUrl}"/>`; av.style.background = ''; }
    else { av.innerHTML = name[0].toUpperCase(); av.style.background = color(currentProfile.username); }
  }

  // â”€â”€ ADMIN â”€â”€
  function addAdminButton() {
    // Desktop servers bar
    const bar = document.getElementById('servers-bar');
    const addBtn = bar.querySelector('.server-icon.add');
    const adminIcon = document.createElement('div');
    adminIcon.className = 'server-icon admin-icon';
    adminIcon.title = 'Admin Panel';
    adminIcon.innerHTML = `<span class="server-pip"></span>ğŸ›¡ï¸`;
    adminIcon.onclick = () => { document.querySelectorAll('.server-icon').forEach(i=>i.classList.remove('active')); adminIcon.classList.add('active'); showAdminPanel(); };
    bar.insertBefore(adminIcon, addBtn);

    // Mobile bottom nav â€” replace the Servers button with Admin
    const mobileNav = document.getElementById('mobile-nav');
    const adminMobileBtn = document.createElement('button');
    adminMobileBtn.className = 'mobile-nav-btn';
    adminMobileBtn.id = 'mnav-admin';
    adminMobileBtn.innerHTML = `ğŸ›¡ï¸<span>Admin</span>`;
    adminMobileBtn.onclick = () => {
      document.querySelectorAll('.mobile-nav-btn').forEach(b=>b.classList.remove('active'));
      adminMobileBtn.classList.add('active');
      closeMobileSidebar();
      showAdminPanel();
    };
    // Insert before the profile button
    const profileBtn = document.getElementById('mnav-profile');
    mobileNav.insertBefore(adminMobileBtn, profileBtn);
  }

  window.showAdminPanel = async function() {
    if (!isAdmin) return;
    document.getElementById('profile-panel').classList.add('hidden');
    document.getElementById('main-content').className='main-content chat-mode';
    document.getElementById('main-header').innerHTML = `<button class="hamburger" onclick="toggleMobileSidebar()">â˜°</button><span>ğŸ›¡ï¸</span><h2 style="color:var(--admin)">Admin Panel</h2>`;
    document.getElementById('main-content').innerHTML = `
      <div style="display:flex;flex-direction:column;height:100%">
        <div class="admin-toolbar">
          <input class="admin-search" id="admin-search" placeholder="Search username or email..." oninput="filterAdminUsers()"/>
          <select class="admin-filter" id="admin-filter" onchange="filterAdminUsers()">
            <option value="all">All</option><option value="active">Active</option>
            <option value="banned">Banned</option><option value="warned">Warned</option><option value="deleted">Deleted</option>
          </select>
        </div>
        <div class="admin-stats" id="admin-stats">
          <div class="admin-stat"><div class="admin-stat-num" id="stat-total">â€”</div><div class="admin-stat-label">Total</div></div>
          <div class="admin-stat"><div class="admin-stat-num" id="stat-active" style="color:var(--success)">â€”</div><div class="admin-stat-label">Active</div></div>
          <div class="admin-stat"><div class="admin-stat-num" id="stat-banned" style="color:var(--error)">â€”</div><div class="admin-stat-label">Banned</div></div>
          <div class="admin-stat"><div class="admin-stat-num" id="stat-deleted" style="color:var(--muted)">â€”</div><div class="admin-stat-label">Deleted</div></div>
        </div>
        <div class="admin-table-header"><div>User</div><div>Email</div><div>Joined</div><div>Status</div><div>Actions</div></div>
        <div class="admin-table" id="admin-user-list"><div class="admin-empty">Loading...</div></div>
      </div>`;
    await loadAdminUsers();
  };

  let allAdminUsers = [];
  async function loadAdminUsers() {
    const [usersSnap, bansSnap] = await Promise.all([getDocs(collection(db,'users')), getDocs(collection(db,'bans'))]);
    const bans = {}; bansSnap.docs.forEach(d => { bans[d.id] = d.data(); });
    allAdminUsers = usersSnap.docs.map(d => ({ id: d.id, ...d.data(), ban: bans[d.id] || null }));
    const total = allAdminUsers.length;
    const banned = allAdminUsers.filter(u => u.ban && (u.ban.type==='permanent'||u.ban.type==='temporary')).length;
    const deleted = allAdminUsers.filter(u => u.deleted).length;
    const el = id => document.getElementById(id);
    if (el('stat-total')) { el('stat-total').textContent=total; el('stat-active').textContent=total-banned-deleted; el('stat-banned').textContent=banned; el('stat-deleted').textContent=deleted; }
    renderAdminUsers(allAdminUsers);
  }

  window.filterAdminUsers = function() {
    const search=(document.getElementById('admin-search')?.value||'').toLowerCase();
    const filter=document.getElementById('admin-filter')?.value||'all';
    let users=allAdminUsers;
    if (search) users=users.filter(u=>(u.username||'').includes(search)||(u.email||'').includes(search)||(u.displayName||'').includes(search));
    if (filter==='active') users=users.filter(u=>!u.deleted&&!u.ban);
    else if (filter==='banned') users=users.filter(u=>u.ban&&(u.ban.type==='permanent'||u.ban.type==='temporary'));
    else if (filter==='warned') users=users.filter(u=>u.ban&&u.ban.type==='warning');
    else if (filter==='deleted') users=users.filter(u=>u.deleted);
    renderAdminUsers(users);
  };

  function renderAdminUsers(users) {
    const list=document.getElementById('admin-user-list'); if(!list) return;
    if (!users.length) { list.innerHTML='<div class="admin-empty">No users found.</div>'; return; }
    list.innerHTML='';
    users.forEach(u => {
      const name=u.displayName||u.username||'Unknown';
      const joined=u.createdAt?new Date(u.createdAt).toLocaleDateString():'â€”';
      const isSelf=u.id===currentUser.uid, isAdminAcc=ADMIN_USERNAMES.includes(u.username);
      let badge='';
      if (u.deleted) badge=`<span class="admin-badge badge-deleted">Deleted</span>`;
      else if (u.ban?.type==='permanent') badge=`<span class="admin-badge badge-banned">Banned</span>`;
      else if (u.ban?.type==='temporary') badge=`<span class="admin-badge badge-temp">Temp Ban</span>`;
      else if (u.ban?.type==='warning') badge=`<span class="admin-badge badge-warned">Warned</span>`;
      else badge=`<span class="admin-badge badge-active">Active</span>`;
      let actions='';
      if (!isSelf&&!isAdminAcc&&!u.deleted) {
        const hasBan=u.ban&&(u.ban.type==='permanent'||u.ban.type==='temporary');
        actions=`<button class="admin-btn admin-btn-warn" onclick="openAdminAction('${u.id}','warn','${esc(name)}')">âš ï¸</button><button class="admin-btn admin-btn-temp" onclick="openAdminAction('${u.id}','temp','${esc(name)}')">â³</button>${hasBan?`<button class="admin-btn admin-btn-unban" onclick="openAdminAction('${u.id}','unban','${esc(name)}')">âœ“</button>`:`<button class="admin-btn admin-btn-ban" onclick="openAdminAction('${u.id}','ban','${esc(name)}')">ğŸ”¨</button>`}<button class="admin-btn admin-btn-delete" onclick="openAdminAction('${u.id}','admindelete','${esc(name)}')">ğŸ—‘</button>`;
      } else if (isSelf) actions=`<span style="font-size:0.72rem;color:var(--muted)">You</span>`;
      else if (isAdminAcc) actions=`<span style="font-size:0.72rem;color:var(--admin)">Admin ğŸ›¡ï¸</span>`;
      else if (u.deleted) actions=`<span style="font-size:0.72rem;color:var(--muted)">Deleted</span>`;
      const row=document.createElement('div'); row.className='admin-user-row';
      row.innerHTML=`<div class="admin-user-info"><div class="admin-avatar" style="background:${color(u.username||'x')}">${u.avatarUrl?`<img src="${u.avatarUrl}"/>`:((name[0]||'?').toUpperCase())}</div><div><div class="admin-user-name">${esc(name)}</div><div class="admin-user-tag">@${u.username||'â€”'}</div></div></div><div style="font-size:0.78rem;color:var(--muted);overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(u.email||'â€”')}</div><div style="font-size:0.78rem;color:var(--muted)">${joined}</div><div>${badge}</div><div class="admin-actions">${actions}</div>`;
      list.appendChild(row);
      if (u.ban?.reason) { const r=document.createElement('div'); r.style.cssText='padding:3px 20px 8px 62px;font-size:0.74rem;color:var(--muted);border-bottom:1px solid var(--border)'; r.textContent=`Reason: ${u.ban.reason}`; list.appendChild(r); }
    });
  }

  window.openAdminAction = function(uid,type,name) {
    adminActionTarget=uid; adminActionType=type;
    const titles={warn:'âš ï¸ Warn User',temp:'â³ Temporary Ban',ban:'ğŸ”¨ Permanent Ban',unban:'âœ“ Unban User',admindelete:'ğŸ—‘ Delete Account'};
    const descs={warn:`Issue a warning to <strong>${name}</strong>. Their account stays active.`,temp:`Temporarily ban <strong>${name}</strong>.`,ban:`Permanently ban <strong>${name}</strong>.`,unban:`Remove all bans from <strong>${name}</strong>.`,admindelete:`Soft-delete <strong>${name}</strong>'s account.`};
    document.getElementById('admin-action-title').textContent=titles[type];
    document.getElementById('admin-action-desc').innerHTML=descs[type];
    document.getElementById('admin-reason-input').value='';
    document.getElementById('admin-date-group').style.display=type==='temp'?'flex':'none';
    document.getElementById('admin-reason-group').style.display=type==='unban'?'none':'flex';
    const btn=document.getElementById('admin-action-confirm-btn');
    btn.className='modal-btn'+(type==='ban'||type==='admindelete'?' danger':type==='unban'?' secondary':'');
    btn.textContent=type==='unban'?'Remove Ban':type==='admindelete'?'Delete':'Confirm';
    openModal('adminActionModal');
  };
  window.executeAdminAction = async function() {
    const uid=adminActionTarget, type=adminActionType;
    const reason=document.getElementById('admin-reason-input')?.value.trim()||'';
    try {
      if (type==='warn') await setDoc(doc(db,'bans',uid),{type:'warning',reason,issuedBy:currentUser.uid,issuedAt:serverTimestamp()});
      else if (type==='temp') { const until=document.getElementById('admin-ban-until').value; if(!until){showToast('Select a date','error');return;} await setDoc(doc(db,'bans',uid),{type:'temporary',reason,until:new Date(until),issuedBy:currentUser.uid,issuedAt:serverTimestamp()}); }
      else if (type==='ban') await setDoc(doc(db,'bans',uid),{type:'permanent',reason,issuedBy:currentUser.uid,issuedAt:serverTimestamp()});
      else if (type==='unban') await deleteDoc(doc(db,'bans',uid));
      else if (type==='admindelete') await updateDoc(doc(db,'users',uid),{deleted:true,deletedAt:serverTimestamp(),displayName:'Deleted User',avatarUrl:'',bio:''});
      showToast('Done!','success'); closeModal('adminActionModal'); await loadAdminUsers();
    } catch(e) { showToast('Error: '+e.message,'error'); }
  };

  // â”€â”€ FRIENDS â”€â”€
  async function loadFriends() {
    const snap = await getDocs(query(collection(db,'friendships'),where('users','array-contains',currentUser.uid),where('status','==','accepted')));
    const friends = [];
    for (const d of snap.docs) {
      const friendId = d.data().users.find(id=>id!==currentUser.uid);
      const fs = await getDoc(doc(db,'users',friendId));
      if (fs.exists()) friends.push({id:friendId,...fs.data()});
    }
    window._friends = friends;
    renderDmList(friends);
    renderFriendsView(friends);
    await loadPendingRequests();
  }

  function statusColor(s) { return s==='online'?'var(--online)':s==='idle'?'var(--idle)':s==='dnd'?'var(--dnd)':'var(--muted)'; }
  function statusLabel(s) { return {online:'Online',idle:'Idle',dnd:'Do Not Disturb',invisible:'Offline',offline:'Offline'}[s]||'Offline'; }
  function visibleStatus(s) { return s==='invisible'?'offline':(s||'offline'); }

  function renderDmList(friends) {
    const list=document.getElementById('dm-list'); list.innerHTML='';
    if (!friends.length) { list.innerHTML='<div style="padding:8px 16px;font-size:0.78rem;color:var(--muted)">No friends yet</div>'; return; }
    friends.forEach(f => {
      const name=f.deleted?'Deleted User':(f.displayName||f.username);
      const vs=f.deleted?'offline':visibleStatus(f.status);
      const div=document.createElement('div'); div.className='sidebar-item';
      div.innerHTML=`<div class="item-avatar" style="background:${f.deleted?'var(--muted)':color(f.username)}">${f.avatarUrl&&!f.deleted?`<img src="${f.avatarUrl}"/>`:name[0].toUpperCase()}<span class="status-dot ${vs}"></span></div><span style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap${f.deleted?';color:var(--muted)':''}">${name}</span>`;
      div.onclick=()=>{ closeMobileSidebar(); openDm(f); };
      list.appendChild(div);
    });
  }

  function renderFriendsView(friends) {
    const content=document.getElementById('main-content'); content.className='main-content';
    if (!friends.length) { content.innerHTML=`<div class="empty-state"><div class="empty-icon">ğŸ¤</div><h3>No friends yet</h3><p>Add friends by clicking "+ Add Friend".</p></div>`; return; }
    content.innerHTML=`<div class="friends-list"></div>`;
    friends.forEach(f => {
      const name=f.deleted?'Deleted User':(f.displayName||f.username);
      const vs=f.deleted?'offline':visibleStatus(f.status);
      const row=document.createElement('div'); row.className='friend-row';
      row.innerHTML=`
        <div class="friend-avatar" style="background:${f.deleted?'var(--muted)':color(f.username||'x')};cursor:${f.deleted?'default':'pointer'}">
          ${f.avatarUrl&&!f.deleted?`<img src="${f.avatarUrl}"/>`:`${name[0].toUpperCase()}`}
          <span class="status-dot ${vs}" style="position:absolute;bottom:0;right:0;border-color:var(--bg)"></span>
        </div>
        <div class="friend-info" style="cursor:${f.deleted?'default':'pointer'}">
          <div class="friend-name" style="${f.deleted?'color:var(--muted)':''}">${name}</div>
          <div class="friend-status">${f.deleted?'Account deleted':statusLabel(vs)}</div>
        </div>
        <div class="friend-actions">
          <button class="friend-btn dm-btn" title="Message">ğŸ’¬</button>
          ${!f.deleted?`<button class="friend-btn call-btn" title="Call">ğŸ“</button>`:''}
        </div>`;
      if (!f.deleted) {
        row.querySelector('.friend-avatar').addEventListener('click', ()=>showProfilePanel(f));
        row.querySelector('.friend-info').addEventListener('click', ()=>showProfilePanel(f));
      }
      row.querySelector('.dm-btn').addEventListener('click', ()=>openDm(f));
      if (!f.deleted) { const cb=row.querySelector('.call-btn'); if(cb) cb.addEventListener('click', ()=>startCall(f)); }
      document.querySelector('.friends-list').appendChild(row);
    });
  }

  // â”€â”€ PROFILE PANEL â”€â”€
  window.showProfilePanel = function(f) {
    if (!f || f.deleted) return;
    profilePanelUser=f;
    const name=f.displayName||f.username, vs=visibleStatus(f.status);
    const isMobile=window.innerWidth<=680;
    if (isMobile) {
      const existing=document.getElementById('mobile-profile-sheet');
      if (existing) existing.remove();
      const ov=document.getElementById('mobile-profile-overlay');
      if (ov) ov.remove();
      const sheet=document.createElement('div');
      sheet.id='mobile-profile-sheet';
      sheet.style.cssText='position:fixed;bottom:var(--mobile-nav-h);left:0;right:0;background:var(--surface);border-top:1px solid var(--border);border-radius:20px 20px 0 0;z-index:400;max-height:80vh;overflow-y:auto;box-shadow:0 -8px 32px rgba(0,0,0,0.5);animation:slideUp 0.25s ease';
      const since=f.createdAt?new Date(f.createdAt).toLocaleDateString('en-US',{month:'long',day:'numeric',year:'numeric'}):'Unknown';
      const dmLine=f.id&&f.id!==currentUser.uid?`<button id="profile-sheet-dm-btn" style="width:100%;padding:11px;background:var(--accent);color:#fff;border:none;border-radius:8px;font-family:'DM Sans',sans-serif;font-size:0.88rem;font-weight:600;cursor:pointer">ğŸ’¬ Send Message</button>`:'';
      sheet.innerHTML=`<div style="width:40px;height:4px;background:var(--border);border-radius:2px;margin:12px auto 0"></div><div style="height:80px;background:linear-gradient(135deg,${color(f.username)},${color(f.username+'2')});border-radius:18px 18px 0 0;margin-top:-4px;position:relative"><button id="profile-sheet-close" style="position:absolute;top:10px;right:12px;background:rgba(0,0,0,0.3);border:none;color:#fff;width:26px;height:26px;border-radius:50%;cursor:pointer;font-size:1rem">Ã—</button></div><div style="padding:0 20px 24px"><div style="margin-top:-28px;margin-bottom:10px"><div style="width:56px;height:56px;border-radius:50%;border:4px solid var(--surface);background:${color(f.username)};display:flex;align-items:center;justify-content:center;font-weight:700;font-size:1.2rem;color:#fff;overflow:hidden;position:relative">${f.avatarUrl?'<img src="'+f.avatarUrl+'" style="width:100%;height:100%;object-fit:cover"/>':name[0].toUpperCase()}<span style="position:absolute;bottom:0;right:0;width:14px;height:14px;border-radius:50%;border:3px solid var(--surface);background:${statusColor(vs)}"></span></div></div><div style="font-family:Syne,sans-serif;font-weight:700;font-size:1.1rem">${name}</div><div style="font-size:0.8rem;color:var(--muted);margin-bottom:4px">@${f.username||''}</div><div style="font-size:0.82rem;color:var(--muted);display:flex;align-items:center;gap:6px;margin-bottom:14px"><span style="width:8px;height:8px;border-radius:50%;background:${statusColor(vs)};display:inline-block"></span>${statusLabel(vs)}</div>${f.bio?'<div style="font-size:0.7rem;font-weight:700;text-transform:uppercase;letter-spacing:0.06em;color:var(--muted);margin-bottom:4px">About Me</div><div style="font-size:0.85rem;color:#c8cce0;line-height:1.6;margin-bottom:12px">'+f.bio+'</div>':''}<div style="font-size:0.7rem;font-weight:700;text-transform:uppercase;letter-spacing:0.06em;color:var(--muted);margin-bottom:4px">Member Since</div><div style="font-size:0.82rem;color:var(--muted);margin-bottom:16px">${since}</div>${dmLine}</div>`;
      document.body.appendChild(sheet);
      sheet.querySelector('#profile-sheet-close').addEventListener('click',()=>{sheet.remove();const o=document.getElementById('mobile-profile-overlay');if(o)o.remove();});
      const dmBtn=sheet.querySelector('#profile-sheet-dm-btn');
      if (dmBtn) dmBtn.addEventListener('click',()=>{sheet.remove();const o=document.getElementById('mobile-profile-overlay');if(o)o.remove();openDm(f);});
      const overlay=document.createElement('div');
      overlay.id='mobile-profile-overlay';
      overlay.style.cssText='position:fixed;inset:0;z-index:399;background:rgba(0,0,0,0.4)';
      overlay.addEventListener('click',()=>{sheet.remove();overlay.remove();});
      document.body.insertBefore(overlay,sheet);
    } else {
      document.getElementById('profile-panel').classList.remove('hidden');
      document.getElementById('pp-banner').style.background=`linear-gradient(135deg,${color(f.username)},${color(f.username+'2')})`;
      const av=document.getElementById('pp-avatar'); av.style.background=color(f.username);
      av.innerHTML=f.avatarUrl?`<img src="${f.avatarUrl}"/>`:name[0].toUpperCase();
      document.getElementById('pp-status-badge').style.background=statusColor(vs);
      document.getElementById('pp-name').textContent=name;
      document.getElementById('pp-username').textContent='@'+f.username;
      document.getElementById('pp-status-line').innerHTML=`<span style="width:8px;height:8px;border-radius:50%;background:${statusColor(vs)};display:inline-block;flex-shrink:0"></span>${statusLabel(vs)}`;
      const bw=document.getElementById('pp-bio-wrap');
      if (f.bio){bw.style.display='block';document.getElementById('pp-bio').textContent=f.bio;}else bw.style.display='none';
      document.getElementById('pp-since').textContent=f.createdAt?new Date(f.createdAt).toLocaleDateString('en-US',{month:'long',day:'numeric',year:'numeric'}):'Unknown';
      document.getElementById('pp-dm-btn').style.display=(!f.id||f.id===currentUser.uid)?'none':'block';
    }
  };
  window.openDmFromPanel=()=>{ if(profilePanelUser) openDm(profilePanelUser); };

  // â”€â”€ PENDING â”€â”€
  async function loadPendingRequests() {
    const snap=await getDocs(query(collection(db,'friendships'),where('to','==',currentUser.uid),where('status','==','pending')));
    window._pendingRequests=[];
    for (const d of snap.docs) {
      const fs=await getDoc(doc(db,'users',d.data().from));
      if (fs.exists()&&!fs.data().deleted) window._pendingRequests.push({docId:d.id,...fs.data(),fromUid:d.data().from});
    }
    const badge=document.getElementById('pending-count');
    if (badge) { if(window._pendingRequests.length){badge.textContent=window._pendingRequests.length;badge.style.display='inline';}else badge.style.display='none'; }
  }

  function renderPendingView() {
    const content=document.getElementById('main-content'); content.className='main-content';
    const reqs=window._pendingRequests||[];
    if (!reqs.length) { content.innerHTML=`<div class="empty-state"><div class="empty-icon">ğŸ“­</div><h3>No pending requests</h3></div>`; return; }
    content.innerHTML=`<div class="friends-list"></div>`;
    reqs.forEach(r => {
      const name=r.displayName||r.username;
      const row=document.createElement('div'); row.className='request-row';
      row.innerHTML=`<div style="width:38px;height:38px;border-radius:50%;background:${color(r.username)};display:flex;align-items:center;justify-content:center;font-weight:700;color:#fff;overflow:hidden;flex-shrink:0">${r.avatarUrl?`<img src="${r.avatarUrl}" style="width:100%;height:100%;object-fit:cover"/>`:name[0].toUpperCase()}</div><div><div style="font-weight:600;font-size:0.9rem">${name}</div><div style="font-size:0.76rem;color:var(--muted)">@${r.username}</div></div><div class="request-actions"><button class="req-btn accept" onclick="acceptRequest('${r.docId}')">âœ“</button><button class="req-btn decline" onclick="declineRequest('${r.docId}')">âœ—</button></div>`;
      document.querySelector('.friends-list').appendChild(row);
    });
  }
  window.acceptRequest=async(docId)=>{ await updateDoc(doc(db,'friendships',docId),{status:'accepted'}); showToast('Friend added! ğŸ‰','success'); await loadFriends(); };
  window.declineRequest=async(docId)=>{ await updateDoc(doc(db,'friendships',docId),{status:'declined'}); showToast('Declined.',''); await loadPendingRequests(); renderPendingView(); };

  window.sendFriendRequest=async function(){
    const input=document.getElementById('add-friend-input-modal'), rb=document.getElementById('add-friend-result-modal');
    const username=input.value.trim().toLowerCase(); rb.className='add-result';
    if (!username) { rb.textContent='Please enter a username.'; rb.className='add-result error'; return; }
    if (username===currentProfile.username) { rb.textContent="You can't add yourself!"; rb.className='add-result error'; return; }
    const usSnap=await getDoc(doc(db,'usernames',username));
    if (!usSnap.exists()) { rb.textContent=`No user found: "${username}".`; rb.className='add-result error'; return; }
    const targetUid=usSnap.data().uid;
    const tSnap=await getDoc(doc(db,'users',targetUid));
    if (tSnap.exists()&&tSnap.data().deleted) { rb.textContent='That account no longer exists.'; rb.className='add-result error'; return; }
    const existSnap=await getDocs(query(collection(db,'friendships'),where('users','array-contains',currentUser.uid)));
    for (const d of existSnap.docs) { if (d.data().users.includes(targetUid)) { rb.textContent=d.data().status==='accepted'?"Already friends!":'Request already sent.'; rb.className='add-result error'; return; } }
    await addDoc(collection(db,'friendships'),{users:[currentUser.uid,targetUid],from:currentUser.uid,to:targetUid,status:'pending',createdAt:serverTimestamp()});
    rb.textContent=`Request sent to @${username}! ğŸ‰`; rb.className='add-result success'; input.value='';
  };

  // â”€â”€ DM â”€â”€
  window.openDm = function(friend) {
    currentDmFriend=friend; currentServer=null; currentChannel=null;
    if (dmUnsubscribe) dmUnsubscribe();
    if (chUnsubscribe) chUnsubscribe();
    if (typingUnsubscribe) typingUnsubscribe();
    document.getElementById('profile-panel').classList.add('hidden');
    const name=friend.deleted?'Deleted User':(friend.displayName||friend.username);
    const vs=friend.deleted?'offline':visibleStatus(friend.status);
    document.getElementById('main-header').innerHTML=`
      <button class="hamburger" onclick="toggleMobileSidebar()">â˜°</button>
      <div style="width:34px;height:34px;border-radius:50%;background:${friend.deleted?'var(--muted)':color(friend.username)};display:flex;align-items:center;justify-content:center;font-weight:700;color:#fff;overflow:hidden;flex-shrink:0${!friend.deleted?';cursor:pointer':''}" ${!friend.deleted?`onclick='showProfilePanel(${sj(friend)})'`:''}>
        ${friend.avatarUrl&&!friend.deleted?`<img src="${friend.avatarUrl}" style="width:100%;height:100%;object-fit:cover"/>`:name[0].toUpperCase()}
      </div>
      <h2 ${!friend.deleted?`style="cursor:pointer" onclick='showProfilePanel(${sj(friend)})'`:''}>${name}</h2>
      <span style="font-size:0.76rem;color:var(--muted)">Â· ${friend.deleted?'Account deleted':statusLabel(vs)}</span>
      ${!friend.deleted?`<button style="margin-left:auto" class="friend-btn" onclick='startCall(${sj(friend)})'>ğŸ“</button><button class="friend-btn" onclick='showProfilePanel(${sj(friend)})'>ğŸ‘¤</button>`:'<span style="margin-left:auto"></span>'}`;
    const content=document.getElementById('main-content');
    content.className='main-content chat-mode';
    content.innerHTML=`<div class="chat-view"><div class="chat-messages" id="chat-messages"></div><div class="typing-indicator" id="typing-indicator"></div>${friend.deleted?`<div class="deactivated-bar">âš ï¸ This account has been deactivated.</div>`:`<div class="chat-input-area"><div class="chat-input-box"><button class="chat-attach-btn" onclick="document.getElementById('dm-file-input').click()">ğŸ“</button><input type="text" id="chat-input" placeholder="Message @${name}" oninput="handleTypingDm()" onkeydown="if(event.key==='Enter')sendMessage()"/><button class="chat-send-btn" onclick="sendMessage()">â¤</button></div></div>`}</div>`;

    const roomId=[currentUser.uid,friend.id].sort().join('_');
    dmUnsubscribe=onSnapshot(query(collection(db,'dms',roomId,'messages'),orderBy('createdAt')), snap => {
      const container=document.getElementById('chat-messages'); if(!container) return;
      container.innerHTML='';
      if (snap.empty) { container.innerHTML=`<div class="empty-state" style="flex:1"><div class="empty-icon">ğŸ‘‹</div><h3>${friend.deleted?'Conversation history':'Start the conversation!'}</h3></div>`; return; }
      snap.docs.forEach(d => renderMsg(d.data(), container, friend));
      container.scrollTop=container.scrollHeight;
    });

    // Typing indicator listener
    if (!friend.deleted) {
      typingUnsubscribe=onSnapshot(doc(db,'typing',roomId), snap => {
        const data=snap.data()||{};
        const others=Object.entries(data).filter(([uid,v])=>uid!==currentUser.uid&&v===true);
        const ti=document.getElementById('typing-indicator'); if(!ti) return;
        if (others.length) { ti.innerHTML=`${name} is typing<span class="typing-dots"><span></span><span></span><span></span></span>`; }
        else ti.innerHTML='';
      });
    }
  };

  function renderMsg(data, container, friendOrChannel) {
    const isMe=data.senderId===currentUser.uid;
    const senderIsDeletedUser=!isMe&&friendOrChannel?.deleted;
    const sName=isMe?(currentProfile.displayName||currentProfile.username):(senderIsDeletedUser?'Deleted User':(friendOrChannel?.displayName||friendOrChannel?.username||'Unknown'));
    const sAvatar=isMe?currentProfile.avatarUrl:(senderIsDeletedUser?'':friendOrChannel?.avatarUrl);
    const sColor=isMe?color(currentProfile.username):(senderIsDeletedUser?'var(--muted)':color(friendOrChannel?.username||'x'));
    const sData=isMe?{...currentProfile,id:currentUser.uid}:friendOrChannel;
    const time=data.createdAt?new Date(data.createdAt.toDate()).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}):'';
    // Role badge
    let roleBadgeHtml='';
    if (data.senderRoleName&&data.senderRoleColor) { roleBadgeHtml=`<span class="role-badge" style="background:${data.senderRoleColor}22;color:${data.senderRoleColor}">${esc(data.senderRoleName)}</span>`; }
    let body='';
    if (data.type==='image') body=`<img class="msg-image" src="${data.fileUrl}" alt="" onclick="openLightbox('${data.fileUrl}')"/>`;
    else if (data.type==='video') body=`<video class="msg-video" controls src="${data.fileUrl}"></video>`;
    else if (data.type==='audio') body=`<audio class="msg-audio" controls src="${data.fileUrl}"></audio>`;
    else if (data.type==='file') body=`<a class="msg-file" href="${data.fileUrl}" target="_blank"><span class="msg-file-icon">${fileIcon(data.fileName||'')}</span><div><div class="msg-file-name">${esc(data.fileName||'File')}</div><div class="msg-file-size">${data.fileSize||''} Â· Download</div></div></a>`;
    else body=`<div class="chat-msg-text">${esc(data.text||'')}</div>`;
    const el=document.createElement('div'); el.className='chat-msg';
    el.innerHTML=`<div class="chat-msg-avatar" style="background:${sColor}" ${sData&&!senderIsDeletedUser?`onclick='showProfilePanel(${sj(sData)})'`:''}>${sAvatar?`<img src="${sAvatar}"/>`:sName[0].toUpperCase()}</div><div class="chat-msg-body"><div class="chat-msg-header">${roleBadgeHtml}<span class="chat-msg-name" ${sData&&!senderIsDeletedUser?`onclick='showProfilePanel(${sj(sData)})'`:''}>${sName}</span><span class="chat-msg-time">${time}</span></div>${body}</div>`;
    container.appendChild(el);
  }

  window.sendMessage=async function(){
    const input=document.getElementById('chat-input'); const text=input?.value.trim();
    if (!text||!currentDmFriend||currentDmFriend.deleted) return;
    input.value='';
    clearTypingDm();
    const roomId=[currentUser.uid,currentDmFriend.id].sort().join('_');
    await addDoc(collection(db,'dms',roomId,'messages'),{text,senderId:currentUser.uid,type:'text',createdAt:serverTimestamp()});
  };

  // DM typing
  function handleTypingDm() {
    if (!currentDmFriend) return;
    const roomId=[currentUser.uid,currentDmFriend.id].sort().join('_');
    setDoc(doc(db,'typing',roomId),{[currentUser.uid]:true},{merge:true}).catch(()=>{});
    clearTimeout(typingTimeout);
    typingTimeout=setTimeout(()=>clearTypingDm(),3000);
  }
  function clearTypingDm() {
    if (!currentDmFriend) return;
    const roomId=[currentUser.uid,currentDmFriend.id].sort().join('_');
    setDoc(doc(db,'typing',roomId),{[currentUser.uid]:false},{merge:true}).catch(()=>{});
  }

  // â”€â”€ FILE UPLOAD (DM) â”€â”€
  window.handleDmFileUpload=async function(event){ await uploadAndSend(event,'dm'); };
  window.handleChFileUpload=async function(event){ await uploadAndSend(event,'channel'); };

  async function uploadAndSend(event, mode) {
    const file=event.target.files[0]; event.target.value='';
    if (!file) return;
    const target=mode==='dm'?currentDmFriend:currentChannel;
    if (!target) return;
    if (file.size>100*1024*1024) { showToast('File must be under 100MB','error'); return; }
    const container=document.getElementById('chat-messages');
    const indicator=document.createElement('div'); indicator.className='upload-progress';
    indicator.innerHTML=`<span>â¬†ï¸ Uploading ${esc(file.name)}...</span><div class="progress-bar"><div class="progress-fill" id="upload-fill"></div></div>`;
    if (container) { container.appendChild(indicator); container.scrollTop=container.scrollHeight; }
    try {
      const fd=new FormData(); fd.append('file',file); fd.append('upload_preset',CLOUDINARY_PRESET); fd.append('resource_type','auto');
      let prog=0;
      const iv=setInterval(()=>{ prog=Math.min(prog+8,85); const el=document.getElementById('upload-fill'); if(el) el.style.width=prog+'%'; },200);
      const res=await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD}/auto/upload`,{method:'POST',body:fd});
      const data=await res.json(); clearInterval(iv);
      if (indicator.parentNode) indicator.remove();
      if (!data.secure_url) throw new Error();
      let ftype='file';
      if (file.type.startsWith('image/')) ftype='image';
      else if (file.type.startsWith('video/')) ftype='video';
      else if (file.type.startsWith('audio/')) ftype='audio';
      if (mode==='dm') {
        const roomId=[currentUser.uid,currentDmFriend.id].sort().join('_');
        await addDoc(collection(db,'dms',roomId,'messages'),{senderId:currentUser.uid,type:ftype,fileUrl:data.secure_url,fileName:file.name,fileSize:fmtSize(file.size),createdAt:serverTimestamp()});
      } else {
        await sendChannelMsg(null, ftype, data.secure_url, file.name, fmtSize(file.size));
      }
    } catch { if(indicator.parentNode) indicator.remove(); showToast('Upload failed.','error'); }
  }

  window.openLightbox=url=>{ document.getElementById('lightbox-img').src=url; document.getElementById('lightbox').classList.add('open'); };

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // â”€â”€ SERVERS â”€â”€
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  window.showServerOptions = function() {
    // Show create or join options
    const menu = document.createElement('div');
    menu.id = 'server-options-menu';
    menu.style.cssText = `position:fixed;z-index:500;background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:8px;box-shadow:0 8px 32px rgba(0,0,0,0.5);min-width:180px`;
    // Position near add button
    const btn = document.getElementById('add-server-btn');
    const rect = btn.getBoundingClientRect();
    menu.style.left = (rect.right + 8) + 'px';
    menu.style.top = rect.top + 'px';
    menu.innerHTML = `
      <div onclick="closeServerOptionsMenu();openModal('createServerModal')" style="padding:10px 14px;cursor:pointer;border-radius:8px;font-size:0.88rem;display:flex;align-items:center;gap:8px;transition:background 0.15s" onmouseover="this.style.background='var(--surface2)'" onmouseout="this.style.background=''">â• Create Server</div>
      <div onclick="closeServerOptionsMenu();openModal('joinServerModal')" style="padding:10px 14px;cursor:pointer;border-radius:8px;font-size:0.88rem;display:flex;align-items:center;gap:8px;transition:background 0.15s" onmouseover="this.style.background='var(--surface2)'" onmouseout="this.style.background=''">ğŸ”— Join via Invite</div>`;
    document.body.appendChild(menu);
    setTimeout(()=>document.addEventListener('click', closeServerOptionsMenu, {once:true}), 10);
  };
  window.closeServerOptionsMenu=()=>{ const m=document.getElementById('server-options-menu'); if(m) m.remove(); };

  async function loadServers() {
    // Load servers where user is owner or member
    const [ownedSnap, memberSnap] = await Promise.all([
      getDocs(query(collection(db,'servers'),where('ownerId','==',currentUser.uid))),
      getDocs(query(collection(db,'serverMembers'),where('userId','==',currentUser.uid)))
    ]);
    const bar=document.getElementById('servers-bar');
    bar.querySelectorAll('.server-icon.user-server').forEach(e=>e.remove());
    const before=bar.querySelector('.server-icon.add');
    const serverIds=new Set();
    const allServers=[];
    ownedSnap.docs.forEach(d=>{ if(!serverIds.has(d.id)){serverIds.add(d.id);allServers.push({id:d.id,...d.data()});}});
    for (const m of memberSnap.docs) {
      const sid=m.data().serverId;
      if (!serverIds.has(sid)) { const ss=await getDoc(doc(db,'servers',sid)); if(ss.exists()){serverIds.add(sid);allServers.push({id:sid,...ss.data()});} }
    }
    window._servers=allServers;
    allServers.forEach(data=>{ const icon=document.createElement('div'); icon.className='server-icon user-server'; icon.style.cssText=`background:${color(data.name)};color:#fff`; icon.title=data.name; icon.innerHTML=`<span class="server-pip"></span>${data.name[0].toUpperCase()}`; icon.onclick=()=>{ document.querySelectorAll('.server-icon').forEach(i=>i.classList.remove('active')); icon.classList.add('active'); window.openServer(data); }; bar.insertBefore(icon,before); });
  }

  window.createServer=async function(){
    const name=document.getElementById('server-name-input').value.trim();
    if (!name) { showToast('Enter a server name','error'); return; }
    const serverRef=await addDoc(collection(db,'servers'),{name,ownerId:currentUser.uid,createdAt:serverTimestamp()});
    // Create default general channel
    await addDoc(collection(db,'channels'),{name:'general',serverId:serverRef.id,type:'text',permissions:{view:'everyone',send:'everyone'},createdAt:serverTimestamp()});
    // Add owner as member with 'Owner' role
    await setDoc(doc(db,'serverMembers',`${serverRef.id}_${currentUser.uid}`),{serverId:serverRef.id,userId:currentUser.uid,role:'owner',joinedAt:serverTimestamp()});
    document.getElementById('server-name-input').value='';
    closeModal('createServerModal'); showToast(`Server "${name}" created! ğŸ‰`,'success');
    await loadServers();
    // Auto-open the new server and jump straight into #general
    const newServerData = { id: serverRef.id, name, ownerId: currentUser.uid };
    await window.openServer(newServerData);
  };

  window.openServer = async function openServer(serverData) {
    try {
    currentServer=serverData; currentChannel=null; currentDmFriend=null;
    if (dmUnsubscribe) dmUnsubscribe();
    if (chUnsubscribe) chUnsubscribe();
    if (typingUnsubscribe) typingUnsubscribe();
    document.getElementById('profile-panel').classList.add('hidden');

    // Check if user is owner or has admin role
    const isOwner=serverData.ownerId===currentUser.uid;
    const memberSnap=await getDoc(doc(db,'serverMembers',`${serverData.id}_${currentUser.uid}`));
    const memberData=memberSnap.exists()?memberSnap.data():{};

    // Load member's assigned role if any
    let memberRoleData=null;
    if (memberData.assignedRoleId) {
      const rSnap=await getDoc(doc(db,'roles',memberData.assignedRoleId));
      if (rSnap.exists()) memberRoleData={id:rSnap.id,...rSnap.data()};
    }
    window._myServerRole=memberRoleData;
    window._isServerOwner=isOwner;
    const canManage=isOwner||(memberRoleData?.permissions?.admin);

    // Load channels
    const channelsSnap=await getDocs(query(collection(db,'channels'),where('serverId','==',serverData.id)));
    const channels=channelsSnap.docs.map(d=>({id:d.id,...d.data()}));
    window._serverChannels=channels;

    // Render sidebar
    document.getElementById('sidebar-title').textContent='# '+serverData.name;
    const actionBtn=document.getElementById('sidebar-action-btn');
    if (canManage) {
      actionBtn.innerHTML='âš™ï¸'; actionBtn.title='Server Settings';
      actionBtn.onclick=()=>showServerSettings(serverData,channels);
    } else {
      actionBtn.innerHTML='ğŸ”—'; actionBtn.title='Invite'; actionBtn.onclick=()=>openInviteModal(serverData);
    }

    const scroll=document.getElementById('sidebar-scroll'); scroll.innerHTML='';
    // Channels list
    const chLabel=document.createElement('div'); chLabel.className='sidebar-section-label';
    chLabel.innerHTML=`TEXT CHANNELS${canManage?`<button class="sl-btn" onclick="addChannel('${serverData.id}')" title="Add Channel">+</button>`:''}`;
    scroll.appendChild(chLabel);
    channels.forEach(ch => {
      // Check view permission
      const canView=canViewChannel(ch,memberRoleData,isOwner);
      if (!canView) return;
      const div=document.createElement('div'); div.className='channel-item'; div.id='ch-'+ch.id;
      const locked=ch.permissions?.view!=='everyone'&&!isOwner;
      div.innerHTML=`<span style="color:var(--muted);font-size:0.9rem">#</span><span style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(ch.name)}</span>${locked?`<span class="ch-lock">ğŸ”’</span>`:''}${canManage?`<button style="background:none;border:none;color:var(--muted);cursor:pointer;font-size:0.8rem;padding:2px 4px;border-radius:4px" onclick="event.stopPropagation();openChannelPerms('${ch.id}','${esc(ch.name)}','${serverData.id}')" title="Permissions">âš™</button>`:''}`;
      div.onclick=()=>{ document.querySelectorAll('.channel-item').forEach(c=>c.classList.remove('active')); div.classList.add('active'); openChannel(ch,serverData,memberRoleData,isOwner); closeMobileSidebar(); };
      scroll.appendChild(div);
    });

    // Members section
    const memLabel=document.createElement('div'); memLabel.className='sidebar-section-label';
    memLabel.innerHTML='MEMBERS';
    scroll.appendChild(memLabel);
    const membersSnap=await getDocs(query(collection(db,'serverMembers'),where('serverId','==',serverData.id)));
    for (const m of membersSnap.docs) {
      const mData=m.data();
      const uSnap=await getDoc(doc(db,'users',mData.userId));
      if (!uSnap.exists()||uSnap.data().deleted) continue;
      const u={id:mData.userId,...uSnap.data()};
      const mName=u.displayName||u.username;
      const isMe=u.id===currentUser.uid;
      // Get role
      let roleInfo=null;
      if (mData.assignedRoleId) { const rSnap=await getDoc(doc(db,'roles',mData.assignedRoleId)); if(rSnap.exists()) roleInfo={id:rSnap.id,...rSnap.data()}; }
      const div=document.createElement('div'); div.className='sidebar-item';
      div.innerHTML=`<div class="item-avatar" style="background:${color(u.username)}">${u.avatarUrl?`<img src="${u.avatarUrl}"/>`:mName[0].toUpperCase()}<span class="status-dot ${visibleStatus(u.status)}"></span></div><div style="flex:1;min-width:0"><div style="font-size:0.84rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${mName}${isMe?' (you)':''}</div>${roleInfo?`<div style="font-size:0.68rem;color:${roleInfo.color||'var(--muted)'}">${esc(roleInfo.name)}</div>`:''}</div>`;
      div.onclick=()=>showProfilePanel(u);
      scroll.appendChild(div);
    }

    // Expose currentServer globally
    window.currentServer = serverData;

    // If there are visible channels, auto-open the first one immediately
    const firstVisibleChannel = channels.find(ch => canViewChannel(ch, memberRoleData, isOwner));
    if (firstVisibleChannel) {
      // Mark it active in sidebar
      const firstDiv = document.getElementById('ch-' + firstVisibleChannel.id);
      if (firstDiv) { document.querySelectorAll('.channel-item').forEach(c=>c.classList.remove('active')); firstDiv.classList.add('active'); }
      await openChannel(firstVisibleChannel, serverData, memberRoleData, isOwner);
    } else {
      // No channels yet - show landing page
      const hdr=document.getElementById('main-header');
      hdr.innerHTML='';
      const hamBtn=document.createElement('button'); hamBtn.className='hamburger'; hamBtn.textContent='â˜°'; hamBtn.onclick=toggleMobileSidebar; hdr.appendChild(hamBtn);
      const hashSpan=document.createElement('span'); hashSpan.textContent='ğŸ°'; hdr.appendChild(hashSpan);
      const titleH=document.createElement('h2'); titleH.textContent=serverData.name; hdr.appendChild(titleH);
      const actDiv=document.createElement('div'); actDiv.style.marginLeft='auto'; actDiv.style.display='flex'; actDiv.style.gap='6px';
      if (canManage) {
        const invBtn=document.createElement('button'); invBtn.className='friend-btn'; invBtn.title='Invite'; invBtn.textContent='ğŸ”—'; invBtn.onclick=()=>openInviteModal(window.currentServer); actDiv.appendChild(invBtn);
        const roleBtn=document.createElement('button'); roleBtn.className='friend-btn'; roleBtn.title='Roles'; roleBtn.textContent='ğŸ­'; roleBtn.onclick=()=>{openModal('rolesModal');loadRolesModal(window.currentServer.id);}; actDiv.appendChild(roleBtn);
      } else {
        const invBtn=document.createElement('button'); invBtn.className='friend-btn'; invBtn.title='Invite'; invBtn.textContent='ğŸ”—'; invBtn.onclick=()=>openInviteModal(window.currentServer); actDiv.appendChild(invBtn);
      }
      hdr.appendChild(actDiv);
      const mc=document.getElementById('main-content'); mc.className='main-content';
      mc.innerHTML=`<div class="empty-state"><div class="empty-icon">ğŸ’¬</div><h3>${esc(serverData.name)}</h3><p>No channels yet.${canManage?' Use the sidebar to add one.':''}</p></div>`;
    }
  } catch(err) { console.error('openServer error:', err); showToast('Error loading server: '+err.message, 'error'); }
  };

  function canViewChannel(ch, roleData, isOwner) {
    if (isOwner) return true;
    if (roleData?.permissions?.admin) return true;
    if (!ch.permissions||ch.permissions.view==='everyone') return true;
    if (ch.permissions.view==='role'&&roleData&&ch.permissions.viewRoleId===roleData.id) return true;
    return false;
  }
  function canSendInChannel(ch, roleData, isOwner) {
    if (isOwner) return true;
    if (roleData?.permissions?.admin) return true;
    if (!ch.permissions||ch.permissions.send==='everyone') return true;
    if (ch.permissions.send==='role'&&roleData&&ch.permissions.sendRoleId===roleData.id) return true;
    if (roleData?.permissions?.send===false) return false;
    return true;
  }

  async function openChannel(ch, serverData, memberRoleData, isOwner) {
    currentChannel=ch; currentDmFriend=null;
    if (chUnsubscribe) chUnsubscribe();
    if (dmUnsubscribe) dmUnsubscribe();
    if (typingUnsubscribe) typingUnsubscribe();
    const canSend=canSendInChannel(ch,memberRoleData,isOwner);
    const canManage=isOwner||(memberRoleData?.permissions?.admin);

    document.getElementById('main-header').innerHTML=`<button class="hamburger" onclick="toggleMobileSidebar()">â˜°</button><span style="color:var(--muted)">#</span><h2>${esc(ch.name)}</h2>${canManage?`<button style="margin-left:auto" class="friend-btn" onclick="openInviteModal(currentServer)" title="Invite">ğŸ”—</button>`:''}`;
    const content=document.getElementById('main-content');
    content.className='main-content chat-mode';
    content.innerHTML=`<div class="chat-view"><div class="chat-messages" id="chat-messages"></div><div class="typing-indicator" id="typing-indicator"></div>${canSend?`<div class="chat-input-area"><div class="chat-input-box"><button class="chat-attach-btn" onclick="document.getElementById('ch-file-input').click()">ğŸ“</button><input type="text" id="chat-input" placeholder="Message #${esc(ch.name)}" oninput="handleTypingChannel()" onkeydown="if(event.key==='Enter')sendChannelMsg()"/><button class="chat-send-btn" onclick="sendChannelMsg()">â¤</button></div></div>`:`<div class="no-perm-bar">ğŸ”’ You don't have permission to send messages in this channel.</div>`}</div>`;

    chUnsubscribe=onSnapshot(query(collection(db,'channels',ch.id,'messages'),orderBy('createdAt')), snap=>{
      const container=document.getElementById('chat-messages'); if(!container) return;
      container.innerHTML='';
      if (snap.empty) { container.innerHTML=`<div class="empty-state" style="flex:1"><div class="empty-icon">ğŸ‘‹</div><h3>Welcome to #${esc(ch.name)}!</h3><p>This is the beginning of this channel.</p></div>`; return; }
      snap.docs.forEach(d=>renderMsg(d.data(),container,null));
      container.scrollTop=container.scrollHeight;
    });

    // Typing
    typingUnsubscribe=onSnapshot(doc(db,'typing','ch_'+ch.id), snap=>{
      const data=snap.data()||{};
      const others=Object.keys(data).filter(uid=>uid!==currentUser.uid&&data[uid]===true);
      const ti=document.getElementById('typing-indicator'); if(!ti) return;
      if (others.length) ti.innerHTML=`${others.length===1?'Someone':'Several people'} is typing<span class="typing-dots"><span></span><span></span><span></span></span>`;
      else ti.innerHTML='';
    });
  }

  async function sendChannelMsg(text=null, ftype=null, fileUrl=null, fileName=null, fileSize=null) {
    if (!currentChannel) return;
    const input=document.getElementById('chat-input');
    const msgText=text||(input?.value.trim());
    if (!msgText&&!fileUrl) return;
    if (input) input.value='';
    clearTypingChannel();
    const msgData={ senderId:currentUser.uid, type:ftype||'text', createdAt:serverTimestamp() };
    if (fileUrl) { msgData.fileUrl=fileUrl; msgData.fileName=fileName; msgData.fileSize=fileSize; }
    else msgData.text=msgText;
    // Attach role info
    if (window._myServerRole) { msgData.senderRoleName=window._myServerRole.name; msgData.senderRoleColor=window._myServerRole.color||'#5b6af0'; }
    await addDoc(collection(db,'channels',currentChannel.id,'messages'),msgData);
  }
  window.sendChannelMsg=sendChannelMsg;

  function handleTypingChannel() {
    if (!currentChannel) return;
    setDoc(doc(db,'typing','ch_'+currentChannel.id),{[currentUser.uid]:true},{merge:true}).catch(()=>{});
    clearTimeout(typingTimeout);
    typingTimeout=setTimeout(()=>clearTypingChannel(),3000);
  }
  function clearTypingChannel() {
    if (!currentChannel) return;
    setDoc(doc(db,'typing','ch_'+currentChannel.id),{[currentUser.uid]:false},{merge:true}).catch(()=>{});
  }

  async function addChannel(serverId) {
    const name=prompt('Channel name:'); if(!name) return;
    await addDoc(collection(db,'channels'),{name:name.toLowerCase().replace(/\s+/g,'-'),serverId,type:'text',permissions:{view:'everyone',send:'everyone'},createdAt:serverTimestamp()});
    if (currentServer) await window.openServer(currentServer);
  }
  window.addChannel=addChannel;

  // â”€â”€ INVITE LINKS â”€â”€
  window.openInviteModal=function(server){
    if (!server) return;
    currentInviteServerData=server;
    document.getElementById('invite-server-name').textContent='Server: '+server.name;
    document.getElementById('invite-link-display').style.display='none';
    document.getElementById('invite-link-text').textContent='';
    openModal('inviteModal');
  };

  window.generateInvite=async function(){
    if (!currentInviteServerData) return;
    const expiry=document.getElementById('invite-expiry').value;
    const code=Math.random().toString(36).substring(2,9);
    let expiresAt=null;
    if (expiry==='1') expiresAt=new Date(Date.now()+86400000);
    else if (expiry==='7') expiresAt=new Date(Date.now()+604800000);
    await setDoc(doc(db,'invites',code),{serverId:currentInviteServerData.id,serverName:currentInviteServerData.name,createdBy:currentUser.uid,createdAt:serverTimestamp(),expiresAt,uses:0});
    const link=`${BASE_URL}dashboard.html?invite=${code}`;
    document.getElementById('invite-link-text').textContent=link;
    document.getElementById('invite-link-display').style.display='block';
    document.getElementById('invite-expiry-note').textContent=expiry==='never'?'This link never expires.':`This link expires in ${expiry==='1'?'1 day':'7 days'}.`;
  };

  window.copyInviteLink=function(){
    const text=document.getElementById('invite-link-text').textContent;
    navigator.clipboard.writeText(text).then(()=>showToast('Link copied!','success')).catch(()=>showToast('Copy manually from the box above',''));
  };

  window.joinServerViaInvite=async function(){
    const val=document.getElementById('join-invite-input').value.trim();
    const rb=document.getElementById('join-result'); rb.className='add-result';
    // extract code from URL or use as-is
    const code=val.includes('?invite=')? val.split('?invite=')[1] : val;
    if (!code) { rb.textContent='Please enter an invite link or code.'; rb.className='add-result error'; return; }
    await handleInviteFromUrl(code, rb);
  };

  async function handleInviteFromUrl(code, rb=null) {
    const invSnap=await getDoc(doc(db,'invites',code));
    if (!invSnap.exists()) { if(rb){rb.textContent='Invalid invite link.';rb.className='add-result error';} else showToast('Invalid invite link.','error'); return; }
    const inv=invSnap.data();
    // Check expiry
    if (inv.expiresAt) {
      const exp=inv.expiresAt.toDate?inv.expiresAt.toDate():new Date(inv.expiresAt);
      if (new Date()>exp) { if(rb){rb.textContent='This invite has expired.';rb.className='add-result error';} else showToast('Invite has expired.','error'); return; }
    }
    // Check if already member
    const memSnap=await getDoc(doc(db,'serverMembers',`${inv.serverId}_${currentUser.uid}`));
    if (memSnap.exists()) { if(rb){rb.textContent="You're already in this server!";rb.className='add-result error';} else { showToast("You're already in that server!",''); if(rb===null){closeModal('joinServerModal');} } return; }
    // Join
    await setDoc(doc(db,'serverMembers',`${inv.serverId}_${currentUser.uid}`),{serverId:inv.serverId,userId:currentUser.uid,role:'member',joinedAt:serverTimestamp()});
    await updateDoc(doc(db,'invites',code),{uses:(inv.uses||0)+1});
    if(rb){rb.textContent=`Joined "${inv.serverName}"! ğŸ‰`;rb.className='add-result success';}
    showToast(`Joined "${inv.serverName}"! ğŸ‰`,'success');
    closeModal('joinServerModal');
    await loadServers();
    // Remove invite param from URL
    window.history.replaceState({}, '', 'dashboard.html');
  }

  // â”€â”€ ROLES â”€â”€
  window.loadRolesModal=async function(serverId){
    window._currentRolesServerId=serverId;
    showRolesTab('list');
    const snap=await getDocs(query(collection(db,'roles'),where('serverId','==',serverId)));
    window._serverRoles=snap.docs.map(d=>({id:d.id,...d.data()}));
    renderRolesList();
    // Setup color picker
    document.querySelectorAll('.role-color-swatch').forEach(s=>{
      s.onclick=()=>{ document.querySelectorAll('.role-color-swatch').forEach(x=>x.style.border='3px solid transparent'); s.style.border='3px solid #fff'; selectedRoleColor=s.dataset.color; };
    });
  };

  function renderRolesList(){
    const container=document.getElementById('roles-list-container');
    const roles=window._serverRoles||[];
    if (!roles.length) { container.innerHTML='<div style="color:var(--muted);font-size:0.86rem;text-align:center;padding:20px">No roles yet. Create one!</div>'; return; }
    container.innerHTML='';
    roles.forEach(r=>{
      const row=document.createElement('div'); row.className='role-row';
      const perms=Object.entries(r.permissions||{}).filter(([k,v])=>v===true).map(([k])=>k).join(', ')||'none';
      row.innerHTML=`<div class="role-color-dot" style="background:${r.color||'#5b6af0'}"></div><div class="role-name">${esc(r.name)}</div><div class="role-perms">${perms}</div><button class="role-del-btn" onclick="deleteRole('${r.id}')">ğŸ—‘</button>`;
      container.appendChild(row);
    });
  }

  window.showRolesTab=function(tab){
    document.getElementById('roles-tab-list').style.display=tab==='list'?'block':'none';
    document.getElementById('roles-tab-create').style.display=tab==='create'?'block':'none';
    document.getElementById('roles-tab-members').style.display=tab==='members'?'block':'none';
    if (tab==='members') loadMembersForRoles();
  };

  window.createRole=async function(){
    const name=document.getElementById('new-role-name').value.trim();
    if (!name) { showToast('Enter a role name','error'); return; }
    const perms={
      admin:document.getElementById('perm-admin').checked,
      manageRoles:document.getElementById('perm-manage-roles').checked,
      send:document.getElementById('perm-send').checked,
      view:document.getElementById('perm-view').checked,
      files:document.getElementById('perm-files').checked
    };
    const serverId=window._currentRolesServerId;
    await addDoc(collection(db,'roles'),{name,color:selectedRoleColor,serverId,permissions:perms,createdAt:serverTimestamp()});
    document.getElementById('new-role-name').value='';
    showToast('Role created!','success');
    const snap=await getDocs(query(collection(db,'roles'),where('serverId','==',serverId)));
    window._serverRoles=snap.docs.map(d=>({id:d.id,...d.data()}));
    showRolesTab('list'); renderRolesList();
  };

  window.deleteRole=async function(roleId){
    await deleteDoc(doc(db,'roles',roleId));
    window._serverRoles=(window._serverRoles||[]).filter(r=>r.id!==roleId);
    renderRolesList(); showToast('Role deleted.','');
  };

  async function loadMembersForRoles(){
    const serverId=window._currentRolesServerId; if(!serverId) return;
    const roles=window._serverRoles||[];
    const membersSnap=await getDocs(query(collection(db,'serverMembers'),where('serverId','==',serverId)));
    const container=document.getElementById('members-roles-list'); container.innerHTML='';
    for (const m of membersSnap.docs) {
      const mData=m.data();
      if (mData.role==='owner') continue; // skip owner
      const uSnap=await getDoc(doc(db,'users',mData.userId));
      if (!uSnap.exists()||uSnap.data().deleted) continue;
      const u={...uSnap.data(),id:mData.userId};
      const name=u.displayName||u.username;
      const row=document.createElement('div'); row.className='member-row';
      const opts=`<option value="">No Role</option>`+roles.map(r=>`<option value="${r.id}" ${mData.assignedRoleId===r.id?'selected':''}>${esc(r.name)}</option>`).join('');
      row.innerHTML=`<div class="item-avatar" style="background:${color(u.username)}">${u.avatarUrl?`<img src="${u.avatarUrl}"/>`:name[0].toUpperCase()}</div><div class="member-info"><div class="member-name">${name}</div><div class="member-tag">@${u.username}</div></div><select class="member-role-select" onchange="assignRole('${serverId}','${mData.userId}',this.value)">${opts}</select>`;
      container.appendChild(row);
    }
    if (!container.children.length) container.innerHTML='<div style="color:var(--muted);font-size:0.86rem;text-align:center;padding:20px">No members to assign roles to.</div>';
  }

  window.assignRole=async function(serverId,userId,roleId){
    const docId=`${serverId}_${userId}`;
    if (roleId) await updateDoc(doc(db,'serverMembers',docId),{assignedRoleId:roleId});
    else await updateDoc(doc(db,'serverMembers',docId),{assignedRoleId:null});
    showToast('Role assigned!','success');
  };

  // â”€â”€ CHANNEL PERMISSIONS â”€â”€
  window.openChannelPerms=async function(channelId,channelName,serverId){
    currentChannelForPerms={id:channelId,name:channelName,serverId};
    document.getElementById('ch-perm-name').textContent='#'+channelName;
    // Load roles for dropdowns
    const snap=await getDocs(query(collection(db,'roles'),where('serverId','==',serverId)));
    const roles=snap.docs.map(d=>({id:d.id,...d.data()}));
    const opts=`<option value="">Select a role</option>`+roles.map(r=>`<option value="${r.id}">${esc(r.name)}</option>`).join('');
    document.getElementById('ch-perm-role-select').innerHTML=opts;
    document.getElementById('ch-perm-send-role-select').innerHTML=opts;
    // Load existing perms
    const chSnap=await getDoc(doc(db,'channels',channelId));
    if (chSnap.exists()) {
      const perms=chSnap.data().permissions||{};
      document.getElementById('ch-perm-view-select').value=perms.view||'everyone';
      document.getElementById('ch-perm-send-select').value=perms.send||'everyone';
      if (perms.view==='role') { document.getElementById('ch-perm-role-group').style.display='flex'; document.getElementById('ch-perm-role-select').value=perms.viewRoleId||''; }
      if (perms.send==='role') { document.getElementById('ch-perm-send-role-group').style.display='flex'; document.getElementById('ch-perm-send-role-select').value=perms.sendRoleId||''; }
    }
    document.getElementById('ch-perm-view-select').onchange=function(){ document.getElementById('ch-perm-role-group').style.display=this.value==='role'?'flex':'none'; };
    document.getElementById('ch-perm-send-select').onchange=function(){ document.getElementById('ch-perm-send-role-group').style.display=this.value==='role'?'flex':'none'; };
    openModal('channelPermModal');
  };

  window.saveChannelPerms=async function(){
    if (!currentChannelForPerms) return;
    const view=document.getElementById('ch-perm-view-select').value;
    const send=document.getElementById('ch-perm-send-select').value;
    const viewRoleId=view==='role'?document.getElementById('ch-perm-role-select').value:'';
    const sendRoleId=send==='role'?document.getElementById('ch-perm-send-role-select').value:'';
    await updateDoc(doc(db,'channels',currentChannelForPerms.id),{permissions:{view,send,viewRoleId,sendRoleId}});
    closeModal('channelPermModal'); showToast('Permissions saved!','success');
    if (currentServer) await window.openServer(currentServer);
  };

  window.showServerSettings=function(server,channels){
    // For now open invite + roles
    openInviteModal(server);
  };

  // â”€â”€ PROFILE â”€â”€
  window.openProfileModal=function(){
    document.getElementById('display-name-input').value=currentProfile.displayName||'';
    document.getElementById('bio-input').value=currentProfile.bio||'';
    document.getElementById('username-readonly').value='@'+currentProfile.username;
    selectedStatus=currentProfile.status||'online';
    document.querySelectorAll('.status-option').forEach(o=>o.classList.toggle('selected',o.dataset.status===selectedStatus));
    const preview=document.getElementById('profile-avatar-preview');
    const name=currentProfile.displayName||currentProfile.username;
    if (currentProfile.avatarUrl){preview.innerHTML=`<img src="${currentProfile.avatarUrl}"/>`;preview.style.background='';}
    else{preview.innerHTML=name[0].toUpperCase();preview.style.background=color(currentProfile.username);}
    pendingAvatarDataUrl=null; openModal('profileModal');
  };
  window.selectStatus=card=>{ document.querySelectorAll('.status-option').forEach(c=>c.classList.remove('selected')); card.classList.add('selected'); selectedStatus=card.dataset.status; };
  window.handleAvatarUpload=function(event){ const file=event.target.files[0]; if(!file) return; if(file.size>8*1024*1024){showToast('Image must be under 8MB','error');return;} const reader=new FileReader(); reader.onload=e=>{pendingAvatarDataUrl=e.target.result;const p=document.getElementById('profile-avatar-preview');p.innerHTML=`<img src="${pendingAvatarDataUrl}"/>`;p.style.background='';}; reader.readAsDataURL(file); };
  window.removeAvatar=function(){ pendingAvatarDataUrl='remove'; const p=document.getElementById('profile-avatar-preview'); const n=document.getElementById('display-name-input').value||currentProfile.username; p.innerHTML=n[0].toUpperCase(); p.style.background=color(currentProfile.username); };
  window.saveProfile=async function(){
    const displayName=document.getElementById('display-name-input').value.trim();
    const bio=document.getElementById('bio-input').value.trim();
    let avatarUrl=currentProfile.avatarUrl||'';
    if (pendingAvatarDataUrl==='remove') avatarUrl='';
    else if (pendingAvatarDataUrl?.startsWith('data:')) {
      try { const file=document.getElementById('avatar-file-input').files[0]; if(file){showToast('Uploading...',''); const fd=new FormData();fd.append('file',file);fd.append('upload_preset',CLOUDINARY_PRESET);fd.append('public_id',`avatars/${currentUser.uid}`); const res=await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD}/image/upload`,{method:'POST',body:fd}); const data=await res.json(); if(data.secure_url) avatarUrl=data.secure_url; else{showToast('Upload failed','error');return;}} } catch{showToast('Upload failed','error');return;}
    }
    const manualStatus=selectedStatus!=='online'?selectedStatus:null;
    await updateDoc(doc(db,'users',currentUser.uid),{displayName,bio,avatarUrl,status:selectedStatus,manualStatus});
    currentProfile={...currentProfile,displayName,bio,avatarUrl,status:selectedStatus,manualStatus};
    updateSidebarUser(); closeModal('profileModal'); showToast('Profile updated! âœ¨','success');
  };

  // â”€â”€ DELETE ACCOUNT â”€â”€
  window.confirmDeleteAccount=function(){ closeModal('profileModal'); document.getElementById('delete-confirm-input').value=''; openModal('deleteAccountModal'); };
  window.deleteAccount=async function(){
    if (document.getElementById('delete-confirm-input').value.trim()!=='DELETE'){showToast('Type DELETE to confirm','error');return;}
    try { await updateDoc(doc(db,'users',currentUser.uid),{deleted:true,deletedAt:serverTimestamp(),displayName:'Deleted User',avatarUrl:'',bio:'',status:'offline',email:''}); const user=auth.currentUser; await signOut(auth); try{await deleteUser(user);}catch(e){} window.location.href='index.html'; } catch(e){showToast('Please sign out and back in first, then try again.','error');}
  };

  // â”€â”€ CALL â”€â”€
  window.startCall=function(friend){ const name=friend.displayName||friend.username; const av=document.getElementById('call-avatar'); av.style.background=color(friend.username); av.innerHTML=friend.avatarUrl?`<img src="${friend.avatarUrl}" style="width:100%;height:100%;object-fit:cover;border-radius:50%"/>`:name[0].toUpperCase(); document.getElementById('call-name').textContent=name; document.getElementById('call-status').textContent='Calling...'; openModal('callModal'); setTimeout(()=>{const s=document.getElementById('call-status');if(s)s.textContent='Ringing... (demo mode)';},2000); };
  window.endCall=()=>{ closeModal('callModal'); showToast('Call ended.',''); };

  // â”€â”€ SIGN OUT â”€â”€
  window.handleSignOut=async function(){ try{await updateDoc(doc(db,'users',currentUser.uid),{status:'offline'});}catch(e){} await signOut(auth); window.location.href='index.html'; };

  // â”€â”€ NAV â”€â”€
  window.showView=function(){
    document.querySelectorAll('.server-icon').forEach(i=>i.classList.remove('active'));
    document.querySelector('.server-icon.home').classList.add('active');
    document.getElementById('profile-panel').classList.add('hidden');
    currentServer=null; currentChannel=null; currentDmFriend=null;
    // Reset sidebar to DMs
    document.getElementById('sidebar-title').textContent='ğŸ’¬ Direct Messages';
    document.getElementById('sidebar-action-btn').innerHTML='+';
    document.getElementById('sidebar-action-btn').onclick=()=>openModal('addFriendModal');
    const scroll=document.getElementById('sidebar-scroll'); scroll.innerHTML='<div class="sidebar-section-label">Friends</div><div id="dm-list"></div>';
    renderDmList(window._friends||[]);
    document.getElementById('main-content').className='main-content';
    document.getElementById('main-header').innerHTML=`<button class="hamburger" onclick="toggleMobileSidebar()">â˜°</button><span>ğŸ‘¥</span><h2>Friends</h2><div class="header-tabs"><button class="tab active" onclick="switchTab(this,'online')">Online</button><button class="tab" onclick="switchTab(this,'all')">All</button><button class="tab" onclick="switchTab(this,'pending')">Pending&nbsp;<span id="pending-count" style="display:none" class="pending-badge">0</span></button></div><button class="add-friend-btn" onclick="openModal('addFriendModal')">+ Add Friend</button>`;
    renderFriendsView(window._friends||[]);
  };
  window.switchTab=function(btn,tab){ document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active')); btn.classList.add('active'); if(tab==='pending') renderPendingView(); else renderFriendsView(window._friends||[]); };
  window.selectServerType=card=>{ document.querySelectorAll('.server-type-card').forEach(c=>c.classList.remove('selected')); card.classList.add('selected'); };
  window.filterSidebar=function(){ /* basic client-side filter */ };

  // â”€â”€ MOBILE â”€â”€
  window.toggleMobileSidebar=function(){ document.getElementById('sidebar').classList.toggle('open'); document.getElementById('sidebar-overlay').classList.toggle('open'); };
  window.closeMobileSidebar=function(){ document.getElementById('sidebar').classList.remove('open'); document.getElementById('sidebar-overlay').classList.remove('open'); };
  window.mobileNav=function(tab,btn){
    document.querySelectorAll('.mobile-nav-btn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    if (tab==='home') showView();
    else if (tab==='dms') { showView(); }
    else if (tab==='servers') showMobileServerSheet();
  };

  // â”€â”€ MOBILE SERVER SHEET â”€â”€
  window.showMobileServerSheet = function() {
    // Remove existing sheet if any
    const existing = document.getElementById('mobile-server-sheet');
    if (existing) { existing.remove(); return; }

    const servers = window._servers || [];
    const sheet = document.createElement('div');
    sheet.id = 'mobile-server-sheet';
    sheet.style.cssText = `position:fixed;bottom:var(--mobile-nav-h);left:0;right:0;background:var(--surface);border-top:1px solid var(--border);border-radius:20px 20px 0 0;z-index:250;padding:16px;max-height:70vh;overflow-y:auto;box-shadow:0 -8px 32px rgba(0,0,0,0.4);animation:slideUp 0.25s ease`;

    let html = `<div style="width:40px;height:4px;background:var(--border);border-radius:2px;margin:0 auto 16px"></div>
      <div style="font-family:'Syne',sans-serif;font-weight:700;font-size:1.1rem;margin-bottom:14px">Your Servers</div>`;

    if (!servers.length) {
      html += `<div style="text-align:center;color:var(--muted);font-size:0.88rem;padding:20px 0">No servers yet</div>`;
    } else {
      servers.forEach(s => {
        html += `<div onclick="closeMobileServerSheet();openServer(window._servers.find(x=>x.id==='${s.id}'))" style="display:flex;align-items:center;gap:12px;padding:10px;border-radius:10px;cursor:pointer;transition:background 0.15s;margin-bottom:4px" onmouseover="this.style.background='var(--surface2)'" onmouseout="this.style.background=''">
          <div style="width:44px;height:44px;border-radius:14px;background:${color(s.name)};color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:1.1rem;flex-shrink:0">${s.name[0].toUpperCase()}</div>
          <div>
            <div style="font-weight:600;font-size:0.92rem">${esc(s.name)}</div>
            <div style="font-size:0.74rem;color:var(--muted)">${s.ownerId===currentUser.uid?'Owner':'Member'}</div>
          </div>
        </div>`;
      });
    }

    html += `<div style="border-top:1px solid var(--border);margin-top:12px;padding-top:12px;display:flex;gap:8px">
      <button onclick="closeMobileServerSheet();openModal('createServerModal')" style="flex:1;padding:11px;background:var(--accent);color:#fff;border:none;border-radius:8px;font-family:'DM Sans',sans-serif;font-size:0.86rem;font-weight:600;cursor:pointer">â• Create</button>
      <button onclick="closeMobileServerSheet();openModal('joinServerModal')" style="flex:1;padding:11px;background:var(--surface2);color:var(--text);border:none;border-radius:8px;font-family:'DM Sans',sans-serif;font-size:0.86rem;font-weight:600;cursor:pointer">ğŸ”— Join</button>
    </div>`;

    sheet.innerHTML = html;
    document.body.appendChild(sheet);

    // Tap outside to close
    setTimeout(() => {
      document.addEventListener('click', function handler(e) {
        if (!sheet.contains(e.target) && e.target.id !== 'mnav-servers') {
          closeMobileServerSheet();
          document.removeEventListener('click', handler);
        }
      });
    }, 50);
  };

  window.closeMobileServerSheet = function() {
    const sheet = document.getElementById('mobile-server-sheet');
    if (sheet) sheet.remove();
  };

  // â”€â”€ UTILS â”€â”€
  function color(str){ if(!str) return '#5b6af0'; let h=0; for(let i=0;i<str.length;i++) h=str.charCodeAt(i)+((h<<5)-h); return ['#5b6af0','#e040fb','#00bcd4','#ff7043','#66bb6a','#ffa726','#ab47bc','#26c6da'][Math.abs(h)%8]; }
  function esc(t){ return String(t).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
  function sj(obj){ return "JSON.parse('"+JSON.stringify(obj).replace(/\\/g,'\\\\').replace(/'/g,"\\'")+"')"; }
  function fmtSize(b){ if(b<1024) return b+' B'; if(b<1048576) return (b/1024).toFixed(1)+' KB'; return (b/1048576).toFixed(1)+' MB'; }
  function fileIcon(name){ const e=(name||'').split('.').pop().toLowerCase(); return {pdf:'ğŸ“„',doc:'ğŸ“',docx:'ğŸ“',txt:'ğŸ“„',zip:'ğŸ—œï¸',rar:'ğŸ—œï¸',mp3:'ğŸµ',wav:'ğŸµ',mp4:'ğŸ¬',mov:'ğŸ¬'}[e]||'ğŸ“'; }
  function showToast(msg,type){ const t=document.getElementById('toast'); t.textContent=msg; t.className=`toast ${type} show`; setTimeout(()=>{t.className='toast';},3500); }
  window.showToast=showToast;
  // expose for inline HTML access
  Object.defineProperty(window, '_currentUid', { get: () => currentUser?.uid });
  window.currentServer=currentServer; // expose for inline onclick
</script>

<script>
  function openModal(id){ document.getElementById(id).classList.add('open'); }
  function closeModal(id){ document.getElementById(id).classList.remove('open'); }
  document.querySelectorAll('.modal-overlay').forEach(o=>{ o.addEventListener('click',e=>{ if(e.target===o) o.classList.remove('open'); }); });
  document.addEventListener('keydown',e=>{ if(e.key==='Escape') document.querySelectorAll('.modal-overlay.open').forEach(m=>m.classList.remove('open')); });
</script>
</body>
</html>
