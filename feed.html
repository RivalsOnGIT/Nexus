<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Nexus Feed</title>
  <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet"/>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin:0; padding:0; }
    :root {
      --bg: #0b0c10;
      --surface: #13151c;
      --surface2: #1c1f2b;
      --surface3: #232638;
      --accent: #5b6af0;
      --accent2: #e040fb;
      --text: #eaedf8;
      --muted: #7c80a0;
      --border: rgba(255,255,255,0.07);
      --border2: rgba(255,255,255,0.12);
      --online: #28c840;
      --error: #ff5f57;
      --radius: 14px;
    }
    html { scroll-behavior: smooth; }
    body { background: var(--bg); color: var(--text); font-family: 'DM Sans', sans-serif; min-height: 100vh; }

    /* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
    .toast { position:fixed; bottom:24px; left:50%; transform:translateX(-50%) translateY(20px); background:var(--surface3); border:1px solid var(--border2); border-radius:10px; padding:11px 20px; font-size:0.88rem; font-weight:500; opacity:0; transition:all 0.3s; z-index:9999; white-space:nowrap; max-width:90vw; pointer-events:none; }
    .toast.show { opacity:1; transform:translateX(-50%) translateY(0); }
    .toast.success { border-color:rgba(40,200,64,0.4); }
    .toast.error { border-color:rgba(255,95,87,0.4); color:#ff8f87; }

    /* ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ */
    .app { display:flex; min-height:100vh; max-width:1200px; margin:0 auto; }

    /* ‚îÄ‚îÄ LEFT SIDEBAR ‚îÄ‚îÄ */
    .left-nav {
      width: 260px; flex-shrink:0; padding: 20px 12px;
      position: sticky; top:0; height: 100vh; overflow-y:auto;
      display: flex; flex-direction: column;
      border-right: 1px solid var(--border);
    }
    .nav-logo {
      font-family: 'Syne', sans-serif; font-weight: 800; font-size: 1.5rem;
      background: linear-gradient(135deg, #5b6af0, #e040fb);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
      padding: 4px 12px 20px; text-decoration: none;
    }
    .nav-item {
      display: flex; align-items: center; gap: 14px;
      padding: 12px 14px; border-radius: 100px; cursor: pointer;
      font-size: 1rem; font-weight: 500; color: var(--text); text-decoration:none;
      transition: background 0.15s; border: none; background: none; width: 100%; text-align:left;
    }
    .nav-item:hover { background: var(--surface2); }
    .nav-item.active { font-weight: 700; color: var(--accent); }
    .nav-item .nav-icon { font-size: 1.3rem; width: 24px; text-align:center; }
    .nav-spacer { flex:1; }
    .nav-user-card {
      display:flex; align-items:center; gap:10px; padding:10px 12px;
      border-radius:100px; cursor:pointer; transition:background 0.15s;
      border:none; background:none; width:100%; text-align:left;
    }
    .nav-user-card:hover { background: var(--surface2); }
    .nav-user-av { width:38px; height:38px; border-radius:50%; background:var(--accent); display:flex; align-items:center; justify-content:center; font-weight:700; font-size:0.9rem; color:#fff; overflow:hidden; flex-shrink:0; }
    .nav-user-av img { width:100%; height:100%; object-fit:cover; }
    .nav-user-name { font-weight:700; font-size:0.88rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .nav-user-handle { font-size:0.78rem; color:var(--muted); }
    .post-btn {
      width:100%; margin-top:16px; padding:14px;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color:#fff; border:none; border-radius:100px;
      font-family:'DM Sans',sans-serif; font-size:1rem; font-weight:700;
      cursor:pointer; transition: opacity 0.2s, transform 0.1s;
    }
    .post-btn:hover { opacity:0.9; }
    .post-btn:active { transform:scale(0.97); }

    /* ‚îÄ‚îÄ CENTER FEED ‚îÄ‚îÄ */
    .feed-col { flex:1; border-right:1px solid var(--border); min-width:0; }
    .feed-header {
      position:sticky; top:0; z-index:10;
      background: rgba(11,12,16,0.85); backdrop-filter:blur(16px);
      border-bottom:1px solid var(--border);
      padding:0 16px;
    }
    .feed-header-tabs { display:flex; }
    .feed-tab {
      flex:1; padding:16px 0; text-align:center; font-weight:600; font-size:0.95rem;
      color:var(--muted); cursor:pointer; border:none; background:none; color:var(--text);
      border-bottom:2px solid transparent; transition:all 0.15s;
    }
    .feed-tab.active { color:var(--text); border-bottom-color:var(--accent); }
    .feed-tab:hover { background:var(--surface2); }

    /* ‚îÄ‚îÄ COMPOSE BOX ‚îÄ‚îÄ */
    .compose-box {
      padding:16px; border-bottom:1px solid var(--border);
      display:flex; gap:12px;
    }
    .compose-av { width:42px; height:42px; border-radius:50%; background:var(--accent); display:flex; align-items:center; justify-content:center; font-weight:700; font-size:1rem; color:#fff; overflow:hidden; flex-shrink:0; }
    .compose-av img { width:100%; height:100%; object-fit:cover; }
    .compose-right { flex:1; min-width:0; }
    .compose-textarea {
      width:100%; background:none; border:none; outline:none; resize:none;
      color:var(--text); font-family:'DM Sans',sans-serif; font-size:1.1rem;
      line-height:1.5; padding:8px 0 4px; min-height:60px;
    }
    .compose-textarea::placeholder { color:var(--muted); }
    .compose-media-preview { display:flex; gap:6px; flex-wrap:wrap; margin:8px 0; }
    .compose-media-item { position:relative; border-radius:10px; overflow:hidden; }
    .compose-media-item img, .compose-media-item video { display:block; height:100px; max-width:160px; object-fit:cover; border-radius:10px; }
    .compose-media-remove { position:absolute; top:4px; right:4px; width:20px; height:20px; background:rgba(0,0,0,0.7); border:none; color:#fff; border-radius:50%; font-size:0.7rem; cursor:pointer; display:flex; align-items:center; justify-content:center; }
    .compose-divider { height:1px; background:var(--border); margin:4px 0 8px; }
    .compose-actions { display:flex; align-items:center; justify-content:space-between; }
    .compose-media-btns { display:flex; gap:4px; }
    .compose-icon-btn { padding:8px; border:none; background:none; color:var(--accent); cursor:pointer; border-radius:50%; font-size:1.1rem; transition:background 0.15s; }
    .compose-icon-btn:hover { background:rgba(91,106,240,0.12); }
    .compose-icon-btn:disabled { opacity:0.35; cursor:default; }
    .compose-char-count { font-size:0.78rem; color:var(--muted); }
    .compose-char-count.warn { color:#f0a030; }
    .compose-char-count.over { color:var(--error); }
    .compose-submit {
      padding:8px 18px; background:var(--accent); color:#fff; border:none;
      border-radius:100px; font-family:'DM Sans',sans-serif; font-weight:700;
      font-size:0.88rem; cursor:pointer; transition:opacity 0.2s;
    }
    .compose-submit:disabled { opacity:0.4; cursor:default; }
    .compose-submit:hover:not(:disabled) { opacity:0.85; }

    /* ‚îÄ‚îÄ POST CARD ‚îÄ‚îÄ */
    .post-card {
      padding:14px 16px; border-bottom:1px solid var(--border);
      transition:background 0.1s; cursor:pointer;
    }
    .post-card:hover { background:rgba(255,255,255,0.015); }
    .post-header { display:flex; gap:12px; margin-bottom:10px; }
    .post-av { width:42px; height:42px; border-radius:50%; background:var(--accent); display:flex; align-items:center; justify-content:center; font-weight:700; font-size:1rem; color:#fff; overflow:hidden; flex-shrink:0; cursor:pointer; }
    .post-av img { width:100%; height:100%; object-fit:cover; }
    .post-meta { flex:1; min-width:0; }
    .post-name { font-weight:700; font-size:0.92rem; }
    .post-handle { font-size:0.8rem; color:var(--muted); }
    .post-time { font-size:0.78rem; color:var(--muted); margin-left:4px; }
    .post-body { font-size:0.95rem; line-height:1.6; white-space:pre-wrap; word-break:break-word; color:var(--text); padding-left:54px; }
    .post-media { padding-left:54px; margin-top:10px; }
    .post-media-grid { display:grid; gap:4px; border-radius:12px; overflow:hidden; }
    .post-media-grid.n1 { grid-template-columns:1fr; }
    .post-media-grid.n2 { grid-template-columns:1fr 1fr; }
    .post-media-grid.n3 { grid-template-columns:1fr 1fr; grid-template-rows:auto auto; }
    .post-media-grid.n4 { grid-template-columns:1fr 1fr; }
    .post-media-grid.n3 .media-item:first-child { grid-column:1/-1; }
    .media-item { position:relative; overflow:hidden; max-height:320px; background:#000; }
    .media-item img, .media-item video { width:100%; height:100%; object-fit:cover; display:block; max-height:320px; }
    .media-item video { cursor:default; }
    .post-actions { display:flex; gap:0; margin-top:12px; padding-left:44px; }
    .post-action-btn {
      display:flex; align-items:center; gap:6px; padding:8px 12px;
      border:none; background:none; color:var(--muted); cursor:pointer;
      border-radius:100px; font-size:0.82rem; transition:all 0.15s;
      font-family:'DM Sans',sans-serif;
    }
    .post-action-btn:hover.reply-btn  { color:#1d9bf0; background:rgba(29,155,240,0.1); }
    .post-action-btn:hover.repost-btn { color:#00ba7c; background:rgba(0,186,124,0.1); }
    .post-action-btn:hover.like-btn   { color:#f91880; background:rgba(249,24,128,0.1); }
    .post-action-btn.liked { color:#f91880; }
    .post-action-btn.reposted { color:#00ba7c; }
    .post-action-btn .act-icon { font-size:1rem; }

    /* ‚îÄ‚îÄ SINGLE POST VIEW ‚îÄ‚îÄ */
    .post-detail-header {
      display:flex; align-items:center; gap:14px; padding:14px 16px;
      border-bottom:1px solid var(--border);
    }
    .back-btn { border:none; background:none; color:var(--text); cursor:pointer; font-size:1.1rem; padding:8px; border-radius:50%; transition:background 0.15s; }
    .back-btn:hover { background:var(--surface2); }
    .post-detail-card { padding:16px; border-bottom:1px solid var(--border); }
    .post-detail-av-row { display:flex; gap:12px; align-items:center; margin-bottom:12px; }
    .post-detail-av { width:46px; height:46px; border-radius:50%; background:var(--accent); display:flex; align-items:center; justify-content:center; font-weight:700; font-size:1.1rem; color:#fff; overflow:hidden; cursor:pointer; }
    .post-detail-av img { width:100%; height:100%; object-fit:cover; }
    .post-detail-body { font-size:1.2rem; line-height:1.65; white-space:pre-wrap; word-break:break-word; margin-bottom:14px; }
    .post-detail-time { font-size:0.82rem; color:var(--muted); margin-bottom:14px; }
    .post-detail-stats { display:flex; gap:20px; padding:14px 0; border-top:1px solid var(--border); border-bottom:1px solid var(--border); }
    .stat-item { font-size:0.88rem; }
    .stat-item strong { font-weight:700; }
    .stat-item span { color:var(--muted); }
    .reply-compose { padding:14px 16px; border-bottom:1px solid var(--border); display:flex; gap:12px; }

    /* ‚îÄ‚îÄ RIGHT SIDEBAR ‚îÄ‚îÄ */
    .right-col { width:340px; flex-shrink:0; padding:16px 16px; }
    .search-box {
      display:flex; align-items:center; gap:10px;
      background:var(--surface2); border:1px solid var(--border);
      border-radius:100px; padding:10px 16px; margin-bottom:20px;
    }
    .search-box input { flex:1; background:none; border:none; outline:none; color:var(--text); font-family:'DM Sans',sans-serif; font-size:0.9rem; }
    .search-box input::placeholder { color:var(--muted); }
    .widget-card { background:var(--surface); border:1px solid var(--border); border-radius:var(--radius); padding:16px; margin-bottom:16px; }
    .widget-title { font-family:'Syne',sans-serif; font-weight:700; font-size:1rem; margin-bottom:14px; }
    .trending-item { padding:10px 0; border-bottom:1px solid var(--border); cursor:pointer; }
    .trending-item:last-child { border-bottom:none; }
    .trending-label { font-size:0.72rem; color:var(--muted); }
    .trending-tag { font-weight:700; font-size:0.9rem; }
    .trending-count { font-size:0.75rem; color:var(--muted); }
    .suggest-item { display:flex; align-items:center; gap:10px; padding:8px 0; }
    .suggest-av { width:38px; height:38px; border-radius:50%; background:var(--accent); display:flex; align-items:center; justify-content:center; font-weight:700; color:#fff; overflow:hidden; flex-shrink:0; font-size:0.88rem; }
    .suggest-av img { width:100%; height:100%; object-fit:cover; }
    .suggest-info { flex:1; min-width:0; }
    .suggest-name { font-weight:700; font-size:0.86rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .suggest-handle { font-size:0.76rem; color:var(--muted); }
    .follow-btn { padding:6px 16px; border-radius:100px; font-family:'DM Sans',sans-serif; font-weight:700; font-size:0.82rem; cursor:pointer; transition:all 0.15s; }
    .follow-btn.following { background:transparent; border:1px solid var(--border2); color:var(--text); }
    .follow-btn.following:hover { border-color:var(--error); color:var(--error); }
    .follow-btn:not(.following) { background:var(--text); border:1px solid transparent; color:#000; }
    .follow-btn:not(.following):hover { background:#dde; }

    /* ‚îÄ‚îÄ PROFILE PAGE ‚îÄ‚îÄ */
    .profile-page-header {
      position:relative;
    }
    .profile-page-banner {
      height:160px; background:linear-gradient(135deg,#5b6af0,#e040fb);
      position:relative; overflow:hidden;
    }
    .profile-page-banner img, .profile-page-banner video {
      width:100%; height:100%; object-fit:cover;
      object-position: var(--banner-pos, 50% 50%);
      position:absolute; inset:0;
    }
    .profile-page-banner .pp-banner { height:100%; }
    .profile-page-av-row { padding:0 16px; display:flex; justify-content:space-between; align-items:flex-end; margin-top:-36px; margin-bottom:12px; }
    .profile-page-av { width:72px; height:72px; border-radius:50%; border:4px solid var(--bg); background:var(--accent); display:flex; align-items:center; justify-content:center; font-weight:700; font-size:1.5rem; color:#fff; overflow:hidden; position:relative; z-index:2; }
    .profile-page-av img { width:100%; height:100%; object-fit:cover; }
    .profile-edit-btn, .profile-follow-btn { padding:8px 18px; border-radius:100px; font-family:'DM Sans',sans-serif; font-weight:700; font-size:0.88rem; cursor:pointer; transition:all 0.15s; }
    .profile-edit-btn { background:transparent; border:1px solid var(--border2); color:var(--text); }
    .profile-edit-btn:hover { background:var(--surface2); }
    .profile-follow-btn { background:var(--text); border:1px solid transparent; color:#000; }
    .profile-follow-btn:hover { opacity:0.85; }
    .profile-follow-btn.following { background:transparent; border:1px solid var(--border2); color:var(--text); }
    .profile-follow-btn.following:hover { border-color:var(--error); color:var(--error); }
    .profile-page-info { padding:0 16px 14px; }
    .profile-page-name { font-family:'Syne',sans-serif; font-weight:800; font-size:1.2rem; }
    .profile-page-handle { color:var(--muted); font-size:0.86rem; margin-bottom:8px; }
    .profile-page-bio { font-size:0.92rem; line-height:1.6; margin-bottom:10px; white-space:pre-wrap; word-break:break-word; }
    .profile-page-meta { display:flex; gap:16px; font-size:0.82rem; color:var(--muted); margin-bottom:10px; flex-wrap:wrap; }
    .profile-page-stats { display:flex; gap:20px; font-size:0.88rem; }
    .profile-page-stats a { color:var(--text); text-decoration:none; }
    .profile-page-stats a strong { font-weight:700; }
    .profile-page-stats a span { color:var(--muted); }
    .profile-page-tabs { display:flex; border-bottom:1px solid var(--border); }
    .profile-page-tab { flex:1; padding:16px 0; text-align:center; font-weight:600; font-size:0.9rem; color:var(--muted); cursor:pointer; border:none; background:none; border-bottom:2px solid transparent; transition:all 0.15s; color:var(--text); }
    .profile-page-tab.active { border-bottom-color:var(--accent); }
    .profile-page-tab:hover { background:var(--surface2); }

    /* ‚îÄ‚îÄ SEARCH RESULTS ‚îÄ‚îÄ */
    .search-results { padding:8px 0; }
    .search-result-item { display:flex; align-items:center; gap:12px; padding:12px 16px; cursor:pointer; transition:background 0.1s; }
    .search-result-item:hover { background:var(--surface2); }
    .sr-av { width:42px; height:42px; border-radius:50%; background:var(--accent); display:flex; align-items:center; justify-content:center; font-weight:700; color:#fff; overflow:hidden; flex-shrink:0; }
    .sr-av img { width:100%; height:100%; object-fit:cover; }

    /* ‚îÄ‚îÄ MODAL OVERLAY ‚îÄ‚îÄ */
    .modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.7); z-index:500; display:flex; align-items:center; justify-content:center; padding:16px; opacity:0; pointer-events:none; transition:opacity 0.2s; }
    .modal-overlay.open { opacity:1; pointer-events:all; }
    .modal { background:var(--surface); border:1px solid var(--border2); border-radius:var(--radius); padding:24px; max-width:560px; width:100%; max-height:90vh; overflow-y:auto; }

    /* ‚îÄ‚îÄ MOBILE ‚îÄ‚îÄ */
    @media (max-width:900px) { .right-col { display:none; } }
    @media (max-width:680px) {
      .left-nav { width:68px; }
      .nav-logo { font-size:1.2rem; padding:4px 8px 16px; }
      .nav-item .nav-label { display:none; }
      .nav-item { justify-content:center; padding:12px; }
      .nav-item .nav-icon { width:auto; }
      .nav-user-name, .nav-user-handle { display:none; }
      .post-btn span { display:none; }
      .post-btn { padding:14px; border-radius:50%; width:48px; height:48px; display:flex; align-items:center; justify-content:center; font-size:1.3rem; }
      .nav-spacer { display:none; }
    }

    /* ‚îÄ‚îÄ LOADING ‚îÄ‚îÄ */
    .skeleton { background:linear-gradient(90deg,var(--surface2) 25%,var(--surface3) 50%,var(--surface2) 75%); background-size:200% 100%; animation:shimmer 1.4s infinite; border-radius:6px; }
    @keyframes shimmer { 0%{background-position:200% 0} 100%{background-position:-200% 0} }
    .empty-feed { padding:48px 24px; text-align:center; color:var(--muted); }
    .empty-feed .ef-icon { font-size:3rem; margin-bottom:12px; }
    .empty-feed h3 { font-size:1.1rem; color:var(--text); margin-bottom:6px; }

    /* ‚îÄ‚îÄ EFFECT CLASSES (same as dashboard) ‚îÄ‚îÄ */
    .pp-banner.fx-sparkle::before { content:''; position:absolute; inset:0; pointer-events:none; background-image:radial-gradient(circle,rgba(255,255,255,0.9) 1px,transparent 1px); background-size:24px 24px; animation:sparkleDrift 6s linear infinite; opacity:0.45; }
    @keyframes sparkleDrift { 0%{background-position:0 0} 100%{background-position:24px 24px} }
    .pp-banner.fx-aurora::after { content:''; position:absolute; inset:0; pointer-events:none; background:linear-gradient(120deg,transparent 20%,rgba(0,255,200,0.35) 40%,transparent 60%,rgba(120,80,255,0.35) 80%,transparent); background-size:300% 100%; animation:auroraWave 4s ease-in-out infinite alternate; }
    @keyframes auroraWave { 0%{background-position:0% 50%} 100%{background-position:100% 50%} }
    .pp-banner.fx-neon { box-shadow:inset 0 0 20px rgba(0,255,180,0.5),inset 0 0 4px rgba(0,255,180,0.8); animation:neonPulse 2s ease-in-out infinite alternate; }
    @keyframes neonPulse { 0%{box-shadow:inset 0 0 12px rgba(0,255,180,0.4),inset 0 0 4px rgba(0,255,180,0.7)} 100%{box-shadow:inset 0 0 30px rgba(0,255,180,0.7),inset 0 0 8px rgba(0,255,180,1)} }
    .pp-banner.fx-holo::before { content:''; position:absolute; inset:0; pointer-events:none; background:linear-gradient(105deg,transparent 20%,rgba(255,0,128,0.25) 30%,rgba(255,140,0,0.2) 40%,rgba(0,255,120,0.2) 50%,rgba(0,160,255,0.25) 60%,rgba(180,0,255,0.2) 70%,transparent 80%); background-size:200% 100%; animation:holoSlide 2.5s linear infinite; mix-blend-mode:screen; }
    @keyframes holoSlide { 0%{background-position:0% 0} 100%{background-position:200% 0} }
    .pp-banner.fx-fire::after { content:''; position:absolute; inset:0; pointer-events:none; background:linear-gradient(0deg,rgba(255,80,0,0.6) 0%,rgba(255,200,0,0.3) 50%,transparent 100%); animation:fireRise 1.5s ease-in-out infinite alternate; }
    @keyframes fireRise { 0%{opacity:0.5;transform:scaleY(1)} 100%{opacity:0.9;transform:scaleY(1.08)} }
    .pp-banner.fx-ice::before { content:''; position:absolute; inset:0; pointer-events:none; background:radial-gradient(ellipse at 30% 50%,rgba(180,240,255,0.4) 0%,transparent 60%),radial-gradient(ellipse at 70% 30%,rgba(150,220,255,0.3) 0%,transparent 50%); animation:icePulse 3s ease-in-out infinite alternate; }
    @keyframes icePulse { 0%{opacity:0.5} 100%{opacity:1} }
    .pp-banner.fx-glitch::before { content:''; position:absolute; inset:0; pointer-events:none; background:linear-gradient(transparent 0%,rgba(255,0,100,0.15) 25%,transparent 26%,transparent 74%,rgba(0,200,255,0.15) 75%,transparent 100%); animation:glitchShift 0.8s steps(2) infinite; }
    @keyframes glitchShift { 0%{transform:translateX(0)} 25%{transform:translateX(-3px)} 50%{transform:translateX(2px)} 75%{transform:translateX(-1px)} 100%{transform:translateX(0)} }
  </style>
</head>
<body>
<div class="toast" id="toast"></div>

<div class="app" id="app" style="display:none">
  <!-- LEFT NAV -->
  <nav class="left-nav" id="left-nav">
    <a class="nav-logo" href="feed.html">Nexus</a>
    <button class="nav-item active" id="nav-home" onclick="showView('home')">
      <span class="nav-icon">üè†</span><span class="nav-label">Home</span>
    </button>
    <button class="nav-item" id="nav-explore" onclick="showView('explore')">
      <span class="nav-icon">üîç</span><span class="nav-label">Explore</span>
    </button>
    <button class="nav-item" id="nav-profile" onclick="showView('profile',currentUser?.uid)">
      <span class="nav-icon">üë§</span><span class="nav-label">Profile</span>
    </button>
    <button class="nav-item" onclick="window.location.href='dashboard.html'">
      <span class="nav-icon">üí¨</span><span class="nav-label">Messages</span>
    </button>
    <button class="nav-item" onclick="window.location.href='index.html'">
      <span class="nav-icon">‚¨ÖÔ∏è</span><span class="nav-label">Back</span>
    </button>
    <div class="nav-spacer"></div>
    <button class="post-btn" onclick="openComposeModal()">
      <span>‚ú¶ Post</span>
    </button>
    <div style="height:16px"></div>
    <button class="nav-user-card" onclick="showView('profile',currentUser?.uid)" id="nav-user-card">
      <div class="nav-user-av" id="nav-user-av"></div>
      <div style="flex:1;min-width:0">
        <div class="nav-user-name" id="nav-user-name">Loading</div>
        <div class="nav-user-handle" id="nav-user-handle">@...</div>
      </div>
      <span style="color:var(--muted)">¬∑¬∑¬∑</span>
    </button>
  </nav>

  <!-- CENTER FEED -->
  <main class="feed-col" id="feed-col">
    <!-- Content injected here -->
  </main>

  <!-- RIGHT SIDEBAR -->
  <aside class="right-col" id="right-col">
    <div class="search-box">
      <span>üîç</span>
      <input type="text" id="search-input" placeholder="Search Nexus Feed" oninput="debounceSearch(this.value)"/>
    </div>
    <div id="right-content">
      <!-- trending / who to follow -->
    </div>
  </aside>
</div>

<!-- AUTH WALL -->
<div id="auth-wall" style="display:none;position:fixed;inset:0;background:var(--bg);display:flex;align-items:center;justify-content:center;flex-direction:column;gap:16px;z-index:1000">
  <div style="font-family:'Syne',sans-serif;font-size:2rem;font-weight:800;background:linear-gradient(135deg,#5b6af0,#e040fb);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text">Nexus Feed</div>
  <p style="color:var(--muted);text-align:center;max-width:320px">Sign in to Nexus to see posts, follow people, and share your thoughts.</p>
  <button onclick="window.location.href='index.html'" style="padding:12px 32px;background:var(--accent);color:#fff;border:none;border-radius:100px;font-family:'DM Sans',sans-serif;font-weight:700;font-size:1rem;cursor:pointer">Go to Nexus ‚Üí</button>
</div>

<!-- COMPOSE MODAL -->
<div class="modal-overlay" id="compose-modal">
  <div class="modal" style="padding:0">
    <div style="display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--border)">
      <button onclick="closeComposeModal()" style="background:none;border:none;color:var(--text);cursor:pointer;font-size:1.1rem;padding:6px;border-radius:50%">√ó</button>
      <span style="font-weight:700">New Post</span>
      <span></span>
    </div>
    <div style="padding:16px;display:flex;gap:12px">
      <div class="compose-av" id="modal-compose-av"></div>
      <div style="flex:1;min-width:0">
        <textarea id="modal-compose-text" class="compose-textarea" placeholder="What's on your mind?" maxlength="505" oninput="updateModalCharCount()" style="min-height:100px"></textarea>
        <div id="modal-media-preview" class="compose-media-preview"></div>
        <div class="compose-divider"></div>
        <div class="compose-actions">
          <div class="compose-media-btns">
            <button class="compose-icon-btn" id="modal-img-btn" title="Add image (max 4)" onclick="document.getElementById('modal-img-input').click()">üñºÔ∏è</button>
            <button class="compose-icon-btn" id="modal-gif-btn" title="Add GIF (max 4)" onclick="document.getElementById('modal-gif-input').click()">üéûÔ∏è</button>
            <button class="compose-icon-btn" id="modal-vid-btn" title="Add video (1 max)" onclick="document.getElementById('modal-vid-input').click()">üé¨</button>
          </div>
          <div style="display:flex;align-items:center;gap:12px">
            <span class="compose-char-count" id="modal-char-count">500</span>
            <button class="compose-submit" id="modal-submit-btn" onclick="submitPost()" disabled>Post</button>
          </div>
        </div>
      </div>
    </div>
    <input type="file" id="modal-img-input" accept="image/png,image/jpeg,image/webp" multiple style="display:none" onchange="handleModalMedia(event,'image')"/>
    <input type="file" id="modal-gif-input" accept="image/gif" multiple style="display:none" onchange="handleModalMedia(event,'gif')"/>
    <input type="file" id="modal-vid-input" accept="video/*" style="display:none" onchange="handleModalMedia(event,'video')"/>
  </div>
</div>

<!-- REPLY MODAL -->
<div class="modal-overlay" id="reply-modal">
  <div class="modal" style="padding:0">
    <div style="display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--border)">
      <button onclick="closeReplyModal()" style="background:none;border:none;color:var(--text);cursor:pointer;font-size:1.1rem;padding:6px;border-radius:50%">√ó</button>
      <span style="font-weight:700">Reply</span>
      <span></span>
    </div>
    <div id="reply-parent-preview" style="padding:14px 16px;border-bottom:1px solid var(--border);opacity:0.7;font-size:0.88rem"></div>
    <div style="padding:16px;display:flex;gap:12px">
      <div class="compose-av" id="reply-compose-av"></div>
      <div style="flex:1;min-width:0">
        <textarea id="reply-text" class="compose-textarea" placeholder="Post your reply..." maxlength="505" oninput="updateReplyCharCount()" style="min-height:80px"></textarea>
        <div class="compose-divider"></div>
        <div style="display:flex;justify-content:space-between;align-items:center">
          <span class="compose-char-count" id="reply-char-count">500</span>
          <button class="compose-submit" id="reply-submit-btn" onclick="submitReply()" disabled>Reply</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- EDIT PROFILE MODAL (feed bio) -->
<div class="modal-overlay" id="edit-feed-profile-modal">
  <div class="modal">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px">
      <h3 style="font-family:'Syne',sans-serif;font-weight:700">Edit Feed Profile</h3>
      <button onclick="closeModal('edit-feed-profile-modal')" style="background:none;border:none;color:var(--muted);cursor:pointer;font-size:1.2rem">√ó</button>
    </div>
    <p style="font-size:0.82rem;color:var(--muted);margin-bottom:16px">Your display name and avatar come from your Nexus profile. You can set a separate bio for your Feed profile here.</p>
    <div style="margin-bottom:14px">
      <label style="font-size:0.78rem;font-weight:700;text-transform:uppercase;letter-spacing:0.06em;color:var(--muted);display:block;margin-bottom:6px">Feed Bio</label>
      <textarea id="feed-bio-input" rows="4" style="width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:10px 12px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:0.9rem;resize:none;outline:none" placeholder="Tell the feed who you are..." maxlength="200"></textarea>
      <div style="text-align:right;font-size:0.75rem;color:var(--muted);margin-top:4px">max 200 chars</div>
    </div>
    <div style="display:flex;gap:10px;justify-content:flex-end">
      <button onclick="closeModal('edit-feed-profile-modal')" style="padding:9px 18px;background:var(--surface2);border:1px solid var(--border);border-radius:100px;color:var(--text);font-family:'DM Sans',sans-serif;font-weight:600;cursor:pointer;font-size:0.88rem">Cancel</button>
      <button onclick="saveFeedProfile()" style="padding:9px 18px;background:var(--accent);border:none;border-radius:100px;color:#fff;font-family:'DM Sans',sans-serif;font-weight:700;cursor:pointer;font-size:0.88rem">Save</button>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc, collection, query, where, getDocs, addDoc, onSnapshot, orderBy, serverTimestamp, limit, arrayUnion, arrayRemove, getCountFromServer } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

const FB = { apiKey:"AIzaSyDKGqss5jcCNd_AYYohYs-KaSKvZUemX-4", authDomain:"nexus-app-74493.firebaseapp.com", projectId:"nexus-app-74493", storageBucket:"nexus-app-74493.firebasestorage.app", messagingSenderId:"179885556901", appId:"1:179885556901:web:1966afe8102de60d9cb94c" };
const CLOUDINARY_CLOUD = 'dskssf3tn';
const CLOUDINARY_PRESET = 'nexus_avatars';
const MAX_CHARS = 500;

const app = initializeApp(FB);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUser = null;
let myProfile = null; // Nexus profile
let myFeedProfile = null; // Feed-specific data (bio, following, etc.)
let currentView = 'home';
let replyTargetPost = null;
let pendingMedia = []; // [{file, dataUrl, type: 'image'|'gif'|'video'}]
let feedUnsub = null;
let profileCache = {};

// ‚îÄ‚îÄ URL param: open specific user profile ‚îÄ‚îÄ
const urlParams = new URLSearchParams(window.location.search);
const profileUidParam = urlParams.get('uid');

// ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ
const esc = s => String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
const colorPalette=['#5b6af0','#e040fb','#00bcd4','#ff7043','#4caf50','#ffc107','#e91e63','#9c27b0','#00acc1'];
const color = u => colorPalette[Array.from(u||'x').reduce((a,c)=>a+c.charCodeAt(0),0)%colorPalette.length];

function timeAgo(ts) {
  if (!ts) return '';
  const d = ts.toDate ? ts.toDate() : new Date(ts);
  const s = Math.floor((Date.now() - d) / 1000);
  if (s < 60) return s + 's';
  if (s < 3600) return Math.floor(s/60) + 'm';
  if (s < 86400) return Math.floor(s/3600) + 'h';
  if (s < 604800) return Math.floor(s/86400) + 'd';
  return d.toLocaleDateString('en-US',{month:'short',day:'numeric'});
}

function showToast(msg, type='') {
  const t = document.getElementById('toast');
  t.textContent = msg; t.className = 'toast show' + (type ? ' '+type : '');
  clearTimeout(t._to); t._to = setTimeout(()=>t.classList.remove('show'),3000);
}

function openModal(id) { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }

// ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ
onAuthStateChanged(auth, async user => {
  if (!user) {
    document.getElementById('auth-wall').style.display = 'flex';
    document.getElementById('app').style.display = 'none';
    return;
  }
  currentUser = user;
  await loadMyProfiles();
  document.getElementById('auth-wall').style.display = 'none';
  document.getElementById('app').style.display = 'flex';
  updateNavUser();
  loadRightSidebar();

  // Check if landing on specific profile
  if (profileUidParam && profileUidParam !== currentUser.uid) {
    showView('profile', profileUidParam);
  } else if (profileUidParam === currentUser.uid) {
    showView('profile', currentUser.uid);
  } else {
    showView('home');
  }
});

async function loadMyProfiles() {
  const snap = await getDoc(doc(db, 'users', currentUser.uid));
  myProfile = snap.exists() ? snap.data() : {};
  const feedSnap = await getDoc(doc(db, 'feedProfiles', currentUser.uid));
  myFeedProfile = feedSnap.exists() ? feedSnap.data() : { feedBio: '', following: [], followers: [] };
  if (!myFeedProfile.following) myFeedProfile.following = [];
  if (!myFeedProfile.followers) myFeedProfile.followers = [];
}

function updateNavUser() {
  const name = myProfile.displayName || myProfile.username || 'Me';
  const av = document.getElementById('nav-user-av');
  if (myProfile.avatarUrl) { av.innerHTML = `<img src="${myProfile.avatarUrl}"/>`; av.style.background=''; }
  else { av.textContent = name[0].toUpperCase(); av.style.background = color(myProfile.username||'x'); }
  document.getElementById('nav-user-name').textContent = name;
  document.getElementById('nav-user-handle').textContent = '@' + (myProfile.username||'');
}

// ‚îÄ‚îÄ PROFILE CACHE ‚îÄ‚îÄ
async function getProfile(uid) {
  if (profileCache[uid]) return profileCache[uid];
  const [nexusSnap, feedSnap] = await Promise.all([
    getDoc(doc(db,'users',uid)),
    getDoc(doc(db,'feedProfiles',uid))
  ]);
  const nexus = nexusSnap.exists() ? nexusSnap.data() : {};
  const feed = feedSnap.exists() ? feedSnap.data() : {};
  const merged = { ...nexus, feedBio: feed.feedBio||'', following: feed.following||[], followers: feed.followers||[], id: uid };
  profileCache[uid] = merged;
  return merged;
}

// ‚îÄ‚îÄ VIEWS ‚îÄ‚îÄ
window.showView = async function(view, param) {
  currentView = view;
  if (feedUnsub) { feedUnsub(); feedUnsub = null; }
  document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
  const navMap = { home:'nav-home', explore:'nav-explore', profile:'nav-profile' };
  const nb = document.getElementById(navMap[view]);
  if (nb) nb.classList.add('active');

  const fc = document.getElementById('feed-col');
  fc.innerHTML = '<div class="empty-feed"><div class="skeleton" style="height:48px;margin:16px"></div><div class="skeleton" style="height:120px;margin:16px;margin-top:0"></div><div class="skeleton" style="height:120px;margin:16px;margin-top:0"></div></div>';

  if (view === 'home') await renderHome();
  else if (view === 'explore') await renderExplore();
  else if (view === 'profile') await renderProfile(param || currentUser.uid);
  else if (view === 'post') await renderPost(param);
};

// ‚îÄ‚îÄ HOME FEED ‚îÄ‚îÄ
async function renderHome() {
  const fc = document.getElementById('feed-col');
  fc.innerHTML = `
    <div class="feed-header">
      <div style="padding:14px 16px;font-family:'Syne',sans-serif;font-weight:700;font-size:1.05rem;border-bottom:1px solid var(--border)">Home</div>
    </div>
    <div id="home-compose" class="compose-box">
      <div class="compose-av" id="compose-my-av"></div>
      <div class="compose-right">
        <textarea id="inline-compose" class="compose-textarea" placeholder="What's on your mind?" onclick="openComposeModal()" readonly style="cursor:pointer" rows="2"></textarea>
        <div class="compose-divider"></div>
        <div class="compose-actions">
          <div class="compose-media-btns">
            <button class="compose-icon-btn" onclick="openComposeModal()">üñºÔ∏è</button>
            <button class="compose-icon-btn" onclick="openComposeModal()">üéûÔ∏è</button>
            <button class="compose-icon-btn" onclick="openComposeModal()">üé¨</button>
          </div>
          <button class="compose-submit" onclick="openComposeModal()">Post</button>
        </div>
      </div>
    </div>
    <div id="feed-posts"></div>`;

  // Set compose avatar
  const cav = document.getElementById('compose-my-av');
  const name = myProfile.displayName || myProfile.username || '?';
  if (myProfile.avatarUrl) { cav.innerHTML = `<img src="${myProfile.avatarUrl}"/>`; cav.style.background=''; }
  else { cav.textContent = name[0].toUpperCase(); cav.style.background = color(myProfile.username||'x'); }

  // Live feed: posts from self + following
  const followingIds = [...(myFeedProfile.following||[]), currentUser.uid];
  const q = query(collection(db,'feedPosts'), orderBy('createdAt','desc'), limit(40));
  feedUnsub = onSnapshot(q, snap => {
    const posts = snap.docs.map(d=>({id:d.id,...d.data()})).filter(p=>followingIds.includes(p.authorUid) && !p.replyTo);
    renderPostList(posts, document.getElementById('feed-posts'));
  });
}

// ‚îÄ‚îÄ EXPLORE ‚îÄ‚îÄ
async function renderExplore() {
  const fc = document.getElementById('feed-col');
  fc.innerHTML = `
    <div class="feed-header" style="padding:14px 16px;font-family:'Syne',sans-serif;font-weight:700;font-size:1.05rem">Explore</div>
    <div style="padding:12px 16px;border-bottom:1px solid var(--border)">
      <div class="search-box" style="margin-bottom:0">
        <span>üîç</span>
        <input type="text" id="explore-search" class="search-input" placeholder="Search people or posts..." oninput="runExploreSearch(this.value)" style="flex:1;background:none;border:none;outline:none;color:var(--text);font-family:'DM Sans',sans-serif;font-size:0.9rem"/>
      </div>
    </div>
    <div id="explore-results"><div id="recent-posts-section"></div></div>`;

  // Default: show recent public posts
  const q = query(collection(db,'feedPosts'), orderBy('createdAt','desc'), limit(30));
  const snap = await getDocs(q);
  const posts = snap.docs.map(d=>({id:d.id,...d.data()})).filter(p=>!p.replyTo);
  renderPostList(posts, document.getElementById('recent-posts-section'));
}

window.runExploreSearch = async function(val) {
  const res = document.getElementById('explore-results');
  if (!val.trim()) { res.innerHTML = '<div id="recent-posts-section"></div>'; return; }
  res.innerHTML = '<div class="empty-feed"><div class="skeleton" style="height:60px;margin-bottom:8px"></div></div>';
  // Search users by username prefix
  const v = val.toLowerCase().replace('@','');
  const usnap = await getDocs(query(collection(db,'users'), where('username','>=',v), where('username','<=',v+'\uf8ff'), limit(8)));
  const users = usnap.docs.map(d=>({id:d.id,...d.data()}));
  let html = '';
  if (users.length) {
    html += `<div style="padding:10px 16px;font-size:0.75rem;font-weight:700;letter-spacing:0.06em;color:var(--muted);text-transform:uppercase">People</div>`;
    html += `<div class="search-results">` + users.map(u=>`
      <div class="search-result-item" onclick="showView('profile','${u.id}')">
        <div class="sr-av" style="background:${color(u.username)}">${u.avatarUrl?`<img src="${u.avatarUrl}"/>`:(u.displayName||u.username||'?')[0].toUpperCase()}</div>
        <div>
          <div style="font-weight:700;font-size:0.9rem">${esc(u.displayName||u.username)}</div>
          <div style="font-size:0.78rem;color:var(--muted)">@${esc(u.username)}</div>
        </div>
      </div>`).join('') + `</div>`;
  }
  res.innerHTML = html || `<div class="empty-feed"><div class="ef-icon">üîç</div><h3>No results for "${esc(val)}"</h3></div>`;
};

// ‚îÄ‚îÄ PROFILE ‚îÄ‚îÄ
async function renderProfile(uid) {
  const fc = document.getElementById('feed-col');
  const profile = await getProfile(uid);
  const isMe = uid === currentUser.uid;
  const name = profile.displayName || profile.username || 'Unknown';
  const feedBio = uid === currentUser.uid ? (myFeedProfile.feedBio||'') : (profile.feedBio||'');

  // Follow state
  const amFollowing = (myFeedProfile.following||[]).includes(uid);
  const followerCount = profile.followers?.length || 0;
  const followingCount = profile.following?.length || 0;

  // Banner with effect
  const fxClass = profile.effect && profile.effect !== 'none' ? ' fx-' + profile.effect : '';
  let bannerInner = '';
  if (profile.bannerUrl) {
    const isGif = profile.bannerUrl.includes('.gif');
    const pos = profile.bannerPos || '50% 50%';
    bannerInner = isGif
      ? `<video autoplay loop muted playsinline style="width:100%;height:100%;object-fit:cover;object-position:${pos};position:absolute;inset:0" src="${profile.bannerUrl}"></video>`
      : `<img src="${profile.bannerUrl}" style="width:100%;height:100%;object-fit:cover;object-position:${pos};position:absolute;inset:0"/>`;
  }
  const bannerBg = profile.bannerUrl ? '' : `linear-gradient(135deg,${color(profile.username||'x')},${color((profile.username||'x')+'2')})`;

  fc.innerHTML = `
    <div style="position:sticky;top:0;z-index:10;background:rgba(11,12,16,0.85);backdrop-filter:blur(16px);border-bottom:1px solid var(--border);padding:12px 16px;display:flex;align-items:center;gap:14px">
      <button class="back-btn" onclick="showView('home')">‚Üê</button>
      <div>
        <div style="font-family:'Syne',sans-serif;font-weight:700;font-size:1rem">${esc(name)}</div>
        <div style="font-size:0.78rem;color:var(--muted)" id="profile-post-count">posts</div>
      </div>
    </div>
    <div class="profile-page-header">
      <div class="profile-page-banner pp-banner${fxClass}" style="background:${bannerBg}">${bannerInner}</div>
      <div class="profile-page-av-row">
        <div class="profile-page-av" style="background:${color(profile.username||'x')}">
          ${profile.avatarUrl ? `<img src="${profile.avatarUrl}"/>` : name[0].toUpperCase()}
        </div>
        ${isMe
          ? `<button class="profile-edit-btn" onclick="openEditFeedProfile()">Edit Profile</button>`
          : `<button class="profile-follow-btn${amFollowing?' following':''}" id="follow-btn" onclick="toggleFollow('${uid}')">${amFollowing?'Following':'Follow'}</button>`}
      </div>
      <div class="profile-page-info">
        <div class="profile-page-name">${esc(name)}</div>
        <div class="profile-page-handle">@${esc(profile.username||'')}</div>
        ${feedBio ? `<div class="profile-page-bio">${esc(feedBio)}</div>` : ''}
        ${profile.bio ? `<div style="font-size:0.84rem;color:var(--muted);margin-bottom:6px">üí¨ ${esc(profile.bio)}</div>` : ''}
        <div class="profile-page-stats">
          <a href="#"><strong>${followingCount}</strong> <span>Following</span></a>
          <a href="#"><strong>${followerCount}</strong> <span>Followers</span></a>
        </div>
      </div>
      <div class="profile-page-tabs">
        <button class="profile-page-tab active" id="tab-posts" onclick="switchProfileTab('posts','${uid}')">Posts</button>
        <button class="profile-page-tab" id="tab-replies" onclick="switchProfileTab('replies','${uid}')">Replies</button>
      </div>
    </div>
    <div id="profile-posts"></div>`;

  loadProfilePosts(uid, 'posts');
}

window.switchProfileTab = function(tab, uid) {
  document.querySelectorAll('.profile-page-tab').forEach(t=>t.classList.remove('active'));
  document.getElementById('tab-'+tab)?.classList.add('active');
  loadProfilePosts(uid, tab);
};

async function loadProfilePosts(uid, tab) {
  const container = document.getElementById('profile-posts');
  if (!container) return;
  container.innerHTML = '<div class="empty-feed"><div class="skeleton" style="height:100px;margin-bottom:8px"></div></div>';
  const q = tab === 'replies'
    ? query(collection(db,'feedPosts'), where('authorUid','==',uid), where('replyTo','!=',null), orderBy('replyTo'), orderBy('createdAt','desc'), limit(20))
    : query(collection(db,'feedPosts'), where('authorUid','==',uid), orderBy('createdAt','desc'), limit(30));
  const snap = await getDocs(q);
  const posts = snap.docs.map(d=>({id:d.id,...d.data()})).filter(p=>tab==='replies'?!!p.replyTo:!p.replyTo);
  // Update count
  const countEl = document.getElementById('profile-post-count');
  if (countEl) countEl.textContent = posts.length + ' post' + (posts.length!==1?'s':'');
  renderPostList(posts, container);
}

// ‚îÄ‚îÄ SINGLE POST ‚îÄ‚îÄ
async function renderPost(postId) {
  const fc = document.getElementById('feed-col');
  const postSnap = await getDoc(doc(db,'feedPosts',postId));
  if (!postSnap.exists()) { fc.innerHTML='<div class="empty-feed"><div class="ef-icon">üîç</div><h3>Post not found</h3></div>'; return; }
  const post = { id: postSnap.id, ...postSnap.data() };
  const author = await getProfile(post.authorUid);
  const authorName = author.displayName || author.username || '?';
  const likedByMe = (post.likes||[]).includes(currentUser.uid);

  // Load replies
  const repliesSnap = await getDocs(query(collection(db,'feedPosts'), where('replyTo','==',postId), orderBy('createdAt','asc'), limit(30)));
  const replies = repliesSnap.docs.map(d=>({id:d.id,...d.data()}));

  const cav = myProfile.avatarUrl ? `<img src="${myProfile.avatarUrl}"/>` : (myProfile.displayName||myProfile.username||'?')[0].toUpperCase();
  const cavBg = myProfile.avatarUrl ? '' : `background:${color(myProfile.username||'x')}`;

  fc.innerHTML = `
    <div style="position:sticky;top:0;z-index:10;background:rgba(11,12,16,0.85);backdrop-filter:blur(16px);border-bottom:1px solid var(--border);padding:12px 16px;display:flex;align-items:center;gap:14px">
      <button class="back-btn" onclick="history.back()">‚Üê</button>
      <span style="font-family:'Syne',sans-serif;font-weight:700">Post</span>
    </div>
    <div class="post-detail-card">
      <div class="post-detail-av-row">
        <div class="post-detail-av" style="background:${color(author.username||'x')}" onclick="showView('profile','${post.authorUid}')">
          ${author.avatarUrl?`<img src="${author.avatarUrl}"/>`:authorName[0].toUpperCase()}
        </div>
        <div>
          <div style="font-weight:700">${esc(authorName)}</div>
          <div style="font-size:0.8rem;color:var(--muted)">@${esc(author.username||'')}</div>
        </div>
      </div>
      <div class="post-detail-body">${esc(post.text)}</div>
      ${renderMediaGrid(post.media||[])}
      <div class="post-detail-time">${post.createdAt?new Date(post.createdAt.toDate?post.createdAt.toDate():post.createdAt).toLocaleString('en-US',{month:'long',day:'numeric',year:'numeric',hour:'numeric',minute:'2-digit'}):''}</div>
      <div class="post-detail-stats">
        <div class="stat-item"><strong>${(post.likes||[]).length}</strong> <span>Likes</span></div>
        <div class="stat-item"><strong>${replies.length}</strong> <span>Replies</span></div>
      </div>
      <div class="post-actions" style="padding-left:0">
        <button class="post-action-btn reply-btn" onclick="openReplyModal('${post.id}','${esc(authorName)}','${esc(post.text.substring(0,60))}')">
          <span class="act-icon">üí¨</span><span>${replies.length}</span>
        </button>
        <button class="post-action-btn like-btn${likedByMe?' liked':''}" id="detail-like-btn" onclick="toggleLike('${post.id}')">
          <span class="act-icon">${likedByMe?'‚ù§Ô∏è':'ü§ç'}</span><span id="detail-like-count">${(post.likes||[]).length}</span>
        </button>
        ${post.authorUid===currentUser.uid?`<button class="post-action-btn" onclick="deletePost('${post.id}')" style="margin-left:auto;color:var(--error)">üóëÔ∏è Delete</button>`:''}
      </div>
    </div>
    <div class="reply-compose">
      <div class="compose-av" style="${cavBg}">${cav}</div>
      <div style="flex:1">
        <textarea id="inline-reply-text" class="compose-textarea" placeholder="Post your reply..." style="min-height:60px" oninput="this.nextElementSibling.querySelector('button').disabled=!this.value.trim()"></textarea>
        <div style="text-align:right;margin-top:4px"><button class="compose-submit" disabled onclick="submitInlineReply('${post.id}')">Reply</button></div>
      </div>
    </div>
    <div id="replies-list"></div>`;

  renderPostList(replies, document.getElementById('replies-list'), true);
}

// ‚îÄ‚îÄ RENDER POSTS ‚îÄ‚îÄ
function renderPostList(posts, container, isReplies=false) {
  if (!container) return;
  if (!posts.length) {
    container.innerHTML = `<div class="empty-feed"><div class="ef-icon">${isReplies?'üí¨':'‚ú¶'}</div><h3>${isReplies?'No replies yet':'Nothing here yet'}</h3><p>${isReplies?'Be the first to reply!':'Follow people or post something!'}</p></div>`;
    return;
  }
  container.innerHTML = '';
  posts.forEach(post => container.appendChild(createPostEl(post)));
}

function createPostEl(post) {
  const card = document.createElement('div');
  card.className = 'post-card';
  card.dataset.postId = post.id;

  const author = profileCache[post.authorUid] || {};
  const name = author.displayName || author.username || '...';
  const likedByMe = (post.likes||[]).includes(currentUser.uid);
  const repostsByMe = (post.reposts||[]).includes(currentUser.uid);
  const likeCount = (post.likes||[]).length;
  const replyCount = post.replyCount || 0;
  const repostCount = (post.reposts||[]).length;

  card.innerHTML = `
    <div class="post-header">
      <div class="post-av" style="background:${color(author.username||'x')}" onclick="event.stopPropagation();showView('profile','${post.authorUid}')">
        ${author.avatarUrl?`<img src="${author.avatarUrl}"/>`:name[0].toUpperCase()}
      </div>
      <div class="post-meta">
        <span class="post-name">${esc(name)}</span>
        <span class="post-handle">@${esc(author.username||'')}</span>
        <span class="post-time">¬∑ ${timeAgo(post.createdAt)}</span>
      </div>
      ${post.authorUid===currentUser.uid?`<button onclick="event.stopPropagation();deletePost('${post.id}')" style="margin-left:auto;background:none;border:none;color:var(--muted);cursor:pointer;padding:4px 8px;border-radius:6px;font-size:0.8rem" title="Delete">üóë</button>`:''}
    </div>
    <div class="post-body">${esc(post.text)}</div>
    ${post.media?.length ? `<div class="post-media">${renderMediaGrid(post.media)}</div>` : ''}
    <div class="post-actions">
      <button class="post-action-btn reply-btn" onclick="event.stopPropagation();openReplyModal('${post.id}','${esc(name)}','${esc((post.text||'').substring(0,60))}')">
        <span class="act-icon">üí¨</span><span>${replyCount}</span>
      </button>
      <button class="post-action-btn repost-btn${repostsByMe?' reposted':''}" onclick="event.stopPropagation();toggleRepost('${post.id}')">
        <span class="act-icon">üîÅ</span><span id="rp-${post.id}">${repostCount}</span>
      </button>
      <button class="post-action-btn like-btn${likedByMe?' liked':''}" id="like-${post.id}" onclick="event.stopPropagation();toggleLike('${post.id}')">
        <span class="act-icon">${likedByMe?'‚ù§Ô∏è':'ü§ç'}</span><span id="lc-${post.id}">${likeCount}</span>
      </button>
    </div>`;

  // Prefetch author profile if not cached
  if (!profileCache[post.authorUid]) {
    getProfile(post.authorUid).then(p => {
      profileCache[post.authorUid] = p;
      const av = card.querySelector('.post-av');
      if (av) {
        av.style.background = color(p.username||'x');
        av.innerHTML = p.avatarUrl ? `<img src="${p.avatarUrl}"/>` : (p.displayName||p.username||'?')[0].toUpperCase();
      }
      const nm = card.querySelector('.post-name');
      if (nm) nm.textContent = p.displayName || p.username || '?';
      const hn = card.querySelector('.post-handle');
      if (hn) hn.textContent = '@' + (p.username||'');
    });
  }

  card.addEventListener('click', () => showView('post', post.id));
  return card;
}

function renderMediaGrid(media) {
  if (!media || !media.length) return '';
  const n = Math.min(media.length, 4);
  const items = media.slice(0, n).map(m => {
    if (m.type === 'video') return `<div class="media-item"><video src="${m.url}" controls preload="none" style="max-height:320px;width:100%"></video></div>`;
    return `<div class="media-item"><img src="${m.url}" loading="lazy" onclick="event.stopPropagation();window.open('${m.url}','_blank')"/></div>`;
  }).join('');
  return `<div class="post-media-grid n${n}">${items}</div>`;
}

// ‚îÄ‚îÄ COMPOSE ‚îÄ‚îÄ
window.openComposeModal = function() {
  pendingMedia = [];
  document.getElementById('modal-compose-text').value = '';
  document.getElementById('modal-media-preview').innerHTML = '';
  document.getElementById('modal-char-count').textContent = MAX_CHARS;
  document.getElementById('modal-submit-btn').disabled = true;
  updateModalMediaBtns();
  const av = document.getElementById('modal-compose-av');
  const name = myProfile.displayName || myProfile.username || '?';
  if (myProfile.avatarUrl) { av.innerHTML=`<img src="${myProfile.avatarUrl}"/>`; av.style.background=''; }
  else { av.textContent=name[0].toUpperCase(); av.style.background=color(myProfile.username||'x'); }
  openModal('compose-modal');
};
window.closeComposeModal = function() { closeModal('compose-modal'); };

window.updateModalCharCount = function() {
  const val = document.getElementById('modal-compose-text').value;
  const rem = MAX_CHARS - val.length;
  const el = document.getElementById('modal-char-count');
  el.textContent = rem;
  el.className = 'compose-char-count' + (rem < 20 ? ' warn' : '') + (rem < 0 ? ' over' : '');
  document.getElementById('modal-submit-btn').disabled = !val.trim() || rem < 0;
};

window.handleModalMedia = function(event, type) {
  const files = Array.from(event.target.files);
  event.target.value = '';
  if (!files.length) return;

  if (type === 'video') {
    if (pendingMedia.some(m=>m.type==='image'||m.type==='gif')) { showToast('Cannot mix video with images/GIFs','error'); return; }
    if (pendingMedia.some(m=>m.type==='video')) { showToast('Only 1 video per post','error'); return; }
    const f = files[0];
    if (f.size > 50*1024*1024) { showToast('Video must be under 50MB','error'); return; }
    const url = URL.createObjectURL(f);
    pendingMedia.push({file:f, dataUrl:url, type:'video'});
  } else {
    if (pendingMedia.some(m=>m.type==='video')) { showToast('Cannot mix video with images/GIFs','error'); return; }
    const remaining = 4 - pendingMedia.length;
    if (remaining <= 0) { showToast('Max 4 images/GIFs per post','error'); return; }
    files.slice(0, remaining).forEach(f => {
      if (f.size > 8*1024*1024) { showToast('Each file must be under 8MB','error'); return; }
      const url = URL.createObjectURL(f);
      pendingMedia.push({file:f, dataUrl:url, type});
    });
  }
  updateModalMediaPreview();
  updateModalMediaBtns();
};

function updateModalMediaPreview() {
  const p = document.getElementById('modal-media-preview');
  p.innerHTML = '';
  pendingMedia.forEach((m,i) => {
    const wrap = document.createElement('div'); wrap.className = 'compose-media-item';
    if (m.type === 'video') wrap.innerHTML = `<video src="${m.dataUrl}" style="height:100px;max-width:160px;border-radius:10px"></video>`;
    else wrap.innerHTML = `<img src="${m.dataUrl}"/>`;
    const rmv = document.createElement('button'); rmv.className = 'compose-media-remove'; rmv.textContent = '√ó';
    rmv.onclick = () => { pendingMedia.splice(i,1); updateModalMediaPreview(); updateModalMediaBtns(); };
    wrap.appendChild(rmv);
    p.appendChild(wrap);
  });
}

function updateModalMediaBtns() {
  const hasVideo = pendingMedia.some(m=>m.type==='video');
  const hasImg = pendingMedia.some(m=>m.type==='image'||m.type==='gif');
  const full = pendingMedia.length >= 4;
  document.getElementById('modal-img-btn').disabled = hasVideo || full;
  document.getElementById('modal-gif-btn').disabled = hasVideo || full;
  document.getElementById('modal-vid-btn').disabled = hasImg || hasVideo;
}

window.submitPost = async function() {
  const text = document.getElementById('modal-compose-text').value.trim();
  if (!text || text.length > MAX_CHARS) return;
  const btn = document.getElementById('modal-submit-btn');
  btn.disabled = true; btn.textContent = 'Posting...';

  try {
    const media = await uploadMedia();
    await addDoc(collection(db,'feedPosts'), {
      authorUid: currentUser.uid,
      text,
      media,
      likes: [],
      reposts: [],
      replyCount: 0,
      replyTo: null,
      createdAt: serverTimestamp()
    });
    closeComposeModal();
    showToast('Posted! ‚ú®','success');
  } catch(e) { showToast('Post failed: '+e.message,'error'); btn.disabled=false; btn.textContent='Post'; }
};

async function uploadMedia() {
  if (!pendingMedia.length) return [];
  const results = [];
  for (const m of pendingMedia) {
    const fd = new FormData();
    fd.append('file', m.file);
    fd.append('upload_preset', CLOUDINARY_PRESET);
    fd.append('public_id', `feed/${currentUser.uid}_${Date.now()}_${Math.random().toString(36).slice(2)}`);
    if (m.type !== 'video') fd.append('resource_type','image');
    const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD}/${m.type==='video'?'video':'image'}/upload`, {method:'POST',body:fd});
    const data = await res.json();
    if (data.secure_url) results.push({ url: data.secure_url, type: m.type });
    else throw new Error(data.error?.message || 'Upload failed');
  }
  return results;
}

// ‚îÄ‚îÄ REPLY ‚îÄ‚îÄ
window.openReplyModal = function(postId, authorName, preview) {
  replyTargetPost = postId;
  document.getElementById('reply-text').value = '';
  document.getElementById('reply-submit-btn').disabled = true;
  document.getElementById('reply-char-count').textContent = MAX_CHARS;
  document.getElementById('reply-parent-preview').innerHTML = `<span style="color:var(--muted)">Replying to </span><strong>@${esc(authorName)}</strong><div style="margin-top:4px;color:var(--muted)">${esc(preview)}${preview.length>=60?'‚Ä¶':''}</div>`;
  const av = document.getElementById('reply-compose-av');
  const name = myProfile.displayName||myProfile.username||'?';
  if (myProfile.avatarUrl){av.innerHTML=`<img src="${myProfile.avatarUrl}"/>`;av.style.background='';}
  else{av.textContent=name[0].toUpperCase();av.style.background=color(myProfile.username||'x');}
  openModal('reply-modal');
};
window.closeReplyModal = function() { closeModal('reply-modal'); replyTargetPost=null; };
window.updateReplyCharCount = function() {
  const val = document.getElementById('reply-text').value;
  const rem = MAX_CHARS - val.length;
  const el = document.getElementById('reply-char-count');
  el.textContent = rem;
  el.className = 'compose-char-count'+(rem<20?' warn':'')+(rem<0?' over':'');
  document.getElementById('reply-submit-btn').disabled = !val.trim()||rem<0;
};
window.submitReply = async function() {
  const text = document.getElementById('reply-text').value.trim();
  if (!text || !replyTargetPost) return;
  try {
    await addDoc(collection(db,'feedPosts'),{authorUid:currentUser.uid,text,media:[],likes:[],reposts:[],replyTo:replyTargetPost,createdAt:serverTimestamp()});
    await updateDoc(doc(db,'feedPosts',replyTargetPost),{replyCount:(await getDoc(doc(db,'feedPosts',replyTargetPost))).data()?.replyCount+1||1});
    closeReplyModal(); showToast('Reply posted!','success');
  } catch(e){showToast('Failed: '+e.message,'error');}
};
window.submitInlineReply = async function(postId) {
  const ta = document.getElementById('inline-reply-text');
  const text = ta.value.trim(); if (!text) return;
  ta.value=''; ta.nextElementSibling.querySelector('button').disabled=true;
  try {
    await addDoc(collection(db,'feedPosts'),{authorUid:currentUser.uid,text,media:[],likes:[],reposts:[],replyTo:postId,createdAt:serverTimestamp()});
    await updateDoc(doc(db,'feedPosts',postId),{replyCount:(await getDoc(doc(db,'feedPosts',postId))).data()?.replyCount+1||1});
    showView('post',postId);
  } catch(e){showToast('Failed: '+e.message,'error');}
};

// ‚îÄ‚îÄ LIKES / REPOSTS ‚îÄ‚îÄ
window.toggleLike = async function(postId) {
  const postRef = doc(db,'feedPosts',postId);
  const snap = await getDoc(postRef);
  if (!snap.exists()) return;
  const likes = snap.data().likes||[];
  const liked = likes.includes(currentUser.uid);
  await updateDoc(postRef,{likes: liked?arrayRemove(currentUser.uid):arrayUnion(currentUser.uid)});
  // Update UI
  const btn = document.getElementById('like-'+postId);
  const cnt = document.getElementById('lc-'+postId);
  if (btn) { btn.classList.toggle('liked',!liked); btn.querySelector('.act-icon').textContent=liked?'ü§ç':'‚ù§Ô∏è'; }
  if (cnt) cnt.textContent = Math.max(0, parseInt(cnt.textContent)+(liked?-1:1));
  const dbtn=document.getElementById('detail-like-btn');
  const dcnt=document.getElementById('detail-like-count');
  if (dbtn){dbtn.classList.toggle('liked',!liked);dbtn.querySelector('.act-icon').textContent=liked?'ü§ç':'‚ù§Ô∏è';}
  if (dcnt) dcnt.textContent = Math.max(0, parseInt(dcnt.textContent)+(liked?-1:1));
};

window.toggleRepost = async function(postId) {
  const postRef = doc(db,'feedPosts',postId);
  const snap = await getDoc(postRef);
  if (!snap.exists()) return;
  const reposts = snap.data().reposts||[];
  const did = reposts.includes(currentUser.uid);
  await updateDoc(postRef,{reposts: did?arrayRemove(currentUser.uid):arrayUnion(currentUser.uid)});
  const cnt = document.getElementById('rp-'+postId);
  if (cnt) cnt.textContent = Math.max(0, parseInt(cnt.textContent)+(did?-1:1));
  showToast(did?'Repost removed':'Reposted! üîÅ');
};

window.deletePost = async function(postId) {
  if (!confirm('Delete this post?')) return;
  try { await deleteDoc(doc(db,'feedPosts',postId)); showToast('Deleted','success'); if(currentView==='post') history.back(); }
  catch(e){showToast('Failed: '+e.message,'error');}
};

// ‚îÄ‚îÄ FOLLOW ‚îÄ‚îÄ
window.toggleFollow = async function(uid) {
  if (uid === currentUser.uid) return;
  const amFollowing = (myFeedProfile.following||[]).includes(uid);
  // Update my following list
  const myFeedRef = doc(db,'feedProfiles',currentUser.uid);
  const theirFeedRef = doc(db,'feedProfiles',uid);
  if (amFollowing) {
    await Promise.all([
      setDoc(myFeedRef,{following:arrayRemove(uid)},{merge:true}),
      setDoc(theirFeedRef,{followers:arrayRemove(currentUser.uid)},{merge:true})
    ]);
    myFeedProfile.following = (myFeedProfile.following||[]).filter(x=>x!==uid);
    showToast('Unfollowed');
  } else {
    await Promise.all([
      setDoc(myFeedRef,{following:arrayUnion(uid)},{merge:true}),
      setDoc(theirFeedRef,{followers:arrayUnion(currentUser.uid)},{merge:true})
    ]);
    if (!myFeedProfile.following) myFeedProfile.following=[];
    myFeedProfile.following.push(uid);
    showToast('Following!','success');
  }
  const btn = document.getElementById('follow-btn');
  if (btn) {
    btn.classList.toggle('following',!amFollowing);
    btn.textContent = !amFollowing ? 'Following' : 'Follow';
  }
  // Also update cached suggest buttons
  document.querySelectorAll(`.follow-btn[data-uid="${uid}"]`).forEach(b=>{
    b.classList.toggle('following',!amFollowing);
    b.textContent=!amFollowing?'Following':'Follow';
  });
};

// ‚îÄ‚îÄ EDIT FEED PROFILE ‚îÄ‚îÄ
window.openEditFeedProfile = function() {
  document.getElementById('feed-bio-input').value = myFeedProfile.feedBio || '';
  openModal('edit-feed-profile-modal');
};
window.saveFeedProfile = async function() {
  const feedBio = document.getElementById('feed-bio-input').value.trim().slice(0,200);
  await setDoc(doc(db,'feedProfiles',currentUser.uid),{feedBio},{merge:true});
  myFeedProfile.feedBio = feedBio;
  profileCache[currentUser.uid] = {...(profileCache[currentUser.uid]||{}), feedBio};
  closeModal('edit-feed-profile-modal');
  showToast('Feed profile updated! ‚ú®','success');
  showView('profile',currentUser.uid);
};

// ‚îÄ‚îÄ RIGHT SIDEBAR ‚îÄ‚îÄ
async function loadRightSidebar() {
  const rc = document.getElementById('right-content');
  rc.innerHTML = '<div class="widget-card"><div class="widget-title">Who to Follow</div><div id="suggestions-list"><div class="skeleton" style="height:48px;margin-bottom:8px"></div><div class="skeleton" style="height:48px"></div></div></div>';
  // Suggest users not already following
  const snap = await getDocs(query(collection(db,'users'), limit(10)));
  const users = snap.docs.map(d=>({id:d.id,...d.data()})).filter(u=>u.id!==currentUser.uid&&!u.deleted&&!(myFeedProfile.following||[]).includes(u.id)).slice(0,5);
  const sl = document.getElementById('suggestions-list');
  if (!sl) return;
  if (!users.length) { sl.innerHTML='<div style="font-size:0.82rem;color:var(--muted)">No suggestions right now.</div>'; return; }
  sl.innerHTML = users.map(u=>{
    const name=u.displayName||u.username||'?';
    return `<div class="suggest-item">
      <div class="suggest-av" style="background:${color(u.username)}" onclick="showView('profile','${u.id}')">
        ${u.avatarUrl?`<img src="${u.avatarUrl}"/>`:name[0].toUpperCase()}
      </div>
      <div class="suggest-info" onclick="showView('profile','${u.id}')" style="cursor:pointer">
        <div class="suggest-name">${esc(name)}</div>
        <div class="suggest-handle">@${esc(u.username||'')}</div>
      </div>
      <button class="follow-btn" data-uid="${u.id}" onclick="toggleFollow('${u.id}')">${(myFeedProfile.following||[]).includes(u.id)?'Following':'Follow'}</button>
    </div>`;
  }).join('');
}

// ‚îÄ‚îÄ SEARCH (right sidebar debounced) ‚îÄ‚îÄ
let searchDebounceTimer;
window.debounceSearch = function(val) {
  clearTimeout(searchDebounceTimer);
  searchDebounceTimer = setTimeout(()=>runSidebarSearch(val),400);
};
async function runSidebarSearch(val) {
  if (!val.trim()) { loadRightSidebar(); return; }
  const v = val.toLowerCase().replace('@','');
  const snap = await getDocs(query(collection(db,'users'), where('username','>=',v), where('username','<=',v+'\uf8ff'), limit(6)));
  const users = snap.docs.map(d=>({id:d.id,...d.data()}));
  const rc = document.getElementById('right-content');
  rc.innerHTML = `<div class="widget-card"><div class="widget-title">Results</div>` + (users.length ? users.map(u=>{
    const name=u.displayName||u.username||'?';
    return `<div class="search-result-item" onclick="showView('profile','${u.id}')" style="padding:8px 0">
      <div class="sr-av" style="background:${color(u.username)};width:36px;height:36px;font-size:0.85rem">${u.avatarUrl?`<img src="${u.avatarUrl}"/>`:name[0].toUpperCase()}</div>
      <div><div style="font-weight:700;font-size:0.88rem">${esc(name)}</div><div style="font-size:0.76rem;color:var(--muted)">@${esc(u.username||'')}</div></div>
    </div>`;
  }).join('') : `<div style="font-size:0.82rem;color:var(--muted)">No users found.</div>`) + `</div>`;
}

</script>
</body>
</html>
